{% extends "base.html" %}

{% block title %}Dollar-Cost Averaging (DCA) Calculator{% endblock %}

{% block meta_description %}Calculate the outcome of a Dollar-Cost Averaging strategy by simulating fixed investments over a period of price fluctuation.{% endblock %}

{% block meta_keywords %}DCA calculator, dollar-cost averaging, investment strategy, average cost per share, portfolio value, fixed investment{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Custom styles for professional appearance */
    .calc-wrapper {
        background: var(--bs-light); 
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.2); /* Soft shadow with theme color */
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: var(--bs-primary); /* Bootstrap Blue/Primary */
    }

    .result-card {
        border-radius: 10px;
        text-align: center;
    }

    /* Main result style for key financial numbers */
    .main-result { 
        font-weight: bold; 
        font-size: 2.8rem; 
        margin-bottom: 0.5rem;
    }
    
    .secondary-result {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .input-group-text.primary-icon {
        background-color: var(--bs-primary);
        color: var(--bs-white); 
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-5 text-primary"><i class="bi bi-piggy-bank-fill me-2"></i> Dollar-Cost Averaging (DCA) Calculator</h1>
        <p class="lead text-muted">Simulate the results of investing a **fixed dollar amount** at regular intervals, regardless of the asset's price, to reduce average cost over time.</p>
    </div>
    
    

[Image of Dollar-Cost Averaging chart]


    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg calc-wrapper border-0">
                <div class="card-body">
                    <form id="dca-form">
                        
                        <h5 class="section-title border-bottom pb-2">1. Investment Plan</h5>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="investment_amount" class="form-label fw-bold">Fixed Investment Amount per Period ($)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text primary-icon"><i class="bi bi-currency-dollar"></i></span>
                                    <input type="number" class="form-control" id="investment_amount" placeholder="e.g., 500" min="0.01" step="0.01" required>
                                </div>
                                <p class="small text-muted mt-1">The fixed capital invested each period (e.g., monthly).</p>
                            </div>
                            <div class="col-md-6">
                                <label for="num_periods" class="form-label fw-bold">Number of Investment Periods</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text primary-icon"><i class="bi bi-repeat"></i></span>
                                    <input type="number" class="form-control" id="num_periods" placeholder="e.g., 12" min="2" step="1" required>
                                </div>
                                <p class="small text-muted mt-1">Total number of scheduled investments (Min: 2).</p>
                            </div>
                        </div>

                        <h5 class="section-title border-bottom pb-2">2. Asset Price Fluctuation (Linear Simulation)</h5>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="start_price" class="form-label fw-bold">Asset Price at Start of Period 1 ($)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text primary-icon"><i class="bi bi-clock-fill"></i></span>
                                    <input type="number" class="form-control" id="start_price" placeholder="e.g., 50.00" min="0.01" step="0.01" required>
                                    <span class="input-group-text">$</span>
                                </div>
                                <p class="small text-muted mt-1">Price when the very first investment is made.</p>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="end_price" class="form-label fw-bold">Asset Price at End of Final Period ($)</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text primary-icon"><i class="bi bi-bar-chart-fill"></i></span>
                                    <input type="number" class="form-control" id="end_price" placeholder="e.g., 60.00" min="0.01" step="0.01" required>
                                    <span class="input-group-text">$</span>
                                </div>
                                <p class="small text-muted mt-1">Current market price for portfolio valuation.</p>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary btn-lg mt-4 w-100 shadow" type="submit">
                            <i class="bi bi-calculator me-2"></i> Calculate DCA Outcome
                        </button>
                    </form>
                </div>
            </div>
            
            <div id="dca-summary" class="d-none">
                <h4 class="text-primary border-bottom pb-2 mb-4 mt-5"><i class="bi bi-clipboard-data-fill me-2"></i> DCA Investment Results</h4>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card result-card bg-white shadow-sm border-primary">
                            <div class="card-body py-4">
                                <h6 class="card-title text-muted fw-bold">Average Cost per Share</h6>
                                <p id="average_cost" class="main-result text-primary"></p>
                                <p class="small text-muted mb-0">The effective cost of each share purchased.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card result-card bg-white shadow-sm border-success">
                            <div class="card-body py-4">
                                <h6 class="card-title text-muted fw-bold">Final Portfolio Value</h6>
                                <p id="final_value_result" class="main-result text-success"></p>
                                <p class="small text-muted mb-0">Total worth of all shares at the ending price.</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <h6 class="card-title text-muted small">Total Capital Invested</h6>
                                <p id="total_invested" class="secondary-result text-dark mb-0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <h6 class="card-title text-muted small">Total Shares Purchased</h6>
                                <p id="total_shares" class="secondary-result text-dark mb-0"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light border-0">
                            <div class="card-body p-3">
                                <h6 class="card-title text-muted small">Total Profit/Loss</h6>
                                <p id="total_return" class="secondary-result mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert mt-4 d-none" id="error-message"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to display error messages
    function displayError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('d-none', 'alert-success', 'alert-info', 'alert-warning');
        errorDiv.classList.add('alert-danger');
        errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        document.getElementById('dca-summary').classList.add('d-none');
    }

    // Function to clear errors
    function clearError() {
        document.getElementById('error-message').classList.add('d-none');
    }

    // Helper function for formatting currency
    const currencyFormatter = (value) => {
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
        });
        return formatter.format(value);
    };

    // --- Event Handler and Display Logic ---

    document.getElementById('dca-form').addEventListener('submit', function (e) {
        e.preventDefault();
        clearError();

        try {
            // 1. Get and Validate Inputs
            const investmentAmount = parseFloat(document.getElementById('investment_amount').value);
            const numPeriods = parseInt(document.getElementById('num_periods').value);
            const startPrice = parseFloat(document.getElementById('start_price').value);
            const endPrice = parseFloat(document.getElementById('end_price').value);

            if (isNaN(investmentAmount) || isNaN(numPeriods) || isNaN(startPrice) || isNaN(endPrice)) {
                displayError("All fields must be filled with valid numbers.");
                return;
            }

            // Critical checks
            if (investmentAmount <= 0) {
                displayError("Investment Amount per Period must be greater than zero.");
                return;
            }
            if (numPeriods < 2) {
                displayError("The number of periods must be 2 or more to perform dollar-cost averaging.");
                return;
            }
            if (startPrice <= 0 || endPrice <= 0) {
                displayError("Both asset prices must be greater than zero.");
                return;
            }
            
            // 2. Core Calculation: Simulate DCA over N periods
            let totalSharesPurchased = 0;
            const totalInvested = investmentAmount * numPeriods;
            
            // Calculate the price change per period assuming linear movement
            // The price calculation includes the start price and subsequent steps
            const priceDifference = endPrice - startPrice;
            const priceChangePerStep = priceDifference / (numPeriods > 1 ? numPeriods - 1 : 1);
            
            // Loop through each investment period (0 to numPeriods-1)
            for (let i = 0; i < numPeriods; i++) {
                // Price starts at startPrice (i=0) and moves by priceChangePerStep each step
                const priceAtPeriod = startPrice + (priceChangePerStep * i);
                
                // Calculate shares bought with fixed dollar amount
                const sharesBought = investmentAmount / priceAtPeriod;
                totalSharesPurchased += sharesBought;
            }

            // 3. Final Metrics
            const averageCostPerShare = totalInvested / totalSharesPurchased;
            const finalPortfolioValue = totalSharesPurchased * endPrice;
            const totalReturn = finalPortfolioValue - totalInvested;

            // 4. Update Summary Totals
            
            document.getElementById('average_cost').textContent = currencyFormatter(averageCostPerShare);
            document.getElementById('final_value_result').textContent = currencyFormatter(finalPortfolioValue);
            document.getElementById('total_invested').textContent = currencyFormatter(totalInvested);
            document.getElementById('total_shares').textContent = totalSharesPurchased.toFixed(4); // Keep shares as plain number with label
            
            const totalReturnElement = document.getElementById('total_return');
            totalReturnElement.textContent = currencyFormatter(totalReturn);

            // Optional: Color the return based on gain/loss
            totalReturnElement.classList.remove('text-success', 'text-danger', 'text-dark');
            if (totalReturn > 0) {
                totalReturnElement.classList.add('text-success');
            } else if (totalReturn < 0) {
                totalReturnElement.classList.add('text-danger');
            } else {
                totalReturnElement.classList.add('text-dark');
            }
            
            // 5. Show Results
            document.getElementById('dca-summary').classList.remove('d-none');

        } catch (error) {
            console.error("Calculation failed:", error);
            displayError("An unexpected error occurred during calculation. Please ensure all input values are valid.");
        }
    });
</script>

{% endblock %}