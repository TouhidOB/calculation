{% extends "base.html" %}

{% block title %}Annuity Payout Calculator{% endblock %}

{% block meta_description %}Calculate the guaranteed periodic payout amount for an annuity based on the initial lump-sum investment, interest rate, term, and payment frequency.{% endblock %}

{% block meta_keywords %}Annuity payout, annuity payment, periodic payment, present value of annuity, retirement income, finance calculator{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Custom styles for professional appearance */
    .calc-wrapper {
        background: var(--bs-white);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(253, 126, 20, 0.15); /* Soft shadow with theme color (Warning/Orange) */
        border: 1px solid var(--bs-light);
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: var(--bs-warning); /* Bootstrap Warning/Orange */
    }

    .result-card {
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .main-result { 
        color: var(--bs-warning); /* Orange for primary result */
        font-weight: bold; 
        font-size: 3.5rem; 
        margin-bottom: 0.5rem;
    }

    .secondary-result {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--bs-primary); /* Blue for secondary metrics */
    }
    
    /* Custom button color */
    .btn-warning-custom {
        background-color: #fd7e14;
        border-color: #fd7e14;
        color: white;
    }
    .btn-warning-custom:hover {
        background-color: #e06c10;
        border-color: #e06c10;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-5 text-dark"><i class="bi bi-wallet-fill me-2 text-warning"></i> Annuity Payout Calculator</h1>
        <p class="lead text-muted">Determine the **fixed, periodic income stream** you will receive from a lump-sum annuity investment.</p>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="calc-wrapper">

                <div class="mb-4 p-3 border-start border-4 border-warning bg-light">
                    <p class="mb-0 small text-dark fw-bold">
                        The periodic payment ($PMT$) is calculated by rearranging the Present Value of an Annuity formula:
                    </p>
                    
                    $$PMT = PV \div \left[ \frac{1 - (1 + i)^{-n}}{i} \right]$$
                    Where $PV$ is the initial investment, $i$ is the periodic rate ($r/m$), and $n$ is the total number of periods ($m \times t$).
                </div>

                <form id="annuity-payout-form">
                    <h5 class="section-title border-bottom pb-2 mb-4"><i class="bi bi-gear-fill me-1"></i> Investment & Payout Parameters</h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="principal" class="form-label">Initial Annuity Principal (PV)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                <input type="number" class="form-control" id="principal" placeholder="e.g., 200000" min="1" step="0.01" required>
                            </div>
                            <div class="form-text">The lump-sum amount used to purchase the annuity.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="interest_rate" class="form-label">Annual Interest Rate (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="interest_rate" placeholder="e.g., 6.0" min="0" step="0.01" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">The expected annual credited interest rate.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="term_years" class="form-label mt-3">Payout Term Length (Years)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="term_years" placeholder="e.g., 20" min="1" step="1" required>
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                            </div>
                            <div class="form-text">The number of years the payments will be received.</div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="form-label">Payment Frequency ($m$)</label>
                        <div class="mt-1">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payout_frequency" id="freq_annually" value="1" checked>
                                <label class="form-check-label" for="freq_annually">Annually</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payout_frequency" id="freq_semi" value="2">
                                <label class="form-check-label" for="freq_semi">Semi-Annually</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payout_frequency" id="freq_quarterly" value="4">
                                <label class="form-check-label" for="freq_quarterly">Quarterly</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payout_frequency" id="freq_monthly" value="12">
                                <label class="form-check-label" for="freq_monthly">Monthly</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="form-label">Payment Timing (Annuity Type)</label>
                        <div class="mt-1">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_timing" id="timing_end" value="end" checked>
                                <label class="form-check-label" for="timing_end">End of Period (**Ordinary Annuity**)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="payment_timing" id="timing_start" value="start">
                                <label class="form-check-label" for="timing_start">Beginning of Period (**Annuity Due**)</label>
                            </div>
                        </div>
                    </div>


                    <button class="btn btn-warning-custom btn-lg mt-5 w-100 shadow" type="submit">
                        <i class="bi bi-calculator me-2"></i> Calculate Payout Amount
                    </button>
                </form>

                <div id="annuity-summary" class="d-none">
                    <h5 class="section-title mt-5 border-bottom pb-2"><i class="bi bi-bar-chart-fill me-1"></i> Annuity Payout Results</h5>
                    
                    <div class="row g-4 justify-content-center">
                        <div class="col-lg-10">
                            <div class="card result-card border-warning bg-warning-subtle">
                                <div class="card-body">
                                    <h6 class="card-title text-warning fw-bold">Periodic Payout Amount ($PMT$)</h6>
                                    <p id="periodic_payment" class="main-result"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="text-muted mt-4 mb-3"><i class="bi bi-info-circle me-1"></i> Total Income Breakdown</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card bg-light border-0 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted small mb-1">Total Payout Received</h6>
                                    <p id="total_payout" class="secondary-result text-dark mb-0"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light border-0 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted small mb-1">Total Interest Earned</h6>
                                    <p id="total_interest" class="secondary-result text-dark mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert mt-4 d-none" id="error-message"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to display error messages
    function displayError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('d-none', 'alert-success', 'alert-info', 'alert-warning');
        errorDiv.classList.add('alert-danger');
        errorDiv.innerHTML = `<strong><i class="bi bi-exclamation-triangle-fill me-2"></i> Error:</strong> ${message}`;
        document.getElementById('annuity-summary').classList.add('d-none');
    }

    // Function to clear errors
    function clearError() {
        document.getElementById('error-message').classList.add('d-none');
    }

    // Helper function for formatting currency
    const currencyFormatter = (value) => {
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
        });
        return formatter.format(value);
    };

    // --- Core Calculation Logic ---

    /**
     * Calculates the periodic payment (PMT) required for an annuity, given its present value.
     * PMT = PV / [(1 - (1 + i)^-n) / i]
     * @param {number} PV - Present Value (Initial Principal)
     * @param {number} i - Periodic interest rate (r / m)
     * @param {number} n - Total number of periods (m * t)
     * @param {string} timing - 'end' for Ordinary Annuity, 'start' for Annuity Due
     * @returns {number} The calculated periodic payment amount.
     */
    function calculatePayment(PV, i, n, timing) {
        if (n <= 0) return 0;
        
        let paymentAmount;

        // Handle zero interest rate case (Simple division)
        if (i === 0) {
            paymentAmount = PV / n;
        } else {
            // Annuity Present Value Factor (PVAF) = [1 - (1 + i)^-n] / i
            const pvaf = (1 - Math.pow(1 + i, -n)) / i;
            
            // Payment = PV / PVAF (Ordinary Annuity)
            paymentAmount = PV / pvaf;
        }

        // Adjust for Annuity Due (Payment at start of period)
        if (timing === 'start') {
            // Annuity Due Payment = Ordinary Annuity Payment / (1 + i)
            // This is equivalent to PVAF_Due = PVAF_Ordinary * (1 + i) 
            // and PMT = PV / PVAF_Due
            paymentAmount = paymentAmount / (1 + i);
        }

        // Ensure we return a positive number
        return Math.abs(paymentAmount); 
    }

    // --- Event Handler and Display Logic ---

    document.getElementById('annuity-payout-form').addEventListener('submit', function (e) {
        e.preventDefault();
        clearError();

        try {
            // 1. Get and Validate Inputs
            const principal = parseFloat(document.getElementById('principal').value); // PV
            const ratePercent = parseFloat(document.getElementById('interest_rate').value); // r (percent)
            const termYears = parseFloat(document.getElementById('term_years').value); // t
            
            const frequencyElement = document.querySelector('input[name="payout_frequency"]:checked');
            const payoutFrequency = parseInt(frequencyElement ? frequencyElement.value : '1'); // m

            const timingElement = document.querySelector('input[name="payment_timing"]:checked');
            const paymentTiming = timingElement ? timingElement.value : 'end'; // 'end' or 'start'


            if (isNaN(principal) || isNaN(ratePercent) || isNaN(termYears)) {
                displayError("All input fields must be filled with valid numbers.");
                return;
            }

            if (principal <= 0) {
                displayError("The Initial Principal must be greater than zero.");
                return;
            }
            
            if (termYears <= 0) {
                displayError("The Payout Term Length must be 1 year or more.");
                return;
            }

            // 2. Prepare Variables
            const rateDecimal = ratePercent / 100; // r
            const m = payoutFrequency;
            const t = termYears;
            
            const periodicRate = rateDecimal / m; // i
            const totalPeriods = m * t; // n
            
            // 3. Core Calculations
            const periodicPayment = calculatePayment(principal, periodicRate, totalPeriods, paymentTiming);
            
            // Total Payout = Periodic Payment * Total Periods
            const totalPayout = periodicPayment * totalPeriods;
            
            // Total Interest = Total Payout - Principal
            const totalInterest = totalPayout - principal;


            // 4. Update Summary Totals
            
            document.getElementById('periodic_payment').textContent = currencyFormatter(periodicPayment);
            document.getElementById('total_payout').textContent = currencyFormatter(totalPayout);
            document.getElementById('total_interest').textContent = currencyFormatter(totalInterest);

            // 5. Show Results
            document.getElementById('annuity-summary').classList.remove('d-none');

        } catch (error) {
            console.error("Calculation failed:", error);
            displayError("An unexpected error occurred during calculation. Please ensure all input values are valid.");
        }
    });
</script>

{% endblock %}