{% extends "base.html" %}

{% block title %}401(k) Retirement Calculator{% endblock %}

{% block meta_description %}Project your total 401(k) balance at retirement by calculating the future value of your current balance, plus all future employee contributions and employer matches.{% endblock %}

{% block meta_keywords %}401k calculator, retirement savings, employer match, future value, compounding, financial planning, investment projection{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Custom styles for professional appearance */
    .calc-wrapper {
        background: var(--bs-white);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.15); /* Soft shadow with theme color (Primary/Blue) */
        border: 1px solid var(--bs-light);
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: var(--bs-primary); /* Bootstrap Primary/Blue */
    }

    .result-card {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .main-result { 
        color: var(--bs-primary); /* Blue for the final number */
        font-weight: bold; 
        font-size: 3.5rem; 
        margin-bottom: 0.5rem;
    }

    .secondary-result {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--bs-success); /* Green for growth components */
    }

    /* Input group color for consistency */
    .input-group-text {
        background-color: var(--bs-light);
        color: var(--bs-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-5 text-dark"><i class="bi bi-piggy-bank-fill me-2 text-primary"></i> 401(k) Retirement Projection</h1>
        <p class="lead text-muted">Project the **future value** of your retirement savings using your current balance, expected growth, and future annual contributions (including employer match).</p>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="calc-wrapper">

                <div class="mb-4 p-3 border-start border-4 border-primary bg-light">
                    <p class="mb-0 small text-dark fw-bold">
                        The total future balance is the sum of two components:
                    </p>
                    <ol class="small mb-0">
                        <li>**Future Value (FV) of Current Balance:** Calculated using $FV = P (1 + r)^t$</li>
                        <li>**Future Value of Annuity (FVA) of Contributions:** Calculated using $FVA = PMT \times \left[ \frac{(1 + r)^t - 1}{r} \right]$</li>
                    </ol>
                    


[Image of compound interest formula]


                </div>

                <form id="k401-form">
                    <h5 class="section-title border-bottom p-2 mb-4 bg-primary text-white"><i class="bi bi-coin me-1"></i> Current Situation & Growth Assumptions</h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="current_balance" class="form-label">Current 401(k) Balance</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                <input type="number" class="form-control" id="current_balance" placeholder="e.g., 50000" min="0" step="1" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="annual_return" class="form-label">Expected Annual Return (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="annual_return" placeholder="e.g., 8.0" min="0.1" step="0.1" required>
                                <span class="input-group-text"><i class="bi bi-percent"></i></span>
                            </div>
                            <div class="form-text">Typical long-term assumption is 6% to 10%.</div>
                        </div>

                        <div class="col-md-6">
                            <label for="years_to_retirement" class="form-label mt-3">Years Until Retirement</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="years_to_retirement" placeholder="e.g., 30" min="1" step="1" required>
                                <span class="input-group-text"><i class="bi bi-clock-fill"></i></span>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="section-title mt-5 border-bottom pb-2 mb-4"><i class="bi bi-person-up me-1"></i> Contribution Details (Annual)</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="annual_salary" class="form-label">Current Annual Salary</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="annual_salary" placeholder="e.g., 85000" min="1000" step="1" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="employee_rate" class="form-label">Your Annual Contribution Rate (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="employee_rate" placeholder="e.g., 10" min="0" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="text-muted mt-4 mb-3"><i class="bi bi-briefcase-fill me-1"></i> Employer Match Policy</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="match_pct" class="form-label">Match Percentage (e.g., 50%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="match_pct" placeholder="e.g., 50" min="0" step="1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="match_limit_pct" class="form-label">Match Limit (as % of Salary)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="match_limit_pct" placeholder="e.g., 6" min="0" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-text mt-2">Example: "We match 50% (Match Pct) of your contribution up to 6% (Match Limit Pct) of your salary."</div>


                    <button class="btn btn-primary btn-lg mt-5 w-100 shadow" type="submit">
                        <i class="bi bi-graph-up-arrow me-2"></i> Project Retirement Balance
                    </button>
                </form>

                <div id="k401-summary" class="d-none">
                    <h5 class="section-title mt-5 border-bottom pb-2"><i class="bi bi-check-circle-fill me-1"></i> Projected Retirement Balance</h5>
                    <div class="row g-4 justify-content-center">
                        <div class="col-lg-10">
                            <div class="card result-card border-primary bg-primary-subtle">
                                <div class="card-body">
                                    <h6 class="card-title text-primary fw-bold">Projected Total at Retirement</h6>
                                    <p id="total_balance" class="main-result"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="text-muted mt-4 mb-3"><i class="bi bi-info-circle me-1"></i> Breakdown of Funds</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted small mb-1">Total Contributions (Cash In)</h6>
                                    <p id="total_contributions" class="secondary-result text-dark mb-0"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted small mb-1">Investment Earnings</h6>
                                    <p id="total_earnings" class="secondary-result mb-0"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted small mb-1">Annual Deposit (Employee + Match)</h6>
                                    <p id="annual_deposit_display" class="secondary-result text-primary mb-0"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert mt-4 d-none" id="error-message"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to display error messages
    function displayError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('d-none', 'alert-success', 'alert-info', 'alert-warning');
        errorDiv.classList.add('alert-danger');
        errorDiv.innerHTML = `<strong><i class="bi bi-exclamation-triangle-fill me-2"></i> Error:</strong> ${message}`;
        document.getElementById('k401-summary').classList.add('d-none');
    }

    // Function to clear errors
    function clearError() {
        document.getElementById('error-message').classList.add('d-none');
    }

    // Helper function for formatting currency
    const currencyFormatter = (value) => {
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 2,
        });
        return formatter.format(Math.max(0, value)); // Ensure non-negative display
    };

    // --- Core Calculation Logic ---

    /**
     * Calculates the Future Value of a lump sum (Current Balance).
     * FV = P * (1 + r)^t
     */
    function calculateFutureValueOfPV(P, r, t) {
        return P * Math.pow(1 + r, t);
    }

    /**
     * Calculates the Future Value of annual contributions (Ordinary Annuity, end of year).
     * FV = PMT * [((1 + r)^t - 1) / r]
     */
    function calculateFutureValueOfAnnuity(PMT, r, t) {
        if (r === 0) {
            return PMT * t; // Simple growth if rate is zero
        }
        // Future Value Annuity Factor (FVAF) = [(1 + r)^t - 1] / r
        const fvaf = (Math.pow(1 + r, t) - 1) / r;
        return PMT * fvaf;
    }


    // --- Calculation and Display Handler ---

    function runCalculationAndDisplay() {
        clearError();

        try {
            // 1. Get Inputs (using values currently in the form fields)
            const P = parseFloat(document.getElementById('current_balance').value || 0);
            const R_percent = parseFloat(document.getElementById('annual_return').value);
            const T = parseInt(document.getElementById('years_to_retirement').value);
            const Salary = parseFloat(document.getElementById('annual_salary').value);
            const E_Rate_pct = parseFloat(document.getElementById('employee_rate').value);
            const M_Pct = parseFloat(document.getElementById('match_pct').value);
            const L_Pct = parseFloat(document.getElementById('match_limit_pct').value);


            if (isNaN(R_percent) || isNaN(T) || isNaN(Salary) || isNaN(E_Rate_pct) || isNaN(M_Pct) || isNaN(L_Pct)) {
                displayError("All input fields must be filled with valid numbers.");
                return;
            }

            if (P < 0 || Salary <= 0 || T <= 0) {
                displayError("Current Balance must be non-negative, and Salary and Years must be positive.");
                return;
            }

            // 2. Prepare Variables (Convert rates to decimals)
            const R = R_percent / 100;
            const E_Rate = E_Rate_pct / 100;
            const M_Factor = M_Pct / 100; // Match percentage as a factor
            const L_Rate = L_Pct / 100;

            // 3. Calculate Annual Contribution (PMT)
            
            // Employee's actual dollar contribution per year
            const employeeContribution = Salary * E_Rate;
            
            // Maximum contribution that the employee makes that is eligible for match
            const maxMatchableContrib = Salary * L_Rate;
            
            // The actual portion of the employee's contribution that is matched
            const actualMatchedContrib = Math.min(employeeContribution, maxMatchableContrib);
            
            // The employer's dollar match amount
            const employerMatchAmount = actualMatchedContrib * M_Factor;
            
            // The total annual deposit (PMT)
            const PMT = employeeContribution + employerMatchAmount;
            
            // Total Contributions over the period (for breakdown)
            // Note: P (Current Balance) is an existing contribution, not a future cash-in.
            const totalEmployeeContribs = employeeContribution * T;
            const totalEmployerContribs = employerMatchAmount * T;
            const totalCashIn = P + totalEmployeeContribs + totalEmployerContribs;


            // 4. Core Future Value Calculations

            // FV of Current Balance
            const fv_pv = calculateFutureValueOfPV(P, R, T);
            
            // FV of Future Contributions (Employee + Match)
            const fv_pmt = calculateFutureValueOfAnnuity(PMT, R, T);
            
            // Total Projected Balance
            const totalFutureValue = fv_pv + fv_pmt;
            
            // Total Earnings = Total FV - Total Cash In
            const totalEarnings = totalFutureValue - totalCashIn;

            // 5. Update Summary Totals
            
            document.getElementById('total_balance').textContent = currencyFormatter(totalFutureValue);
            document.getElementById('total_contributions').textContent = currencyFormatter(totalCashIn);
            document.getElementById('total_earnings').textContent = currencyFormatter(totalEarnings);
            document.getElementById('annual_deposit_display').textContent = currencyFormatter(PMT);

            // 6. Show Results
            document.getElementById('k401-summary').classList.remove('d-none');

        } catch (error) {
            console.error("Calculation failed:", error);
            displayError("An unexpected error occurred during calculation. Please ensure all input values are valid.");
        }
    }


    // --- Event Listeners ---

    // 1. Attach the calculation function to the form submit button
    document.getElementById('k401-form').addEventListener('submit', function (e) {
        e.preventDefault();
        runCalculationAndDisplay();
    });

</script>

{% endblock %}