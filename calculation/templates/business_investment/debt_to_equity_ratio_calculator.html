{% extends "base.html" %}

{% block title %}Debt-to-Equity Ratio Calculator{% endblock %}

{% block meta_description %}Calculate the Debt-to-Equity Ratio to assess a company's financial leverage and solvency, indicating how much debt is used to finance assets.{% endblock %}

{% block meta_keywords %}debt to equity ratio, d/e ratio, financial leverage, solvency, balance sheet, financial metric, calculator{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Custom styles using Bootstrap color variables for result text */
    .calc-wrapper {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
    }
    
    .result-card {
        text-align: center;
        transition: transform 0.2s;
    }

    .result-card:hover {
        transform: translateY(-3px);
    }

    .result-value { 
        font-weight: bold; 
        font-size: 2.5rem; 
        margin-bottom: 0.5rem;
    }
    
    /* Conditional Result Colors based on Bootstrap classes */
    .text-low-risk { color: var(--bs-success) !important; }
    .text-moderate-risk { color: var(--bs-warning) !important; }
    .text-high-risk { color: var(--bs-danger) !important; }
    
    .border-low-risk { border-color: var(--bs-success) !important; }
    .border-moderate-risk { border-color: var(--bs-warning) !important; }
    .border-high-risk { border-color: var(--bs-danger) !important; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-5 text-dark">⚖️ Debt-to-Equity Ratio Calculator</h1>
        <p class="lead text-muted">This metric assesses a company's **financial leverage** by comparing its total liabilities to its total shareholder equity. It reveals how assets are financed.</p>
        
        <div class="alert alert-warning-subtle border-warning py-2 my-4">
            <p class="mb-1 fw-bold text-warning">Debt-to-Equity Ratio Formula:</p>
            <p class="mb-0 small text-dark">
                $$\text{D/E Ratio} = \frac{\text{Total Liabilities}}{\text{Total Shareholder Equity}}$$
            </p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-7">
            <div class="card shadow-lg calc-wrapper border-0">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="bi bi-bank me-2"></i> Balance Sheet Inputs (in $)</h4>
                </div>
                <div class="card-body">
                    <form id="der-form">
                        
                        <div class="mb-4">
                            <label for="total_liabilities" class="form-label fw-bold">Total Liabilities (Numerator)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-danger text-white"><i class="bi bi-arrow-down-up"></i></span>
                                <input type="number" class="form-control" id="total_liabilities" placeholder="e.g., 500000.00" min="0" step="0.01" required>
                                <span class="input-group-text">$</span>
                            </div>
                            <p class="small text-muted mt-1">Sum of all short-term and long-term debts and obligations owed by the company.</p>
                        </div>

                        <div class="mb-4">
                            <label for="total_equity" class="form-label fw-bold">Total Shareholder Equity (Denominator)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-success text-white"><i class="bi bi-person-circle"></i></span>
                                <input type="number" class="form-control" id="total_equity" placeholder="e.g., 1000000.00" step="0.01" required>
                                <span class="input-group-text">$</span>
                            </div>
                            <p class="small text-muted mt-1">The value of the assets financed by the owners. **Can be negative**.</p>
                        </div>

                        <button class="btn btn-warning btn-lg mt-4 w-100 shadow" type="submit">
                            <i class="bi bi-bar-chart-line-fill me-2"></i> Calculate D/E Ratio
                        </button>
                    </form>
                </div>
            </div>

            <div id="ratio-summary" class="d-none">
                <h4 class="text-warning border-bottom pb-2 mb-3 mt-5"><i class="bi bi-clipboard-data-fill me-2"></i> Calculation Results</h4>
                <div class="row g-3">
                    <div class="col-12">
                        <div id="der-result-card" class="card result-card bg-light h-100 shadow-sm border-warning">
                            <div class="card-body">
                                <h6 class="card-title text-muted fw-normal">Debt-to-Equity Ratio (D/E)</h6>
                                <p id="de_ratio" class="result-value text-warning">0.00 : 1</p>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="mt-3 small text-muted text-center" id="ratio_interpretation">A D/E ratio tells you how a company finances its assets. A higher ratio means more reliance on external debt financing.</p>
            </div>

            <div class="alert mt-4 d-none" id="error-message"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to update the result card's color based on the ratio value
    function updateResultDisplay(ratio) {
        const card = document.getElementById('der-result-card');
        const text = document.getElementById('de_ratio');

        // Reset classes
        card.classList.remove('border-low-risk', 'border-moderate-risk', 'border-high-risk');
        text.classList.remove('text-low-risk', 'text-moderate-risk', 'text-high-risk');
        
        // Handle special values (Infinite or Negative)
        if (ratio === Infinity || ratio < 0) {
            card.classList.add('border-high-risk');
            text.classList.add('text-high-risk');
            return;
        }

        // Apply new classes based on ratio
        if (ratio <= 0.5) {
            card.classList.add('border-low-risk');
            text.classList.add('text-low-risk');
        } else if (ratio <= 1.5) {
            card.classList.add('border-moderate-risk');
            text.classList.add('text-moderate-risk');
        } else {
            card.classList.add('border-high-risk');
            text.classList.add('text-high-risk');
        }
    }

    // Function to display error messages (including warnings/infinite ratio)
    function displayError(message, isWarning = false) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.classList.remove('d-none', 'alert-danger', 'alert-warning');
        
        if (isWarning) {
            errorDiv.classList.add('alert-warning');
            errorDiv.innerHTML = `<strong>Extreme Risk:</strong> ${message}`;
        } else {
            errorDiv.classList.add('alert-danger');
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        }
        document.getElementById('ratio-summary').classList.add('d-none');
    }

    // Function to clear errors
    function clearError() {
        document.getElementById('error-message').classList.add('d-none');
    }
    
    // Function to interpret the ratio result
    function interpretRatio(ratio) {
        if (ratio === Infinity) {
            return "Equity is zero, and there is debt. Debt holders have full claim to the assets. This indicates **extreme financial risk and possible insolvency**.";
        } else if (ratio < 0) {
            return "Negative D/E Ratio (due to Negative Equity): Liabilities exceed assets. The company is **technically insolvent** (very high risk).";
        } else if (ratio <= 0.5) {
            return "Low Leverage (Financed mostly by Equity): The company is primarily financed by equity. This is typically considered **financially stable and low risk**.";
        } else if (ratio <= 1.5) {
            return "Moderate Leverage (Balanced): A balanced mix of debt and equity financing. Common for growing companies.";
        } else {
            return "High Leverage (Debt-heavy): The company relies heavily on debt. This implies **higher risk** but also potential for higher returns if debt is used effectively. May be industry-specific.";
        }
    }

    // --- Event Handler and Display Logic ---

    document.getElementById('der-form').addEventListener('submit', function (e) {
        e.preventDefault();
        clearError();

        try {
            // 1. Get and Validate Inputs
            const liabilities_val = document.getElementById('total_liabilities').value;
            const equity_val = document.getElementById('total_equity').value;

            // Check for empty fields
            if (!liabilities_val || !equity_val) {
                displayError("Both Total Liabilities and Total Equity fields must be filled.");
                return;
            }

            // Parse inputs
            const total_liabilities = parseFloat(liabilities_val);
            const total_equity = parseFloat(equity_val);
            
            // Check for NaN after parsing
            if (isNaN(total_liabilities) || isNaN(total_equity)) {
                displayError("Please ensure both inputs are valid numbers.");
                return;
            }

            // Liabilities cannot be negative
            if (total_liabilities < 0) {
                displayError("Total Liabilities must be a non-negative value.");
                return;
            }
            
            let ratio = 0;

            // Handle edge case: Division by zero (zero equity)
            if (total_equity === 0) {
                if (total_liabilities > 0) {
                    ratio = Infinity;
                } else {
                    // 0/0. If both are zero, the ratio is 0.
                    ratio = 0;
                }
            } else {
                // 2. Core Calculation
                ratio = total_liabilities / total_equity;
            }

            // 3. Get interpretation and update display text
            const interpretation = interpretRatio(ratio);
            
            let ratioText = '';
            if (ratio === Infinity) {
                ratioText = 'Infinite (∞)';
                // Display the interpretation as a special warning/risk alert
                displayError(interpretation, true); 
            } else {
                ratioText = ratio.toFixed(2) + ' : 1';
                // Clear any previous warning once a non-infinite calculation is successful
                clearError();
            }

            // 4. Update Summary Totals and Conditional Display
            document.getElementById('de_ratio').textContent = ratioText;
            document.getElementById('ratio_interpretation').textContent = interpretation;
            updateResultDisplay(ratio);

            // 5. Show Results
            document.getElementById('ratio-summary').classList.remove('d-none');

        } catch (error) {
            console.error("Calculation failed:", error);
            displayError("An unexpected error occurred during calculation. Please ensure all input values are valid.");
        }
    });
</script>

{% endblock %}