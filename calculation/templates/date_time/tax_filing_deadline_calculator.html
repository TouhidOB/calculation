{% extends "base.html" %}

{% block title %}Tax Filing Deadline Calculator (US){% endblock %}

{% block meta_description %}Calculate the official US Federal Income Tax (Form 1040) filing deadline for any given year, accounting for weekends and DC holidays.{% endblock %}

{% block meta_keywords %}tax deadline, filing calculator, IRS deadline, april 15, tax day, extension date{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 15px;
        color: #007bff; /* Bootstrap Blue accent for official/governmental theme */
    }

    /* Result Section Styles */
    .result-section {
        background-color: #e6f7ff; /* Light blue background */
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        margin-top: 30px;
        border: 1px solid #007bff;
    }

    .result-section h3 {
        color: #007bff;
        margin-bottom: 15px;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .date-display {
        font-size: 3rem;
        font-weight: 700;
        color: #dc3545; /* Red accent for urgency/deadline */
        line-height: 1.2;
    }

    .info-box {
        background-color: #f0f8ff;
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        border-left: 5px solid #007bff;
        text-align: left;
    }

    .info-box p {
        margin: 5px 0;
        font-size: 1.1rem;
    }

    .d-none { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-3">üèõÔ∏è Tax Filing Deadline Calculator (US Federal)</h1>
    <p class="small-muted">Find the official IRS deadline (Form 1040) for any year, accounting for weekends and Washington D.C. holidays.</p>

    <div class="calc-wrapper">

        <form id="tax-deadline-form">
            <h5 class="section-title">Step 1: Select Year</h5>

            <!-- Target Year Input -->
            <div class="form-group mb-4">
                <label for="target-year" class="form-label">Tax Year (Filing in the following year)</label>
                <input type="number" class="form-control" id="target-year" min="1955" value="2025" required>
                <small class="form-text text-muted">Example: Selecting 2025 calculates the deadline for taxes filed in 2026.</small>
            </div>

            <button class="btn btn-primary mt-3 w-100" type="submit">Calculate Filing Deadline</button>
        </form>

        <div id="results-container" class="d-none">
            <div class="result-section">
                <h3 id="result-year-display"></h3>

                <small class="text-muted">Official Filing Deadline (Local Time)</small>
                <div class="date-display" id="calculated-deadline"></div>

                <div class="info-box">
                    <p>Standard Date: <strong>April 15th</strong></p>
                    <p>Total Shift Days: <strong id="shift-days">0</strong></p>
                    <p>Reason: <strong id="shift-reason">None</strong></p>
                </div>

                <p class="text-muted mt-3" id="calculation-summary"></p>
            </div>
        </div>

        <div id="status-message" class="alert d-none mt-3" role="alert"></div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function displayStatus(message, isError) {
        const statusDiv = document.getElementById('status-message');
        statusDiv.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
        statusDiv.classList.add(isError ? 'alert-danger' : 'alert-info');
        statusDiv.innerHTML = isError ? `‚ùå **Error:** ${message}` : `‚ÑπÔ∏è ${message}`;
    }

    // Helper function to format a Date object into a readable string
    function formatReadableDate(date) {
        return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function calculateEaster(Y) {
        // Meeus/Butcher's Algorithm for Gregorian Calendar
        const a = Y % 19;
        const b = Y % 4;
        const c = Y % 7;
        const k = Math.floor(Y / 100);
        const p = Math.floor((13 + 8 * k) / 25);
        const q = Math.floor(k / 4);

        const M = (15 - p + k - q) % 30;
        const N = (4 + k - q) % 7;

        const d = (19 * a + M) % 30;
        const e = (2 * b + 4 * c + 6 * d + N) % 7;

        const dayOfMonth = 22 + d + e;

        let month;
        let day;

        if (dayOfMonth > 31) {
            month = 3; // April (0-indexed month)
            day = dayOfMonth - 31;
        } else {
            month = 2; // March (0-indexed month)
            day = dayOfMonth;
        }
        return new Date(Y, month, day);
    }


    function isDCFederalHoliday(date) {
        const year = date.getFullYear();
        const month = date.getMonth(); // 0-11
        const day = date.getDate(); // 1-31
        const dayOfWeek = date.getDay(); // 0=Sun, 1=Mon...

        // Standard Fixed Holidays (Observed on Monday if they fall on Sat/Sun)
        const fixedHolidays = [
            // Jan 1: New Year's Day
            { month: 0, day: 1, name: "New Year's Day" },
            // Jul 4: Independence Day
            { month: 6, day: 4, name: "Independence Day" },
            // Nov 11: Veterans Day
            { month: 10, day: 11, name: "Veterans Day" },
            // Dec 25: Christmas Day
            { month: 11, day: 25, name: "Christmas Day" }
        ];
        
        // --- 1. Check Fixed Date Holidays (Observed on Monday/Friday if weekend) ---
        for (const holiday of fixedHolidays) {
            let actualMonth = holiday.month;
            let actualDay = holiday.day;

            if (actualMonth === month) {
                if (actualDay === day) return holiday.name; // Falls on the actual date
                // Check if the observed day is today (if actual date was a Sat/Sun)
                const actualDate = new Date(year, actualMonth, actualDay);
                const actualDOW = actualDate.getDay();

                if (actualDOW === 0 && day === actualDay + 1) return holiday.name + " (Observed)"; // Sunday -> Observed Monday
                if (actualDOW === 6 && day === actualDay - 1) return holiday.name + " (Observed)"; // Saturday -> Observed Friday
            }
        }
        
        // --- 2. Check Floating Holidays (Specific rules) ---

        // Jan (3rd Monday): Martin Luther King Jr.'s Birthday
        const MLK = new Date(year, 0, 1);
        let count = 0;
        while (MLK.getMonth() === 0 && count < 3) {
            if (MLK.getDay() === 1) count++; // Monday
            if (count === 3 && MLK.getDate() === day) return "Martin Luther King Jr.'s Birthday";
            MLK.setDate(MLK.getDate() + 1);
        }

        // Feb (3rd Monday): Washington's Birthday (Presidents' Day)
        const PresDay = new Date(year, 1, 1);
        count = 0;
        while (PresDay.getMonth() === 1 && count < 3) {
            if (PresDay.getDay() === 1) count++; // Monday
            if (count === 3 && PresDay.getDate() === day) return "Washington's Birthday";
            PresDay.setDate(PresDay.getDate() + 1);
        }

        // May (Last Monday): Memorial Day
        const MemorialDay = new Date(year, 5, 0); // Last day of May
        while (MemorialDay.getDay() !== 1) { // Monday
            MemorialDay.setDate(MemorialDay.getDate() - 1);
        }
        if (month === MemorialDay.getMonth() && day === MemorialDay.getDate()) return "Memorial Day";

        // Sep (1st Monday): Labor Day
        const LaborDay = new Date(year, 8, 1);
        while (LaborDay.getDay() !== 1) { // Monday
            LaborDay.setDate(LaborDay.getDate() + 1);
        }
        if (month === LaborDay.getMonth() && day === LaborDay.getDate()) return "Labor Day";
        
        // Oct (2nd Monday): Columbus Day
        const ColumbusDay = new Date(year, 9, 1);
        count = 0;
        while (ColumbusDay.getMonth() === 9 && count < 2) {
            if (ColumbusDay.getDay() === 1) count++; // Monday
            if (count === 2 && ColumbusDay.getDate() === day) return "Columbus Day";
            ColumbusDay.setDate(ColumbusDay.getDate() + 1);
        }

        // Nov (4th Thursday): Thanksgiving Day
        const Thanksgiving = new Date(year, 10, 1);
        count = 0;
        while (Thanksgiving.getMonth() === 10 && count < 4) {
            if (Thanksgiving.getDay() === 4) count++; // Thursday
            if (count === 4 && Thanksgiving.getDate() === day) return "Thanksgiving Day";
            Thanksgiving.setDate(Thanksgiving.getDate() + 1);
        }

        // --- 3. Check DC Specific Holiday (Critical for April Deadline) ---

        // April 16: Emancipation Day (Observed on Fri/Mon if Sat/Sun)
        const EmancipationDate = new Date(year, 3, 16); // Month 3 is April
        if (month === 3 && day === 16) return "DC Emancipation Day"; // Falls on 16th
        
        const EMAN_DOW = EmancipationDate.getDay();
        if (EMAN_DOW === 0 && month === 3 && day === 17) return "DC Emancipation Day (Observed)"; // Sunday -> Observed Monday (17th)
        if (EMAN_DOW === 6 && month === 3 && day === 15) return "DC Emancipation Day (Observed)"; // Saturday -> Observed Friday (15th)

        // The IRS deadline is also pushed if it falls on Patriot's Day (3rd Monday in April) 
        // in Maine or Massachusetts, but this logic is for the Federal deadline based on DC rules.
        // We will note the Patriot's Day exception in the summary, but not use it for the primary calculation.
        
        return null;
    }

    function calculateTaxDeadline(taxYear) {
        // The filing year is the taxYear + 1
        const filingYear = taxYear + 1;
        
        // Start date is April 15th of the filing year
        const startDate = new Date(filingYear, 3, 15); // Month 3 is April
        let deadline = new Date(startDate);
        let shiftDays = 0;
        let shiftReason = "None (Fell on a business day and was not a holiday).";

        // Loop forward until the date is not a weekend day and not a DC Federal Holiday
        while (true) {
            const dayOfWeek = deadline.getDay(); // 0=Sun, 6=Sat
            const holidayName = isDCFederalHoliday(deadline);

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Weekend
                shiftReason = dayOfWeek === 0 ? "Original date fell on a Sunday." : "Original date fell on a Saturday.";
                deadline.setDate(deadline.getDate() + 1);
                shiftDays++;
                continue;
            }

            if (holidayName) {
                // DC Federal Holiday
                shiftReason = `Original date fell on a Washington D.C. holiday: ${holidayName}.`;
                deadline.setDate(deadline.getDate() + 1);
                shiftDays++;
                continue;
            }
            
            // Special check: Is it DC Emancipation Day (April 16th)?
            // The check above handles the official Emancipation Day, but if the 15th shifts to the 16th, we must re-check.
            if (deadline.getMonth() === 3 && deadline.getDate() === 16) {
                const emancipationHoliday = isDCFederalHoliday(deadline);
                if (emancipationHoliday) {
                    shiftReason = `Date shifted to April 16th, which is DC Emancipation Day: ${emancipationHoliday}.`;
                    deadline.setDate(deadline.getDate() + 1);
                    shiftDays++;
                    continue;
                }
            }
            
            // If we are here, the current date is a valid business day.
            break;
        }

        // Final check for the shift reason if it was a multi-day shift
        if (shiftDays > 0) {
            if (deadline.getFullYear() > filingYear) {
                shiftReason = "Shifted into the next year due to weekend/holidays.";
            } else if (shiftReason === "None (Fell on a business day and was not a holiday).") {
                // Refine reason if multiple checks occurred
                shiftReason = `Shifted ${shiftDays} day(s) due to weekend and/or DC holidays.`;
            }
        }
        
        // Check for the Patriot's Day Exception (MA/ME only)
        // Patriot's Day is the 3rd Monday of April
        const thirdMondayInApril = new Date(filingYear, 3, 1);
        let count = 0;
        while(thirdMondayInApril.getMonth() === 3) {
            if (thirdMondayInApril.getDay() === 1) count++; // Monday
            if (count === 3) break;
            thirdMondayInApril.setDate(thirdMondayInApril.getDate() + 1);
        }
        
        let maMeException = null;
        if (thirdMondayInApril.getMonth() === 3 && thirdMondayInApril.getDate() === deadline.getDate()) {
            maMeException = "The final calculated date falls on Patriot's Day (3rd Monday in April), which typically shifts the deadline an extra day for residents of Maine and Massachusetts.";
        }


        return { date: deadline, reason: shiftReason, shift: shiftDays, maMeException: maMeException };
    }

    // --- Event Handler ---

    document.getElementById('tax-deadline-form').addEventListener('submit', function (e) {
        e.preventDefault();

        document.getElementById('results-container').classList.add('d-none');
        document.getElementById('status-message').classList.add('d-none');

        const yearStr = document.getElementById('target-year').value;
        const taxYear = parseInt(yearStr, 10);

        if (isNaN(taxYear) || taxYear < 1955) {
            displayStatus("Please enter a valid tax year (1955 onwards).", true);
            return;
        }

        // 1. Perform Calculation
        const { date, reason, shift, maMeException } = calculateTaxDeadline(taxYear);

        // 2. Display Results
        const dateReadable = formatReadableDate(date);
        const filingYear = taxYear + 1;

        document.getElementById('result-year-display').innerText = `Filing Deadline for Tax Year ${taxYear} (Filed in ${filingYear})`;
        document.getElementById('calculated-deadline').innerText = dateReadable;

        document.getElementById('shift-days').innerText = shift;
        document.getElementById('shift-reason').innerText = reason;

        let summaryText = `
The official US Federal Tax Filing deadline for Tax Year ${taxYear} is determined based on April 15th of the following year (${filingYear}).
If April 15th is a weekend or a Washington D.C. legal holiday (like Emancipation Day), the deadline is postponed to the next business day.
        `;
        
        if (maMeException) {
             summaryText += `\n\n**Special State Exception:** ${maMeException}`;
        }
        
        document.getElementById('calculation-summary').innerText = summaryText.trim();

        document.getElementById('results-container').classList.remove('d-none');
    });

    // Set default year to the current year
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('target-year').value = new Date().getFullYear();
    });
</script>

{% endblock %}
