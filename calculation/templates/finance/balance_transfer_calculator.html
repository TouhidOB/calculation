{% extends "base.html" %}

{% block title %}Balance Transfer Calculator{% endblock %}
{% block meta_description %}Calculate balance transfer options and save on interest payments.{% endblock %}
{% block meta_keywords %}balance transfer calculator, credit card transfer, interest savings{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    canvas {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-3">Balance Transfer Calculator</h1>

    <div class="calc-wrapper mt-4">
        <!-- Tabs for A/B/C -->
        <ul class="nav nav-tabs" id="btTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#bt-monthly">Monthly</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#bt-annual">Annual</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#bt-daily">Daily</a>
            </li>
        </ul>

        <div class="tab-content mt-3">

            <!-- Monthly -->
            <div class="tab-pane fade show active" id="bt-monthly" role="tabpanel">
                {% include "includes/balance_transfer_form.html" with period="monthly" %}
            </div>

            <!-- Annual -->
            <div class="tab-pane fade" id="bt-annual" role="tabpanel">
                {% include "includes/balance_transfer_form.html" with period="annual" %}
            </div>

            <!-- Daily -->
            <div class="tab-pane fade" id="bt-daily" role="tabpanel">
                {% include "includes/balance_transfer_form.html" with period="daily" %}
            </div>

        </div>




        <div class="alert alert-info mt-4 d-none" id="bt-result"></div>
        <table class="table table-bordered mt-4 d-none" id="bt-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="bt-body"></tbody>
        </table>
        <canvas id="bt-chart" class="d-none"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function calcPayment(balance, ratePerPeriod, periods) {
        // If rate is zero → simple division
        if (ratePerPeriod === 0) {
            return balance / periods;
        }
        // Standard amortization formula
        return balance * (ratePerPeriod * Math.pow(1 + ratePerPeriod, periods)) /
            (Math.pow(1 + ratePerPeriod, periods) - 1);
    }

    document.querySelectorAll('.bt-form').forEach(function (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const period = form.dataset.period;
            const balance = parseFloat(form.querySelector('.balance').value);
            const rate = parseFloat(form.querySelector('.rate').value) / 100;
            const months = parseInt(form.querySelector('.months').value);
            const newRate = parseFloat(form.querySelector('.new-rate').value) / 100;
            const newTerm = parseInt(form.querySelector('.new-term').value);

            // Correct period conversion
            let ratePerPeriod;
            if (period === 'monthly') { ratePerPeriod = rate / 12; }
            else if (period === 'annual') { ratePerPeriod = rate; }
            else { ratePerPeriod = rate / 52; } // weekly calculation

            let newRatePerPeriod;
            if (period === 'monthly') { newRatePerPeriod = newRate / 12; }
            else if (period === 'annual') { newRatePerPeriod = newRate; }
            else { newRatePerPeriod = newRate / 52; }

            const paymentOld = calcPayment(balance, ratePerPeriod, months);
            const paymentNew = calcPayment(balance, newRatePerPeriod, newTerm);

            const totalOld = paymentOld * months;
            const totalNew = paymentNew * newTerm;
            const savings = totalOld - totalNew;

            const res = document.getElementById('bt-result');
            res.classList.remove('d-none');
            res.innerHTML = `<strong>Payment Before:</strong> $${paymentOld.toFixed(2)}<br>
                         <strong>Payment After:</strong> $${paymentNew.toFixed(2)}<br>
                         <strong>Total Savings:</strong> $${savings.toFixed(2)}<br>
                         ${savings > 0 ? '<span style="color:green;font-weight:bold;">✅ Saves money!</span>' : '<span style="color:red;font-weight:bold;">❌ Costs more!</span>'}`;

            document.getElementById('bt-table').classList.remove('d-none');
            document.getElementById('bt-body').innerHTML = `
            <tr><td>Old Total Cost</td><td>$${totalOld.toFixed(2)}</td></tr>
            <tr><td>New Total Cost</td><td>$${totalNew.toFixed(2)}</td></tr>
            <tr><td>Total Savings</td><td>$${savings.toFixed(2)}</td></tr>
        `;

            const ctx = document.getElementById('bt-chart').getContext('2d');
            document.getElementById('bt-chart').classList.remove('d-none');
            if (window.btChart) window.btChart.destroy();
            window.btChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Old Total Cost', 'New Total Cost'],
                    datasets: [{ data: [totalOld, totalNew] }]
                }
            });
        });
    });
</script>
{% endblock %}