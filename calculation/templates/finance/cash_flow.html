{% extends "base.html" %}

{% block title %}Cash Flow Calculator{% endblock %}
{% block meta_description %}Analyze monthly cash flow (incomes vs expenses) and get recommendations to improve your cash flow.{% endblock %}

{% block extra_head %}
<style>
  .calc{background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.04)}
  .col-6-flex { display:flex; flex-direction:column; gap:.5rem; }
  .analysis { white-space:pre-wrap; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Cash Flow Calculator</h1>
  <p class="small-muted">List all recurring incomes and expenses to calculate monthly surplus or deficit with actionable advice.</p>

  <div class="calc mt-3">
    <form id="cash-form">
      <div class="row">
        <div class="col-md-6 col-12 col-6-flex">
          <h5>Incomes</h5>
          <div id="income-list">
            <div class="input-group my-2">
              <input type="text" class="form-control inc-name" placeholder="Income source (e.g., Salary)">
              <input type="number" class="form-control inc-value" placeholder="Monthly amount" min="0" step="0.01">
              <button class="btn btn-outline-danger btn-sm remove-inc" type="button">−</button>
            </div>
          </div>
          <button id="add-inc" type="button" class="btn btn-sm btn-outline-primary">+ Add Income</button>
        </div>

        <div class="col-md-6 col-12 col-6-flex">
          <h5>Expenses</h5>
          <div id="expense-list">
            <div class="input-group my-2">
              <input type="text" class="form-control exp-name" placeholder="Expense (e.g., Rent)">
              <input type="number" class="form-control exp-value" placeholder="Monthly amount" min="0" step="0.01">
              <button class="btn btn-outline-danger btn-sm remove-exp" type="button">−</button>
            </div>
          </div>
          <button id="add-exp" type="button" class="btn btn-sm btn-outline-primary">+ Add Expense</button>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-primary" type="submit">Analyze Cash Flow</button>
        <button id="reset-cash" type="button" class="btn btn-secondary">Reset</button>
      </div>
    </form>

    <div id="cash-result" class="mt-4 d-none">
      <h5>Results</h5>
      <div><strong>Total Monthly Income:</strong> $<span id="cf-income">0.00</span></div>
      <div><strong>Total Monthly Expenses:</strong> $<span id="cf-exp">0.00</span></div>
      <div><strong>Monthly Surplus / (Deficit):</strong> $<span id="cf-net">0.00</span></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="cf-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function rowFactory(nameCls, valCls, removeCls, namePlaceholder, valuePlaceholder) {
    const d = document.createElement('div'); d.className = 'input-group my-2';
    d.innerHTML = `
      <input type="text" class="form-control ${nameCls}" placeholder="${namePlaceholder}">
      <input type="number" class="form-control ${valCls}" placeholder="${valuePlaceholder}" min="0" step="0.01">
      <button class="btn btn-outline-danger btn-sm ${removeCls}" type="button">−</button>
    `;
    return d;
  }

  document.getElementById('add-inc').addEventListener('click', ()=> document.getElementById('income-list').appendChild(rowFactory('inc-name','inc-value','remove-inc','Income source','Monthly amount')));
  document.getElementById('add-exp').addEventListener('click', ()=> document.getElementById('expense-list').appendChild(rowFactory('exp-name','exp-value','remove-exp','Expense name','Monthly amount')));

  document.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('remove-inc')) e.target.parentElement.remove();
    if(e.target && e.target.classList.contains('remove-exp')) e.target.parentElement.remove();
  });

  document.getElementById('cash-form').addEventListener('submit', function(e){
    e.preventDefault();
    const income = Array.from(document.querySelectorAll('.inc-value')).reduce((s,el)=> s + (parseFloat(el.value)||0), 0);
    const exp = Array.from(document.querySelectorAll('.exp-value')).reduce((s,el)=> s + (parseFloat(el.value)||0), 0);
    const net = income - exp;

    document.getElementById('cf-income').textContent = income.toFixed(2);
    document.getElementById('cf-exp').textContent = exp.toFixed(2);
    document.getElementById('cf-net').textContent = net.toFixed(2);
    document.getElementById('cash-result').classList.remove('d-none');

    // Deep analysis
    const percentSavings = income === 0 ? 0 : (net / income) * 100;
    let analysis = `Monthly savings rate: ${percentSavings.toFixed(1)}% of income.\n`;
    if(net > 0) {
      analysis += `Good — you have a monthly surplus of $${net.toFixed(2)}. Consider allocating:\n- 20% to savings/investment\n- 30% to debt payoff or long-term goals\n- 50% to necessary expenses and wants (adjusted)\n`;
    } else if(net === 0) {
      analysis += `You are breaking even. There's no margin for unexpected expenses. Build emergency savings by reducing non-essential costs.\n`;
    } else {
      analysis += `Deficit — you're overspending by $${Math.abs(net).toFixed(2)}. Actions:\n- Trim discretionary expenses first (subscriptions, dining out).\n- Negotiate recurring bills (internet, insurance).\n- Boost incomes (side gigs, freelance).\n`;
    }

    // Biggest contributors
    const topExpenses = Array.from(document.querySelectorAll('.exp-name')).map((el,i)=>({name: el.value || `Expense ${i+1}`, value: parseFloat(document.querySelectorAll('.exp-value')[i].value)||0})).sort((a,b)=>b.value-a.value).slice(0,3);
    analysis += `\nTop expense categories:\n` + topExpenses.map(t=>`- ${t.name}: $${t.value.toFixed(2)}`).join('\n');

    document.getElementById('cf-analysis').textContent = analysis;
  });

  document.getElementById('reset-cash').addEventListener('click', ()=>{
    document.getElementById('income-list').innerHTML = ''; document.getElementById('expense-list').innerHTML = '';
    document.getElementById('income-list').appendChild(rowFactory('inc-name','inc-value','remove-inc','Income source','Monthly amount'));
    document.getElementById('expense-list').appendChild(rowFactory('exp-name','exp-value','remove-exp','Expense name','Monthly amount'));
    document.getElementById('cash-result').classList.add('d-none');
  });

  // initialize rows
  document.getElementById('income-list').innerHTML = ''; document.getElementById('expense-list').innerHTML = '';
  document.getElementById('income-list').appendChild(rowFactory('inc-name','inc-value','remove-inc','Income source','Monthly amount'));
  document.getElementById('expense-list').appendChild(rowFactory('exp-name','exp-value','remove-exp','Expense name','Monthly amount'));
</script>
{% endblock %}
