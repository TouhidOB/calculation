{% extends "base.html" %}
{% block title %}Subscription Management Calculator{% endblock %}
{% block meta_description %}Track and analyze recurring subscriptions, annualize costs, and find savings.{% endblock %}

{% block extra_head %}
<style>
.calc-wrapper{background:#fff;padding:22px;border-radius:10px}
.item-row{display:flex;gap:.5rem;margin-bottom:.5rem;align-items:center}
.analysis{white-space:pre-wrap}
.canvas-holder{max-width:700px}
.small-muted{font-size:.95rem;color:#6c757d}
.switch { display:flex; gap:.5rem; align-items:center; }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Subscription Management</h1>
  <p class="small-muted">List subscriptions (monthly/annual) to see total recurring cost and saving opportunities.</p>

  <div class="calc-wrapper mt-3">
    <form id="subs-form">
      <div id="subs-list">
        <div class="item-row">
          <input class="form-control sub-name" placeholder="Subscription name (Netflix)">
          <select class="form-control sub-period"><option value="monthly">Monthly</option><option value="annual">Annual</option></select>
          <input class="form-control sub-amount" type="number" placeholder="Amount" min="0" step="0.01">
          <button class="btn btn-outline-danger btn-sm remove-sub" type="button">−</button>
        </div>
      </div>

      <div class="mt-2">
        <button id="sub-add" type="button" class="btn btn-sm btn-outline-primary">+ Add Subscription</button>
        <button class="btn btn-primary" type="submit">Analyze Subscriptions</button>
        <button id="sub-reset" type="button" class="btn btn-secondary">Reset</button>
      </div>
    </form>

    <div id="sub-result" class="mt-4 d-none">
      <h5>Result</h5>
      <div><strong>Total Monthly Cost:</strong> $<span id="sub-monthly">0.00</span></div>
      <div><strong>Total Annualized Cost:</strong> $<span id="sub-annual">0.00</span></div>
      <div class="mt-3 canvas-holder"><canvas id="sub-chart"></canvas></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="sub-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function makeSubRow(){ const d=document.createElement('div'); d.className='item-row';
  d.innerHTML = `<input class="form-control sub-name" placeholder="Subscription name">
  <select class="form-control sub-period"><option value="monthly">Monthly</option><option value="annual">Annual</option></select>
  <input class="form-control sub-amount" type="number" placeholder="Amount" min="0" step="0.01">
  <button class="btn btn-outline-danger btn-sm remove-sub" type="button">−</button>`;
  return d;
}
document.getElementById('sub-add').addEventListener('click', ()=>document.getElementById('subs-list').appendChild(makeSubRow()));
document.addEventListener('click', e=>{ if(e.target.classList.contains('remove-sub')) e.target.parentElement.remove(); });

let subChart=null;
document.getElementById('subs-form').addEventListener('submit', function(e){
  e.preventDefault();
  const subs = Array.from(document.querySelectorAll('.sub-name')).map((el,i)=>({
    name: el.value || `Sub ${i+1}`,
    period: document.querySelectorAll('.sub-period')[i].value,
    amount: parseFloat(document.querySelectorAll('.sub-amount')[i].value) || 0
  })).filter(s=>s.amount>0);

  const annualized = subs.map(s => ({ name: s.name, annual: s.period==='monthly' ? s.amount*12 : s.amount }));
  const totalAnnual = annualized.reduce((s,i)=>s+i.annual,0);
  const totalMonthly = totalAnnual/12;

  document.getElementById('sub-monthly').textContent = totalMonthly.toFixed(2);
  document.getElementById('sub-annual').textContent = totalAnnual.toFixed(2);
  document.getElementById('sub-result').classList.remove('d-none');

  const ctx = document.getElementById('sub-chart').getContext('2d');
  if(subChart) subChart.destroy();
  subChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: annualized.map(a=>a.name), datasets:[{ data: annualized.map(a=>a.annual) }] }
  });

  // deep analysis
  let analysis = `Total annual subscription cost: $${totalAnnual.toFixed(2)} (${(totalMonthly).toFixed(2)} per month).\nTop subscriptions:\n`;
  annualized.sort((a,b)=>b.annual-a.annual).slice(0,5).forEach(a=> analysis += `- ${a.name}: $${a.annual.toFixed(2)} / year\n`);
  analysis += `\nSavings tips:\n- Cancel or pause unused services.\n- Switch monthly to annual only if you use it and if annual discount exists.\n- Share family plans where appropriate to split costs.`;
  document.getElementById('sub-analysis').textContent = analysis;
});

// init
document.getElementById('subs-list').innerHTML=''; document.getElementById('subs-list').appendChild(makeSubRow());
document.getElementById('sub-reset').addEventListener('click', function(){
  document.getElementById('subs-list').innerHTML=''; document.getElementById('subs-list').appendChild(makeSubRow());
  document.getElementById('sub-result').classList.add('d-none');
});
</script>
{% endblock %}
