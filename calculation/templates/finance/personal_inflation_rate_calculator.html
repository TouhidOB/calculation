{% extends "base.html" %}
{% block title %}Personal Inflation Rate Calculator{% endblock %}
{% block meta_description %}Calculate your personal inflation rate based on your category spending changes.{% endblock %}

{% block extra_head %}
<style>
.calc-wrapper{background:#fff;padding:22px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.04)}
.analysis{white-space:pre-wrap}
.cat-row{display:flex;gap:.5rem;margin-bottom:.5rem}
.canvas-holder{max-width:600px}
.small-muted{font-size:.95rem;color:#6c757d}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Personal Inflation Rate Calculator</h1>
  <p class="small-muted">Estimate how your personal cost-of-living changed by comparing last year's spending and this year's spending per category.</p>

  <div class="calc-wrapper mt-3">
    <form id="pir-form">
      <div id="pir-list">
        <div class="cat-row">
          <input class="form-control pir-name" placeholder="Category (e.g., Groceries)">
          <input class="form-control pir-last" type="number" placeholder="Last Year Spend (annual)" min="0" step="0.01">
          <input class="form-control pir-this" type="number" placeholder="This Year Spend (annual)" min="0" step="0.01">
          <button class="btn btn-outline-danger btn-sm remove-cat" type="button">−</button>
        </div>
      </div>

      <div class="mt-2">
        <button id="pir-add" type="button" class="btn btn-sm btn-outline-primary">+ Add Category</button>
        <button class="btn btn-primary" type="submit">Calculate Personal Inflation</button>
        <button id="pir-reset" type="button" class="btn btn-secondary">Reset</button>
      </div>
    </form>

    <div id="pir-result" class="mt-4 d-none">
      <h5>Result</h5>
      <div><strong>Personal Inflation Rate (weighted):</strong> <span id="pir-rate">0.00</span>%</div>
      <div class="mt-3 canvas-holder"><canvas id="pir-chart"></canvas></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="pir-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function makeRow(){ const d=document.createElement('div'); d.className='cat-row'; d.innerHTML=`
  <input class="form-control pir-name" placeholder="Category (e.g., Groceries)">
  <input class="form-control pir-last" type="number" placeholder="Last Year Spend (annual)" min="0" step="0.01">
  <input class="form-control pir-this" type="number" placeholder="This Year Spend (annual)" min="0" step="0.01">
  <button class="btn btn-outline-danger btn-sm remove-cat" type="button">−</button>`; return d;
}
document.getElementById('pir-add').addEventListener('click', ()=>document.getElementById('pir-list').appendChild(makeRow()));
document.addEventListener('click', e=>{ if(e.target.classList.contains('remove-cat')) e.target.parentElement.remove(); });

let pirChart = null;
document.getElementById('pir-form').addEventListener('submit', function(e){
  e.preventDefault();
  const names = Array.from(document.querySelectorAll('.pir-name')).map(n=>n.value||'Category');
  const last = Array.from(document.querySelectorAll('.pir-last')).map(n=>parseFloat(n.value)||0);
  const nowA = Array.from(document.querySelectorAll('.pir-this')).map(n=>parseFloat(n.value)||0);

  const totalLast = last.reduce((s,v)=>s+v,0);
  // If totalLast is 0, compute simple percent change average
  let weightedChange = 0;
  if(totalLast === 0){
    // Avoid divide by zero: compute average % change across categories with last>0
    let deltas = [];
    for(let i=0;i<names.length;i++){
      if(last[i] > 0) deltas.push( ((nowA[i] - last[i]) / last[i]) );
    }
    weightedChange = deltas.length ? (deltas.reduce((a,b)=>a+b,0)/deltas.length)*100 : 0;
  } else {
    for(let i=0;i<names.length;i++){
      const weight = last[i] / totalLast;
      const change = last[i] === 0 ? 0 : ( (nowA[i] - last[i]) / last[i] ); // fractional change per category
      weightedChange += weight * change * 100;
    }
  }

  // Build chart: category % change
  const pctChanges = names.map((_,i)=> last[i] === 0 ? 0 : ((nowA[i]-last[i]) / last[i])*100 );
  const ctx = document.getElementById('pir-chart').getContext('2d');
  if(pirChart) pirChart.destroy();
  pirChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: names, datasets: [{ label: 'Category % Change', data: pctChanges, borderWidth:1 }] },
    options: { scales: { y: { beginAtZero:true } } }
  });

  document.getElementById('pir-rate').textContent = weightedChange.toFixed(2);
  document.getElementById('pir-result').classList.remove('d-none');

  // Deep analysis
  let analysis = `Weighted personal inflation: ${weightedChange.toFixed(2)}% (this is how your annual spending changed overall).\n\n`;
  analysis += `Interpretation:\n- Positive value indicates your personal cost-of-living rose; negative means you spent less overall.\n`;
  // highlight top movers
  const combined = names.map((n,i)=>({name:n, last:last[i], now:nowA[i], pct: pctChanges[i]})).sort((a,b)=>Math.abs(b.pct)-Math.abs(a.pct));
  analysis += `\nTop category movers:\n` + combined.slice(0,5).map(c=>`- ${c.name}: ${c.pct.toFixed(1)}% (${c.last===0 ? 'no prior spend' : '$'+c.last.toFixed(2) + ' → $' + c.now.toFixed(2)})`).join('\n');
  analysis += `\n\nRecommendations:\n- If essential categories (housing, healthcare) rose sharply, plan to increase income or cut discretionary items.\n- If discretionary categories drove most of the rise, set targets to reduce those by 10–20% to offset inflation.\n- Revisit yearly and track to spot trends; consider subscription review, meal planning, and cheaper transport options.`;

  document.getElementById('pir-analysis').textContent = analysis;
});

document.getElementById('pir-reset').addEventListener('click', function(){
  document.getElementById('pir-list').innerHTML = '';
  document.getElementById('pir-list').appendChild(makeRow());
  document.getElementById('pir-result').classList.add('d-none');
});
// initialize one row
document.getElementById('pir-list').innerHTML = ''; document.getElementById('pir-list').appendChild(makeRow());
</script>
{% endblock %}
