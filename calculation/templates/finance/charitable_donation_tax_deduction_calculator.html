{% extends "base.html" %}
{% block title %}Charitable Donation Tax Deduction Calculator{% endblock %}
{% block meta_description %}Estimate tax savings from charitable donations (universal—enter your tax rate).{% endblock %}

{% block extra_head %}
<style>
.calc-wrapper{background:#fff;padding:22px;border-radius:10px}
.item-row{display:flex;gap:.5rem;margin-bottom:.5rem}
.analysis{white-space:pre-wrap}
.canvas-holder{max-width:700px}
.small-muted{font-size:.95rem;color:#6c757d}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Charitable Donation Tax Deduction Calculator</h1>
  <p class="small-muted">Enter donation items and your marginal tax rate (local) to estimate tax benefit.</p>

  <div class="calc-wrapper mt-3">
    <form id="charity-form">
      <div id="donation-list">
        <div class="item-row">
          <input class="form-control donation-name" placeholder="Charity name / description">
          <input class="form-control donation-amount" type="number" placeholder="Amount ($)" min="0" step="0.01">
          <button class="btn btn-outline-danger btn-sm remove-donation" type="button">−</button>
        </div>
      </div>

      <div class="mt-2">
        <button id="don-add" type="button" class="btn btn-sm btn-outline-primary">+ Add Donation</button>
      </div>

      <div class="row mt-2">
        <div class="col-md-6"><label>Marginal Tax Rate (%)</label><input id="don-tax" class="form-control" type="number" value="25" step="0.01"></div>
        <div class="col-md-6 align-self-end">
          <button class="btn btn-primary" type="submit">Estimate Tax Benefit</button>
          <button id="don-reset" type="button" class="btn btn-secondary">Reset</button>
        </div>
      </div>
    </form>

    <div id="don-result" class="mt-4 d-none">
      <h5>Result</h5>
      <div><strong>Total Donations:</strong> $<span id="don-total">0.00</span></div>
      <div><strong>Estimated Tax Savings:</strong> $<span id="don-savings">0.00</span> (based on marginal rate)</div>
      <div class="mt-3 canvas-holder"><canvas id="don-chart"></canvas></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="don-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function makeDonationRow(){
  const d=document.createElement('div'); d.className='item-row';
  d.innerHTML=`<input class="form-control donation-name" placeholder="Charity name / description">
  <input class="form-control donation-amount" type="number" placeholder="Amount ($)" min="0" step="0.01">
  <button class="btn btn-outline-danger btn-sm remove-donation" type="button">−</button>`;
  return d;
}
document.getElementById('don-add').addEventListener('click', ()=>document.getElementById('donation-list').appendChild(makeDonationRow()));
document.addEventListener('click', e=>{ if(e.target.classList.contains('remove-donation')) e.target.parentElement.remove(); });

let donChart=null;
document.getElementById('charity-form').addEventListener('submit', function(e){
  e.preventDefault();
  const donations = Array.from(document.querySelectorAll('.donation-name')).map((el,i)=>({
    name: el.value || `Donation ${i+1}`,
    amount: parseFloat(document.querySelectorAll('.donation-amount')[i].value) || 0
  })).filter(d=>d.amount>0);

  const total = donations.reduce((s,d)=>s+d.amount,0);
  const taxRate = parseFloat(document.getElementById('don-tax').value)/100 || 0;
  const savings = total * taxRate;

  document.getElementById('don-total').textContent = total.toFixed(2);
  document.getElementById('don-savings').textContent = savings.toFixed(2);
  document.getElementById('don-result').classList.remove('d-none');

  // Chart
  const ctx = document.getElementById('don-chart').getContext('2d');
  if(donChart) donChart.destroy();
  donChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: donations.map(d=>d.name), datasets:[{ label:'Donation ($)', data: donations.map(d=>d.amount) }] },
    options:{scales:{y:{beginAtZero:true}}}
  });

  // Deep analysis
  let analysis = `Total donated: $${total.toFixed(2)}. Estimated tax savings at ${ (taxRate*100).toFixed(1) }% marginal rate: $${savings.toFixed(2)}.\n\nRecommendations:\n- Confirm donation qualifies for tax deduction in your jurisdiction (receipt, eligible charity).\n- Consider bunching donations across years if you itemize and it increases tax benefit.\n- Keep documentation (receipts, charity registration) for tax filing.`;

  document.getElementById('don-analysis').textContent = analysis;
});

// init
document.getElementById('donation-list').innerHTML=''; document.getElementById('donation-list').appendChild(makeDonationRow());
document.getElementById('don-reset').addEventListener('click', function(){
  document.getElementById('donation-list').innerHTML=''; document.getElementById('donation-list').appendChild(makeDonationRow());
  document.getElementById('don-tax').value = '25';
  document.getElementById('don-result').classList.add('d-none');
});
</script>
{% endblock %}
