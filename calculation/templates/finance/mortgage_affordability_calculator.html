{% extends "base.html" %}
{% block title %}Mortgage Affordability Calculator{% endblock %}
{% block meta_description %}Determine how much mortgage you can afford based on income, monthly debts, and the prevailing interest rates (using the 36% Debt-to-Income rule).{% endblock %}
{% block meta_keywords %}mortgage calculator, affordability, home loan, debt to income, DTI{% endblock %}
{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    canvas {
        margin-top: 20px;
    }
    .result-alert {
        white-space: pre-wrap;
    }
</style>
{% endblock %}
{% block content %}
<div class="container my-4">
    <h1 class="mb-3">Mortgage Affordability Calculator</h1>
    <p class="small-muted">Calculates the **maximum loan amount** you can afford based on a recommended $\mathbf{36\%}$ Debt-to-Income ($\text{DTI}$) ratio.</p>
    
    <div class="calc-wrapper mt-4">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#mort-monthly">Monthly Income</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mort-annual">Annual Income</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#mort-daily">Daily Income</a></li>
        </ul>
        
        <div class="tab-content mt-3">
            
            <div class="tab-pane fade show active" id="mort-monthly">
                <form class="mort-form" data-period="monthly">
                    <h5 class="section-title">Income & Debts (Monthly)</h5>
                    <input type="number" class="form-control my-2 income" placeholder="Gross Monthly Income ($)" min="1" step="100" required>
                    <input type="number" class="form-control my-2 debts" placeholder="Total Monthly Debts ($)" min="0" step="10" required>
                    <h5 class="section-title">Mortgage Details</h5>
                    <input type="number" class="form-control my-2 rate" placeholder="Annual Interest Rate (%)" min="0.01" max="100" step="0.01" required>
                    <input type="number" class="form-control my-2 term" placeholder="Term (Total Months, e.g., 360 for 30 yrs)" min="1" step="12" required>
                    <button class="btn btn-primary mt-3" type="submit">Calculate</button>
                </form>
            </div>
            
            <div class="tab-pane fade" id="mort-annual">
                <form class="mort-form" data-period="annual">
                    <h5 class="section-title">Income & Debts (Annual)</h5>
                    <input type="number" class="form-control my-2 income" placeholder="Gross Annual Income ($)" min="1000" step="1000" required>
                    <input type="number" class="form-control my-2 debts" placeholder="Total Monthly Debts ($)" min="0" step="10" required>
                    <h5 class="section-title">Mortgage Details</h5>
                    <input type="number" class="form-control my-2 rate" placeholder="Annual Interest Rate (%)" min="0.01" max="100" step="0.01" required>
                    <input type="number" class="form-control my-2 term" placeholder="Term (Total Months, e.g., 360 for 30 yrs)" min="1" step="12" required>
                    <button class="btn btn-primary mt-3" type="submit">Calculate</button>
                </form>
            </div>

            <div class="tab-pane fade" id="mort-daily">
                <form class="mort-form" data-period="daily">
                    <h5 class="section-title">Income & Debts (Daily)</h5>
                    <input type="number" class="form-control my-2 income" placeholder="Gross Daily Income ($)" min="10" step="1" required>
                    <input type="number" class="form-control my-2 debts" placeholder="Total Monthly Debts ($)" min="0" step="10" required>
                    <h5 class="section-title">Mortgage Details</h5>
                    <input type="number" class="form-control my-2 rate" placeholder="Annual Interest Rate (%)" min="0.01" max="100" step="0.01" required>
                    <input type="number" class="form-control my-2 term" placeholder="Term (Total Months, e.g., 360 for 30 yrs)" min="1" step="12" required>
                    <button class="btn btn-primary mt-3" type="submit">Calculate</button>
                </form>
            </div>
            
        </div>
        <div class="alert alert-info mt-4 d-none result-alert" id="mort-result"></div>
        <table class="table table-bordered mt-4 d-none" id="mort-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="mort-body"></tbody>
        </table>
        <canvas id="mort-chart" class="d-none"></canvas>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let mortChart = null;

    // Amortization function: Calculates the maximum principal (P) given M, i, and n
    // P = M * [ (1 - (1 + i)^-n) / i ]
    function calculateAffordablePrincipal(M, i, n) {
        if (i === 0) {
            return M * n;
        }
        // Using Math.pow(1 + i, -n) is equivalent to 1 / Math.pow(1 + i, n)
        return M * (1 - Math.pow(1 + i, -n)) / i;
    }

    document.querySelectorAll('.mort-form').forEach(function (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const period = form.dataset.period;
            const inputIncome = parseFloat(form.querySelector('.income').value);
            const monthlyDebts = parseFloat(form.querySelector('.debts').value);
            const R = parseFloat(form.querySelector('.rate').value) / 100; // Annual Rate
            const N = parseInt(form.querySelector('.term').value); // Total Months

            // 1. Normalize Income to Monthly Income (Required for DTI)
            let monthlyIncome;
            if (period === 'monthly') {
                monthlyIncome = inputIncome;
            } else if (period === 'annual') {
                // Annual Income / 12 months
                monthlyIncome = inputIncome / 12;
            } else { // daily
                // Daily Income * (365.25 days / 12 months)
                monthlyIncome = inputIncome * (365.25 / 12);
            }

            // 2. Determine Max Total Monthly Payment Allowed (P&I + Taxes/Insurance + Debts)
            // Lenders typically cap the Total DTI (Debt + Housing) at 36% (0.36)
            const maxTotalDTI = 0.36; 
            const maxTotalPayment = monthlyIncome * maxTotalDTI;

            // 3. Determine Max Mortgage Principal & Interest (P&I) Payment
            // The P&I payment is the remaining portion after subtracting existing monthly debts.
            const maxMortgagePayment = maxTotalPayment - monthlyDebts; 
            
            // 4. Input Validation
            if (maxMortgagePayment <= 0) {
                const res = document.getElementById('mort-result');
                res.classList.remove('d-none');
                res.innerHTML = `**Max Monthly Payment Allowed (36% DTI):** $${maxTotalPayment.toFixed(2)}\n
**Remaining for Mortgage P&I:** $${maxMortgagePayment.toFixed(2)}\n
<span style="color:red;font-weight:bold;">‚ùå Error: Existing debts ($${monthlyDebts.toFixed(2)}) already exceed the maximum allowed payment, or your income is too low.</span>`;
                document.getElementById('mort-table').classList.add('d-none');
                document.getElementById('mort-chart').classList.add('d-none');
                return;
            }

            // 5. Calculate Affordable Loan Amount (Principal, P)
            // i = Monthly Periodic Rate
            const i = R / 12; 
            const affordableLoan = calculateAffordablePrincipal(maxMortgagePayment, i, N);

            // 6. Update Results Display
            const res = document.getElementById('mort-result');
            res.classList.remove('d-none');
            res.innerHTML = `**Normalized Monthly Income:** $${monthlyIncome.toFixed(2)}\n
**Max Total Monthly Payment Allowed (36% DTI):** $${maxTotalPayment.toFixed(2)}\n
**Max Mortgage P&I Payment Affordable:** $${maxMortgagePayment.toFixed(2)}\n
---
**Affordable Loan Amount (Principal):** **$${affordableLoan.toFixed(0)}**`;

            document.getElementById('mort-table').classList.remove('d-none');
            document.getElementById('mort-body').innerHTML = `<tr><td>Normalized Monthly Income</td><td>$${monthlyIncome.toFixed(2)}</td></tr>
<tr><td>Max Total Payment (36% DTI)</td><td>$${maxTotalPayment.toFixed(2)}</td></tr>
<tr><td>Max Mortgage P&I Payment</td><td>$${maxMortgagePayment.toFixed(2)}</td></tr>
<tr><td>**Affordable Loan Principal**</td><td>**$${affordableLoan.toFixed(0)}**</td></tr>`;

            // 7. Update Chart
            const ctx = document.getElementById('mort-chart').getContext('2d');
            document.getElementById('mort-chart').classList.remove('d-none');
            if (mortChart) mortChart.destroy();
            
            const remainingIncome = Math.max(0, monthlyIncome - maxTotalPayment);

            mortChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Existing Debts', 'Max Mortgage P&I', 'Remaining Income'],
                    datasets: [{
                        data: [monthlyDebts.toFixed(2), maxMortgagePayment.toFixed(2), remainingIncome.toFixed(2)],
                        backgroundColor: ['#ff9f40', '#4bc0c0', '#36a2eb'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: 'Allocation of Max Monthly Payment & Income' }
                    }
                }
            });
        });
    });
</script>
{% endblock %}