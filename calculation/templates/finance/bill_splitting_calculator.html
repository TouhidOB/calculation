{% extends "base.html" %}

{% block title %}Bill Splitting Calculator (Friends / Roommates){% endblock %}
{% block meta_description %}Split bills fairly among friends and adjust for special shares or items paid separately.{% endblock %}

{% block extra_head %}
<style>.calc-wrapper{background:#fff;padding:22px;border-radius:10px}.analysis{white-space:pre-wrap}.person-row{display:flex;gap:.5rem;margin-bottom:.5rem}</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Bill Splitting Calculator</h1>
  <p class="small-muted">Split a bill fairly among people, support tips and custom shares.</p>

  <div class="calc-wrapper mt-3">
    <form id="bill-form">
      <div class="row">
        <div class="col-md-4 mb-2"><label>Total Bill Amount ($)</label><input id="bill-total" type="number" class="form-control" step="0.01" value="0"></div>
        <div class="col-md-4 mb-2"><label>Tip (%)</label><input id="bill-tip" type="number" class="form-control" step="0.01" value="0"></div>
        <div class="col-md-4 mb-2"><label>Number of People</label><input id="bill-count" type="number" class="form-control" value="2" min="1"></div>
      </div>

      <div class="mt-2">
        <button id="bill-generate" type="button" class="btn btn-outline-primary btn-sm">Generate People Inputs</button>
      </div>

      <div id="people-list" class="mt-3"></div>

      <div class="mt-2">
        <button class="btn btn-primary" type="submit">Split Bill</button>
        <button id="bill-reset" type="button" class="btn btn-secondary">Reset</button>
      </div>
    </form>

    <div id="bill-result" class="mt-4 d-none">
      <h5>Result</h5>
      <div id="bill-shares"></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="bill-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function makePersonRow(i){
  const d = document.createElement('div'); d.className = 'person-row';
  d.innerHTML = `
    <input class="form-control person-name" placeholder="Person ${i+1} name (optional)">
    <input class="form-control person-share" type="number" placeholder="Share weight (default 1)" value="1" min="0" step="0.01">
    <input class="form-control person-extra" type="number" placeholder="Extra to pay (items, $)" value="0" step="0.01">
  `;
  return d;
}

document.getElementById('bill-generate').addEventListener('click', function(){
  const count = parseInt(document.getElementById('bill-count').value) || 1;
  const list = document.getElementById('people-list');
  list.innerHTML = '';
  for(let i=0;i<count;i++) list.appendChild(makePersonRow(i));
});

document.getElementById('bill-form').addEventListener('submit', function(e){
  e.preventDefault();
  const total = parseFloat(document.getElementById('bill-total').value) || 0;
  const tipPct = parseFloat(document.getElementById('bill-tip').value) || 0;
  const tip = total * (tipPct/100);
  const grand = total + tip;

  const names = Array.from(document.querySelectorAll('.person-name')).map(el=>el.value);
  const shares = Array.from(document.querySelectorAll('.person-share')).map(el=>parseFloat(el.value)||0);
  const extras = Array.from(document.querySelectorAll('.person-extra')).map(el=>parseFloat(el.value)||0);

  const totalShare = shares.reduce((s,v)=>s+v,0);
  const basePerShare = totalShare === 0 ? 0 : (grand - extras.reduce((s,v)=>s+v,0)) / totalShare;

  const results = shares.map((w,i)=>({
    name: names[i] || `Person ${i+1}`,
    shareAmount: basePerShare * w + extras[i]
  }));

  // rounding: ensure sum equals grand
  let sum = results.reduce((s,r)=>s + r.shareAmount, 0);
  const diff = grand - sum;
  if(Math.abs(diff) >= 0.01 && results.length>0) results[0].shareAmount += diff; // adjust first person

  // display
  const container = document.getElementById('bill-shares');
  container.innerHTML = '';
  results.forEach(r=>{
    const div = document.createElement('div');
    div.innerHTML = `<strong>${r.name}:</strong> $${r.shareAmount.toFixed(2)}`;
    container.appendChild(div);
  });
  document.getElementById('bill-result').classList.remove('d-none');

  // analysis
  let analysis = `Total bill: $${total.toFixed(2)} | Tip: $${tip.toFixed(2)} (${tipPct}%) | Grand total: $${grand.toFixed(2)}\n\n`;
  analysis += `Split method: Weighted shares + extras. Total share weight: ${totalShare.toFixed(2)}.\n`;
  analysis += `If everyone is equal, set share weight = 1 for all. If someone had more items, increase their extra or share weight.\n\nPractical tips:\n- Round up small amounts to reduce micro-adjustments.\n- Keep a simple record of who paid which extras for fairness.`;
  document.getElementById('bill-analysis').textContent = analysis;
});

document.getElementById('bill-reset').addEventListener('click', function(){
  ['bill-total','bill-tip','bill-count'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('people-list').innerHTML='';
  document.getElementById('bill-result').classList.add('d-none');
});
</script>
{% endblock %}
