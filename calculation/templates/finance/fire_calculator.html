{% extends "base.html" %}
{% block title %}FIRE (Financial Independence) Calculator{% endblock %}
{% block meta_description %}Estimate the size of the nest egg you need and years to FIRE using the 4% rule (customizable withdrawal rate).{% endblock %}

{% block extra_head %}
<style>
.calc-wrapper{background:#fff;padding:22px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.04)}
.analysis{white-space:pre-wrap}
.canvas-holder{max-width:700px}
.small-muted{font-size:.95rem;color:#6c757d}
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <h1>Financial Independence (FIRE) Calculator</h1>
  <p class="small-muted">Calculate the target nest egg using the safe withdrawal rule and estimate time to reach it.</p>

  <div class="calc-wrapper mt-3">
    <form id="fire-form">
      <div class="row">
        <div class="col-md-4 mb-2"><label>Current Annual Expenses ($)</label><input id="fire-expenses" class="form-control" type="number" step="0.01" required></div>
        <div class="col-md-4 mb-2"><label>Current Savings ($)</label><input id="fire-savings" class="form-control" type="number" step="0.01" value="0"></div>
        <div class="col-md-4 mb-2"><label>Expected Annual Return (%)</label><input id="fire-return" class="form-control" type="number" step="0.01" value="6"></div>
      </div>

      <div class="row mt-2">
        <div class="col-md-4 mb-2"><label>Annual Contribution ($)</label><input id="fire-contrib" class="form-control" type="number" step="0.01" value="0"></div>
        <div class="col-md-4 mb-2"><label>Withdrawal Rate (%) — safe withdrawal (default 4%)</label><input id="fire-withdraw" class="form-control" type="number" step="0.01" value="4"></div>
        <div class="col-md-4 mb-2 align-self-end">
          <button class="btn btn-primary" type="submit">Compute FIRE Target</button>
          <button id="fire-reset" type="button" class="btn btn-secondary">Reset</button>
        </div>
      </div>
    </form>

    <div id="fire-result" class="mt-4 d-none">
      <h5>Result</h5>
      <div><strong>Target Nest Egg:</strong> $<span id="fire-target">0.00</span> (based on withdrawal rate)</div>
      <div><strong>Estimated Years to FIRE:</strong> <span id="fire-years">0</span> years</div>

      <div class="mt-3 canvas-holder"><canvas id="fire-chart"></canvas></div>

      <h6 class="mt-3">Deep Analysis</h6>
      <div id="fire-analysis" class="analysis alert alert-light"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function fvContributions(pv, annualContrib, r, years){
  // Future value with annual contributions at year-end: FV = pv*(1+r)^n + contrib * [((1+r)^n -1)/r]
  if(r === 0) return pv + annualContrib * years;
  return pv * Math.pow(1+r, years) + annualContrib * ((Math.pow(1+r, years) - 1) / r);
}

document.getElementById('fire-form').addEventListener('submit', function(e){
  e.preventDefault();
  const expenses = parseFloat(document.getElementById('fire-expenses').value) || 0;
  const savings = parseFloat(document.getElementById('fire-savings').value) || 0;
  const annualReturnPct = parseFloat(document.getElementById('fire-return').value) / 100 || 0.06;
  const contrib = parseFloat(document.getElementById('fire-contrib').value) || 0;
  const withdrawPct = parseFloat(document.getElementById('fire-withdraw').value) / 100 || 0.04;

  // Target = annual expenses / withdrawal rate
  const target = withdrawPct === 0 ? Infinity : (expenses / withdrawPct);
  document.getElementById('fire-target').textContent = isFinite(target) ? target.toFixed(2) : '∞';

  // Estimate years to reach target by iterating years up to 100
  let years = 0, fv = savings;
  while(years < 100 && fv < target){
    years++;
    fv = fvContributions(savings, contrib, annualReturnPct, years);
  }
  document.getElementById('fire-years').textContent = years<100 ? years : '100+';

  // Chart: progress simulation over years
  const labels = []; const data = [];
  for(let y=0;y<=Math.min(years+5,50);y++){
    labels.push(y.toString());
    data.push(fvContributions(savings, contrib, annualReturnPct, y));
  }
  const ctx = document.getElementById('fire-chart').getContext('2d');
  if(window.fireChart) window.fireChart.destroy();
  window.fireChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets:[{label:'Projected Portfolio', data, tension:0.3, fill:false, borderWidth:2}] },
    options:{scales:{y:{beginAtZero:true}}}
  });

  document.getElementById('fire-result').classList.remove('d-none');

  // Deep analysis
  let analysis = `Target nest egg (based on ${ (withdrawPct*100).toFixed(2) }% withdrawal): $${isFinite(target) ? target.toFixed(2) : 'N/A'}\n`;
  analysis += `Current savings: $${savings.toFixed(2)} | Annual contribution: $${contrib.toFixed(2)} | Expected return: ${(annualReturnPct*100).toFixed(2)}%\n\n`;

  if(!isFinite(target)){
    analysis += 'Withdrawal rate is 0% — adjust withdrawal rate to compute a realistic target.\n';
  } else {
    if(savings >= target) analysis += 'You have already reached your FIRE target — great work!\n';
    else if(years > 80) analysis += 'At current savings & contributions, it would take longer than a normal working lifetime. Increase savings or returns.\n';
    else analysis += `Estimated years to reach target: ${years} (using provided assumptions).\n`;
  }

  analysis += `\nRecommendations:\n- Increase annual contributions and/or seek higher long-term returns (diversified stock index funds) while managing risk.\n- Reduce annual expenses where feasible — each $1,000 reduction reduces the target by ${ (1000/withdrawPct).toFixed(0) }.\n- Re-run with conservative return (e.g., 4–6%) to stress-test plan.`;

  document.getElementById('fire-analysis').textContent = analysis;
});

document.getElementById('fire-reset').addEventListener('click', function(){
  ['fire-expenses','fire-savings','fire-return','fire-contrib','fire-withdraw'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fire-result').classList.add('d-none');
});
</script>
{% endblock %}
