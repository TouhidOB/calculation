{% extends "base.html" %}

{% block title %}Plumbing Vent Pipe Size Calculator{% endblock %}

{% block meta_description %}Calculate the minimum required diameter for a plumbing vent pipe based on Drainage Fixture Units (DFU) and vent length, according to code standards. {% endblock %}

{% block meta_keywords %}plumbing vent size, DFU calculator, drainage fixture units, vent length, pipe diameter, plumbing code, UPC, IPC{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: #00BCD4; /* Cyan/Turquoise for Water/Plumbing */
        border-bottom: 2px solid #00BCD4;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .result-alert {
        font-size: 1.2rem;
        font-weight: 500;
        border-left: 5px solid #4DD0E1; 
    }

    .input-group-text {
        min-width: 120px;
        justify-content: center;
        background-color: #e0f7fa;
        font-weight: 600;
        color: #00BCD4;
    }

    .info-box {
        background-color: #f7feff; /* Lightest cyan info box */
        border: 1px solid #00BCD4;
        border-radius: 5px;
        padding: 10px;
        margin-top: 15px;
        font-size: 0.85rem;
    }

    .result-value {
        font-size: 2.8rem;
        font-weight: 800;
        color: #00BCD4;
    }
    
    .size-recommendation {
        font-size: 2.5rem;
        font-weight: 800;
        color: #FF7043; /* Orange for the critical result */
    }
    
    .dfu-guide td:first-child {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4 text-center">ðŸ’§ Plumbing Vent Pipe Size Calculator</h1>
    <p class="text-center small-muted">Determine the minimum vent pipe diameter based on load and length for optimal drainage.</p>
    [Image of typical plumbing vent system]

    <div class="calc-wrapper">

        <form id="vent-size-calculator-form">
            <h5 class="section-title">1. Fixture Load and Length</h5>

            <!-- DFU Input -->
            <label for="dfu-input" class="form-label">Total Drainage Fixture Units (DFU) Served</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Total DFU</span>
                <input type="number" id="dfu-input" class="form-control" name="dfu" placeholder="e.g., 6" value="6" min="1" step="0.5" required>
            </div>
            
            <!-- Length Input (Feet) -->
            <label for="length-input" class="form-label">Total Length of Vent Pipe</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Length (L)</span>
                <input type="number" id="length-input" class="form-control" name="length" placeholder="e.g., 40" value="40" min="1" step="1" required>
                <span class="input-group-text">Feet</span>
            </div>

            <h5 class="section-title">2. DFU Reference Guide (Common Fixtures)</h5>
            
            <div class="info-box">
                <p class="mb-2">If you don't know your total DFU, use this guide to estimate the load for common fixtures on this vent line:</p>
                <table class="table table-sm dfu-guide">
                    <tbody>
                        <tr><td>Bathroom Sink/Lavatory</td><td>1 DFU</td></tr>
                        <tr><td>Toilet (Water Closet)</td><td>3 DFU</td></tr>
                        <tr><td>Kitchen Sink</td><td>2 DFU</td></tr>
                        <tr><td>Bathtub or Shower</td><td>2 DFU</td></tr>
                        <tr><td>Dishwasher/Washing Machine</td><td>2 DFU</td></tr>
                    </tbody>
                </table>
            </div>

            <button class="btn btn-dark btn-lg w-100 mt-4" style="background-color: #00BCD4; border-color: #00BCD4;" type="submit">Calculate Minimum Vent Size</button>
        </form>

        <div class="alert mt-4 d-none result-alert alert-info" id="vent-result"></div>

        <h5 class="section-title d-none" id="table-title">Sizing Criteria Breakdown</h5>
        <table class="table table-bordered mt-2 d-none" id="vent-table">
            <thead>
                <tr class="table-dark" style="background-color: #00BCD4; color: white;">
                    <th>Criteria</th>
                    <th>Minimum Size Required</th>
                </tr>
            </thead>
            <tbody id="vent-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Sizing Table (Based on common IPC/UPC standards for Dry Vents) ---
    // The final required size is the largest (thickest pipe) required by EITHER the DFU load or the Length.
    // Index helps us compare sizes logically (larger index = thicker pipe).
    const SIZING_TABLE = [
        // Smallest Residential Vent Size (often used for single fixtures)
        { size: 1.5, sizeStr: '1.5"', maxFU: 8, maxLength: 60, index: 1 }, 
        // Common Residential Vent Stack Size
        { size: 2.0, sizeStr: '2.0"', maxFU: 24, maxLength: 120, index: 2 },
        // Main Stack or Commercial Vent Size
        { size: 3.0, sizeStr: '3.0"', maxFU: 200, maxLength: 200, index: 3 },
        // Large Commercial or Apartment Building Vent
        { size: 4.0, sizeStr: '4.0"', maxFU: 500, maxLength: 300, index: 4 }
    ];

    // Helper function to find the minimum required size index based on a constraint (DFU or Length)
    function getMinSizeIndex(value, constraintKey) {
        let requiredIndex = -1; // Default to lowest index (smallest pipe)

        for (const item of SIZING_TABLE) {
            // Find the smallest pipe that meets the value constraint
            if (value <= item[constraintKey]) {
                return item.index;
            }
            // If the value is larger than the max for the current pipe, keep looking
            requiredIndex = item.index; 
        }
        // If the value exceeds the capacity of the largest pipe in the table
        return requiredIndex; 
    }

    // Helper function to get the pipe size string from an index
    function getSizeStrByIndex(index) {
        const item = SIZING_TABLE.find(item => item.index === index);
        return item ? item.sizeStr : 'Consult Engineer (Size > 4")';
    }
    
    // Function to display errors or results
    function displayResult(isError, message, metrics) {
        const res = document.getElementById('vent-result');
        const table = document.getElementById('vent-table');
        const tableTitle = document.getElementById('table-title');
        const tableBody = document.getElementById('vent-body');

        // Hide and reset classes
        res.classList.remove('d-none', 'alert-warning', 'alert-danger', 'alert-info', 'alert-success');
        table.classList.add('d-none');
        tableTitle.classList.add('d-none');
        tableBody.innerHTML = '';
        res.classList.add('alert-info');

        if (isError) {
            res.classList.add('alert-danger');
            res.innerHTML = `**Calculation Error:** ${message}`;
        } else {
            // Primary result
            res.innerHTML = `
**Minimum Required Vent Pipe Diameter:**
<div class="text-center mt-3 mb-2">
    <span class="size-recommendation">${metrics.recommendedSizeStr}</span>
</div>
<p class="small text-center mt-3 mb-0">
    **Note:** This size is the larger requirement driven by ${metrics.controllingFactor}.
</p>
`;
            
            // Populate and show the detailed table
            let tableRows = `
            <tr><td>**Recommended Minimum Pipe Size**</td><td>**${metrics.recommendedSizeStr}**</td></tr>
            <tr><td>Controlling Factor</td><td>${metrics.controllingFactor}</td></tr>
            <tr><td colspan="2" class="text-center table-active">**Minimum Requirements**</td></tr>
            <tr><td>Minimum Size for Load (${metrics.dfu} DFU)</td><td>${metrics.sizeByDFUStr}</td></tr>
            <tr><td>Minimum Size for Length (${metrics.length} ft)</td><td>${metrics.sizeByLengthStr}</td></tr>
            `;
            
            tableBody.innerHTML = tableRows;
            table.classList.remove('d-none');
            tableTitle.classList.remove('d-none');
        }
    }

    // Main Calculation Logic
    document.getElementById('vent-size-calculator-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;
        
        // Input values
        const dfu = parseFloat(form.elements.dfu.value);
        const length = parseFloat(form.elements.length.value);
        
        // Basic validation
        if (isNaN(dfu) || dfu <= 0 || isNaN(length) || length <= 0) 
        {
            displayResult(true, "Please ensure DFU Load and Vent Length are valid positive numbers.");
            return;
        }

        try {
            // --- 1. Sizing by DFU Load ---
            const sizeIndexByDFU = getMinSizeIndex(dfu, 'maxFU');
            const sizeByDFUStr = getSizeStrByIndex(sizeIndexByDFU);

            // --- 2. Sizing by Vent Length ---
            const sizeIndexByLength = getMinSizeIndex(length, 'maxLength');
            const sizeByLengthStr = getSizeStrByIndex(sizeIndexByLength);
            
            // --- 3. Final Recommendation (The largest required size) ---
            const recommendedIndex = Math.max(sizeIndexByDFU, sizeIndexByLength);
            const recommendedSizeStr = getSizeStrByIndex(recommendedIndex);
            
            let controllingFactor = '';
            if (sizeIndexByDFU > sizeIndexByLength) {
                controllingFactor = 'DFU Load';
            } else if (sizeIndexByLength > sizeIndexByDFU) {
                controllingFactor = 'Vent Length';
            } else {
                controllingFactor = 'Both DFU Load and Vent Length';
            }

            // 4. Display results
            const metrics = {
                dfu, length, 
                sizeIndexByDFU, sizeByDFUStr,
                sizeIndexByLength, sizeByLengthStr,
                recommendedIndex, recommendedSizeStr,
                controllingFactor
            };
            displayResult(false, "", metrics);

        } catch (error) {
            console.error("Calculation Error:", error);
            displayResult(true, "An unexpected error occurred during the calculation.");
        }
    });

    // Run once on load to ensure initial hidden state
    window.onload = function() {
        document.getElementById('vent-result').classList.add('d-none');
        document.getElementById('vent-table').classList.add('d-none');
        document.getElementById('table-title').classList.add('d-none');
    };
</script>
{% endblock %}

