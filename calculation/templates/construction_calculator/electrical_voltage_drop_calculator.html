{% extends "base.html" %}

{% block title %}Electrical Voltage Drop Calculator{% endblock %}

{% block meta_description %}Calculate the actual voltage drop and percentage drop for an electrical circuit using the wire size, length, current, and voltage. {% endblock %}

{% block meta_keywords %}voltage drop calculator, electrical drop, AWG resistance, circuit efficiency, electrical calculation, copper, aluminum{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: #2196F3; /* Blue for Precision/Efficiency */
        border-bottom: 2px solid #2196F3;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .result-alert {
        font-size: 1.2rem;
        font-weight: 500;
        border-left: 5px solid;
    }

    .input-group-text {
        min-width: 120px;
        justify-content: center;
        background-color: #e3f2fd;
        font-weight: 600;
        color: #2196F3;
    }

    .info-box {
        background-color: #f0f7fb;
        border: 1px solid #2196F3;
        border-radius: 5px;
        padding: 10px;
        margin-top: 15px;
        font-size: 0.85rem;
    }

    .drop-volts {
        font-size: 2.5rem;
        font-weight: 800;
        color: #D32F2F; /* Red for high drop */
    }
    
    .drop-percent {
        font-size: 2.2rem;
        font-weight: 800;
        color: #03A9F4; /* Blue for good result */
    }

    .status-bad {
        color: #D32F2F;
        font-weight: bold;
    }
    .status-good {
        color: #4CAF50;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4 text-center">ðŸ“‰ Electrical Voltage Drop Calculator</h1>
    <p class="text-center small-muted">Calculate the actual voltage drop in your circuit and check if it meets the recommended $3\%$ standard.</p>
    

    <div class="calc-wrapper">

        <form id="voltage-drop-calculator-form">
            <h5 class="section-title">1. Circuit Parameters</h5>

            <!-- Amperage Input -->
            <label for="amps-input" class="form-label">Circuit Current (Amps)</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Current (I)</span>
                <input type="number" id="amps-input" class="form-control" name="amps" placeholder="e.g., 20" value="20" min="1" step="0.5" required>
                <span class="input-group-text">Amps</span>
            </div>
            
            <!-- Distance Input -->
            <label for="distance-input" class="form-label">One-Way Distance from Source to Load</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Distance (L)</span>
                <input type="number" id="distance-input" class="form-control" name="distance" placeholder="e.g., 75" value="75" min="1" step="1" required>
                <span class="input-group-text">Feet</span>
            </div>

            <!-- Voltage Input -->
            <label for="voltage-select" class="form-label">Circuit Voltage</label>
            <select class="form-select mb-3" id="voltage-select" name="voltage">
                <option value="120" selected>120 V (Standard)</option>
                <option value="240">240 V (Appliances)</option>
            </select>

            <h5 class="section-title">2. Wire Specification</h5>
            
            <!-- Wire Material -->
            <label for="material-select" class="form-label">Wire Material</label>
            <select class="form-select mb-3" id="material-select" name="material">
                <option value="copper" selected>Copper (K=12.9)</option>
                <option value="aluminum">Aluminum (K=21.2)</option>
            </select>
            
            <!-- Wire Gauge -->
            <label for="awg-select" class="form-label">Wire Gauge (AWG)</label>
            <select class="form-select mb-3" id="awg-select" name="awg">
                <option value="14 AWG" selected>14 AWG</option>
                <option value="12 AWG">12 AWG</option>
                <option value="10 AWG">10 AWG</option>
                <option value="8 AWG">8 AWG</option>
                <option value="6 AWG">6 AWG</option>
                <option value="4 AWG">4 AWG</option>
                <option value="3 AWG">3 AWG</option>
                <option value="2 AWG">2 AWG</option>
                <option value="1 AWG">1 AWG</option>
                <option value="1/0 AWG">1/0 AWG</option>
                <option value="2/0 AWG">2/0 AWG</option>
                <option value="3/0 AWG">3/0 AWG</option>
                <option value="4/0 AWG">4/0 AWG</option>
            </select>
            
            <div class="info-box">
                The calculation uses the formula: $VD = \frac{2 \cdot K \cdot I \cdot L}{C M A}$. The **$K$** value is based on $75^\circ C$ temperature rating.
            </div>

            <button class="btn btn-dark btn-lg w-100 mt-4" style="background-color: #2196F3; border-color: #2196F3;" type="submit">Calculate Voltage Drop</button>
        </form>

        <div class="alert mt-4 d-none result-alert" id="drop-result"></div>

        <h5 class="section-title d-none" id="table-title">Calculation Breakdown</h5>
        <table class="table table-bordered mt-2 d-none" id="drop-table">
            <thead>
                <tr class="table-dark" style="background-color: #2196F3; color: white;">
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="drop-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Constants ---
    
    // Resistance Constants (K) for 75Â°C Copper and Aluminum
    const K_FACTORS = {
        'copper': 12.9,
        'aluminum': 21.2
    }; 

    // Circular Mil Area (CMA) for common AWG sizes
    const AWG_CMA_MAP = {
        '14 AWG': 4110,
        '12 AWG': 6530,
        '10 AWG': 10380,
        '8 AWG': 16510,
        '6 AWG': 26240,
        '4 AWG': 41740,
        '3 AWG': 52620,
        '2 AWG': 66360,
        '1 AWG': 83690,
        '1/0 AWG': 105600, 
        '2/0 AWG': 133100,
        '3/0 AWG': 167800,
        '4/0 AWG': 211600
    };

    const MAX_RECOMMENDED_DROP = 3.0; // NEC recommended max drop percentage

    // Function to calculate Voltage Drop
    function calculateVoltageDrop(K, I, L, CMA) {
        // VD = (2 * K * I * L) / CMA
        return (2 * K * I * L) / CMA;
    }
    
    // Function to display errors or results
    function displayResult(isError, message, metrics) {
        const res = document.getElementById('drop-result');
        const table = document.getElementById('drop-table');
        const tableTitle = document.getElementById('table-title');
        const tableBody = document.getElementById('drop-body');

        // Hide and reset classes
        res.classList.remove('d-none', 'alert-warning', 'alert-danger', 'alert-info', 'alert-success');
        table.classList.add('d-none');
        tableTitle.classList.add('d-none');
        tableBody.innerHTML = '';
        res.style.borderColor = ''; // Reset border color

        if (isError) {
            res.classList.add('alert-danger');
            res.innerHTML = `**Calculation Error:** ${message}`;
        } else {
            const dropStatus = metrics.percentDrop > MAX_RECOMMENDED_DROP 
                ? `<span class="status-bad">TOO HIGH - Exceeds ${MAX_RECOMMENDED_DROP}%</span>`
                : `<span class="status-good">ACCEPTABLE - Below ${MAX_RECOMMENDED_DROP}%</span>`;

            const alertClass = metrics.percentDrop > MAX_RECOMMENDED_DROP ? 'alert-danger' : 'alert-success';
            const alertBorderColor = metrics.percentDrop > MAX_RECOMMENDED_DROP ? '#D32F2F' : '#4CAF50';

            res.classList.add(alertClass);
            res.style.borderColor = alertBorderColor;
            
            // Primary result
            res.innerHTML = `
**Calculated Voltage Drop Summary:**
<div class="d-flex justify-content-around align-items-center mt-3">
    <div class="text-center">
        <span class="drop-volts">${metrics.voltageDrop.toFixed(2)}</span><br>
        <span class="small text-muted">Volts Lost</span>
    </div>
    <div class="text-center">
        <span class="drop-percent">${metrics.percentDrop.toFixed(2)}%</span><br>
        <span class="small text-muted">Percentage Drop</span>
    </div>
</div>
<p class="small text-center mt-3 mb-0">
    **Status:** ${dropStatus}
</p>
`;
            
            // Populate and show the detailed table
            let tableRows = `
            <tr><td>**Voltage Drop (Volts)**</td><td>**${metrics.voltageDrop.toFixed(2)} V**</td></tr>
            <tr><td>Percentage Drop</td><td>${metrics.percentDrop.toFixed(2)} %</td></tr>
            <tr><td>Initial Voltage</td><td>${metrics.voltage} V</td></tr>
            <tr><td>Final Voltage at Load</td><td>${(metrics.voltage - metrics.voltageDrop).toFixed(2)} V</td></tr>
            <tr><td colspan="2" class="text-center table-active">**Input Values**</td></tr>
            <tr><td>Circuit Current (I)</td><td>${metrics.amps} Amps</td></tr>
            <tr><td>Distance (L)</td><td>${metrics.distance} ft</td></tr>
            <tr><td>Wire Gauge (AWG)</td><td>${metrics.awg}</td></tr>
            <tr><td>Wire Material (K)</td><td>${metrics.material} (K=${metrics.K})</td></tr>
            <tr><td>Circular Mils Area (CMA)</td><td>${metrics.CMA} CM</td></tr>
            `;
            
            tableBody.innerHTML = tableRows;
            table.classList.remove('d-none');
            tableTitle.classList.remove('d-none');
        }
    }

    // Main Calculation Logic
    document.getElementById('voltage-drop-calculator-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;
        
        // Input values
        const amps = parseFloat(form.elements.amps.value);
        const distance = parseFloat(form.elements.distance.value);
        const voltage = parseInt(form.elements.voltage.value, 10);
        const material = form.elements.material.value;
        const awg = form.elements.awg.value;
        
        // Lookup constants
        const K = K_FACTORS[material];
        const CMA = AWG_CMA_MAP[awg];

        // Basic validation
        if (isNaN(amps) || amps <= 0 || isNaN(distance) || distance <= 0) 
        {
            displayResult(true, "Please ensure Current (Amps) and Distance (Feet) are valid positive numbers.");
            return;
        }

        try {
            // --- 1. Calculate Voltage Drop (VD) ---
            const voltageDrop = calculateVoltageDrop(K, amps, distance, CMA);

            // --- 2. Calculate Percentage Drop (%VD) ---
            const percentDrop = (voltageDrop / voltage) * 100;
            
            // 3. Display results
            const metrics = {
                amps, voltage, distance, material, awg,
                K, CMA,
                voltageDrop,
                percentDrop
            };
            displayResult(false, "", metrics);

        } catch (error) {
            console.error("Calculation Error:", error);
            displayResult(true, "An unexpected error occurred during the calculation.");
        }
    });

    // Run once on load to ensure initial hidden state
    window.onload = function() {
        document.getElementById('drop-result').classList.add('d-none');
        document.getElementById('drop-table').classList.add('d-none');
        document.getElementById('table-title').classList.add('d-none');
    };
</script>
{% endblock %}

