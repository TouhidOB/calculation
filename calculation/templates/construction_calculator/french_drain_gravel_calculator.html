{% extends "base.html" %}

{% block title %}French Drain Gravel Calculator{% endblock %}

{% block meta_description %}Calculate the cubic yard volume of drain rock (gravel) and the linear feet of perforated pipe required for a French drain project. {% endblock %}

{% block meta_keywords %}french drain calculator, drainage ditch, gravel volume, trench cubic yards, perforated pipe, aggregate estimate, linear feet{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
    }

    .section-title {
        font-weight: 700;
        margin-top: 25px;
        color: #795548; /* Brown/Earth Tone for landscaping */
        border-bottom: 2px solid #795548;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .result-alert {
        font-size: 1.2rem;
        font-weight: 500;
        border-left: 5px solid #4CAF50; /* Green for key results (water management) */
    }

    .input-group-text {
        min-width: 100px;
        justify-content: center;
        background-color: #f7f7f7;
        font-weight: 600;
    }

    .info-box {
        background-color: #efebe9; /* Light brown info box */
        border: 1px solid #795548;
        border-radius: 5px;
        padding: 10px;
        margin-top: 15px;
        font-size: 0.85rem;
    }

    .result-value {
        font-size: 2rem;
        font-weight: 700;
        color: #795548;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4 text-center">⛏️ French Drain Gravel Calculator</h1>
    <p class="text-center small-muted">Estimates the volume of drain rock (gravel) and pipe needed for your trench.</p>
    

    <div class="calc-wrapper">

        <form id="drain-calculator-form">
            <h5 class="section-title">1. Trench Dimensions & Length</h5>

            <!-- Trench Length Input (Feet) -->
            <label for="length-input" class="form-label">Total Trench Length</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Length (L)</span>
                <input type="number" id="length-input" class="form-control" name="trenchLength" placeholder="e.g., 50" value="50" min="1" step="0.1" required>
                <span class="input-group-text">ft</span>
            </div>
            
            <!-- Trench Width Input (Inches) -->
            <label for="width-input" class="form-label">Trench Width</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Width (W)</span>
                <input type="number" id="width-input" class="form-control" name="trenchWidth" placeholder="e.g., 12" value="12" min="1" step="0.1" required>
                <span class="input-group-text">in</span>
            </div>

            <!-- Trench Depth Input (Inches) -->
            <label for="depth-input" class="form-label">Trench Depth</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Depth (D)</span>
                <input type="number" id="depth-input" class="form-control" name="trenchDepth" placeholder="e.g., 24" value="24" min="1" step="0.1" required>
                <span class="input-group-text">in</span>
            </div>
            
            <h5 class="section-title">2. Material Selection</h5>

            <!-- Pipe Diameter Input (Inches) -->
            <label for="pipe-diameter-input" class="form-label">Perforated Pipe Diameter</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Pipe Dia.</span>
                <input type="number" id="pipe-diameter-input" class="form-control" name="pipeDiameter" placeholder="e.g., 4" value="4" min="0.5" step="0.5" required>
                <span class="input-group-text">in</span>
            </div>

            <div class="info-box">
                **Material Calculation:** The tool calculates the total trench volume and then subtracts the volume of the pipe to give a more accurate estimate of the required gravel volume.
            </div>

            <button class="btn btn-dark btn-lg w-100 mt-4" style="background-color: #795548; border-color: #795548;" type="submit">Calculate Materials</button>
        </form>

        <div class="alert mt-4 d-none result-alert alert-success" id="drain-result"></div>

        <h5 class="section-title d-none" id="table-title">Material Requirement Summary</h5>
        <table class="table table-bordered mt-2 d-none" id="drain-table">
            <thead>
                <tr class="table-dark" style="background-color: #795548; color: white;">
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="drain-body"></tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Constants
    const CUBIC_FEET_PER_CUBIC_YARD = 27;
    const INCHES_PER_FOOT = 12;
    // Note: No waste factor is typically added as cubic yard material delivery is often rounded up by supplier.

    // Function to display errors or results
    function displayResult(isError, message, metrics) {
        const res = document.getElementById('drain-result');
        const table = document.getElementById('drain-table');
        const tableTitle = document.getElementById('table-title');
        const tableBody = document.getElementById('drain-body');

        // Hide and reset classes
        res.classList.remove('d-none', 'alert-success', 'alert-danger');
        table.classList.add('d-none');
        tableTitle.classList.add('d-none');
        tableBody.innerHTML = '';

        if (isError) {
            res.classList.add('alert-danger');
            res.innerHTML = `**Calculation Error:** ${message}`;
        } else {
            res.classList.add('alert-success');
            
            // Primary result: Volume and Pipe Length
            res.innerHTML = `
**Required Materials:**
<div class="d-flex justify-content-around mt-3">
    <div class="text-center">
        <span class="result-value">${metrics.gravelCubicYards.toFixed(2)}</span><br>
        <span class="small text-muted">Cubic Yards of Gravel</span>
    </div>
    <div class="text-center">
        <span class="result-value">${metrics.trenchLength}</span><br>
        <span class="small text-muted">Linear Feet of Pipe</span>
    </div>
</div>
`;
            
            // Populate and show the detailed table
            let tableRows = `
            <tr><td>Gravel Volume Required (Cubic Yards)</td><td>**${metrics.gravelCubicYards.toFixed(2)} yd³**</td></tr>
            <tr><td>Total Pipe Required (Linear Feet)</td><td>${metrics.trenchLength} ft</td></tr>
            <tr><td>Total Trench Volume (Cubic Feet)</td><td>${metrics.totalTrenchVolumeCuFt.toFixed(2)} ft³</td></tr>
            <tr><td>Pipe Volume (Approximate)</td><td>${metrics.pipeVolumeCuFt.toFixed(2)} ft³</td></tr>
            <tr><td colspan="2" class="text-center table-active">**Input Summary**</td></tr>
            <tr><td>Trench Length (L)</td><td>${metrics.trenchLength} ft</td></tr>
            <tr><td>Trench Width (W)</td><td>${metrics.trenchWidth} in</td></tr>
            <tr><td>Trench Depth (D)</td><td>${metrics.trenchDepth} in</td></tr>
            <tr><td>Pipe Diameter</td><td>${metrics.pipeDiameter} in</td></tr>
            `;
            
            tableBody.innerHTML = tableRows;
            table.classList.remove('d-none');
            tableTitle.classList.remove('d-none');
        }
    }

    // Main Calculation Logic
    document.getElementById('drain-calculator-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const form = e.target;
        
        // Input values
        const trenchLength = parseFloat(form.elements.trenchLength.value); // L (ft)
        const trenchWidth = parseFloat(form.elements.trenchWidth.value); // W (in)
        const trenchDepth = parseFloat(form.elements.trenchDepth.value); // D (in)
        const pipeDiameter = parseFloat(form.elements.pipeDiameter.value); // P (in)
        
        // Basic validation
        if (isNaN(trenchLength) || trenchLength <= 0 || isNaN(trenchWidth) || trenchWidth <= 0 || 
            isNaN(trenchDepth) || trenchDepth <= 0 || isNaN(pipeDiameter) || pipeDiameter <= 0) 
        {
            displayResult(true, "Please ensure all dimensions are valid positive numbers.");
            return;
        }
        
        if (pipeDiameter >= trenchWidth || pipeDiameter >= trenchDepth) {
            displayResult(true, "Pipe diameter must be smaller than both trench width and depth.");
            return;
        }

        try {
            // --- 1. Calculate Total Trench Volume (in Cubic Feet) ---
            
            // Convert width and depth from inches to feet
            const widthFt = trenchWidth / INCHES_PER_FOOT;
            const depthFt = trenchDepth / INCHES_PER_FOOT;
            
            // Volume = Length * Width * Depth
            const totalTrenchVolumeCuFt = trenchLength * widthFt * depthFt;
            
            // --- 2. Calculate Pipe Volume (in Cubic Feet) ---
            
            // Pipe Volume (Cylinder) = pi * (radius)^2 * Length
            // Radius in feet = (Pipe Diameter / 2) / 12
            const pipeRadiusFt = (pipeDiameter / 2) / INCHES_PER_FOOT;
            
            const pipeVolumeCuFt = Math.PI * Math.pow(pipeRadiusFt, 2) * trenchLength;
            
            // --- 3. Calculate Gravel Volume (in Cubic Yards) ---
            
            // Gravel Volume in Cu Ft = Total Trench Volume - Pipe Volume
            const gravelVolumeCuFt = totalTrenchVolumeCuFt - pipeVolumeCuFt;
            
            if (gravelVolumeCuFt <= 0) {
                displayResult(true, "Calculated gravel volume is zero or negative. Check if the pipe diameter is too large relative to the trench.");
                return;
            }

            // Convert Cu Ft to Cu Yards
            const gravelCubicYards = gravelVolumeCuFt / CUBIC_FEET_PER_CUBIC_YARD;
            
            // 4. Display results
            const metrics = {
                trenchLength,
                trenchWidth,
                trenchDepth,
                pipeDiameter,
                totalTrenchVolumeCuFt,
                pipeVolumeCuFt,
                gravelCubicYards
            };
            displayResult(false, "", metrics);

        } catch (error) {
            console.error("Calculation Error:", error);
            displayResult(true, "An unexpected error occurred during the calculation.");
        }
    });

    // Run once on load to ensure initial hidden state
    window.onload = function() {
        document.getElementById('drain-result').classList.add('d-none');
        document.getElementById('drain-table').classList.add('d-none');
        document.getElementById('table-title').classList.add('d-none');
    };
</script>
{% endblock %}

