{% extends "base.html" %}

{% block title %}VO2 Max Calculator (Non-Exercise Estimation){% endblock %}

{% block meta_description %}Estimate your VO2 Max (Maximum Oxygen Uptake), a key measure of cardiovascular fitness, using non-exercise metrics like age, gender, and activity level.{% endblock %}

{% block meta_keywords %}VO2 Max, maximum oxygen uptake, fitness calculator, cardiovascular health, endurance, predicted VO2 Max{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    canvas {
        margin-top: 20px;
    }

    .result-alert {
        white-space: pre-wrap;
    }
    
    .vo2-result-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #28a745; /* Green color for fitness metric */
    }

    .gender-group {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">ðŸ’¨ VO2 Max Calculator</h1>
    <p class="small-muted">Estimate your **VO2 Max** (mL/kg/min) using the non-exercise prediction method based on age, gender, activity level, and BMI. This provides a quick indicator of your aerobic fitness level.</p>

    <div class="calc-wrapper mt-4">

        <form id="vo2-form">
            <h5 class="section-title">Step 1: Personal Data</h5>

            <!-- Gender Input -->
            <div class="form-group mb-3">
                <label class="form-label d-block">Gender</label>
                <div class="gender-group">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" required>
                        <label class="form-check-label" for="genderMale">Male</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" required>
                        <label class="form-check-label" for="genderFemale">Female</label>
                    </div>
                </div>
            </div>

            <!-- Age Input -->
            <input type="number" class="form-control my-2" id="age" placeholder="Age (Years)" min="18" max="80" required>

            <!-- Weight Input -->
            <div class="input-group my-2">
                <input type="number" class="form-control" id="weight_lb" placeholder="Weight (e.g., 180)" min="50" max="800" step="0.1" required>
                <span class="input-group-text">lbs</span>
            </div>

            <!-- Height Input (Feet and Inches) -->
            <label class="form-label d-block mt-3">Height</label>
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_ft" placeholder="Feet (e.g., 5)" min="3" max="7" required>
                        <span class="input-group-text">ft</span>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_in" placeholder="Inches (e.g., 10)" min="0" max="11" required>
                        <span class="input-group-text">in</span>
                    </div>
                </div>
            </div>

            <h5 class="section-title mt-4">Step 2: Activity Level</h5>

            <!-- Activity Level Input (PAL: Physical Activity Level) -->
            <div class="form-group my-3">
                <label for="activity_level" class="form-label">How often do you engage in vigorous exercise?</label>
                <select class="form-select" id="activity_level" required>
                    <option value="" disabled selected>Select frequency</option>
                    <option value="1">Never / Seldom</option>
                    <option value="2">Sometimes (1-2 times per week)</option>
                    <option value="3">Regularly (3 or more times per week)</option>
                </select>
            </div>

            <button class="btn btn-primary mt-3" type="submit">Estimate VO2 Max</button>
        </form>

        <div class="alert mt-4 d-none result-alert" id="vo2-result"></div>

        <h5 class="section-title d-none" id="table-title">VO2 Max Fitness Classification</h5>
        <table class="table table-bordered mt-2 d-none" id="vo2-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>VO2 Max Range (mL/kg/min)</th>
                </tr>
            </thead>
            <tbody id="vo2-body"></tbody>
        </table>

        <canvas id="vo2-chart" class="d-none"></canvas>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let vo2Chart = null;
    
    // VO2 Max Classification standards (Example for 30-39 age group)
    // Source: Common fitness norms (values change by age, simplified for demonstration)
    const VO2_MAX_NORMS = {
        male: [
            { max: 30, label: 'Very Poor', color: '#dc3545' },
            { max: 38, label: 'Poor', color: '#ffc107' },
            { max: 44, label: 'Fair', color: '#fd7e14' },
            { max: 52, label: 'Good', color: '#20c997' },
            { max: 60, label: 'Excellent', color: '#17a2b8' },
            { max: 200, label: 'Superior', color: '#007bff' }
        ],
        female: [
            { max: 25, label: 'Very Poor', color: '#dc3545' },
            { max: 32, label: 'Poor', color: '#ffc107' },
            { max: 39, label: 'Fair', color: '#fd7e14' },
            { max: 48, label: 'Good', color: '#20c997' },
            { max: 56, label: 'Excellent', color: '#17a2b8' },
            { max: 200, label: 'Superior', color: '#007bff' }
        ]
    };

    function getCategory(vo2Max, gender) {
        const norms = VO2_MAX_NORMS[gender];
        for (const cat of norms) {
            if (vo2Max <= cat.max) {
                return cat;
            }
        }
        return norms[0]; // Should not happen
    }

    document.getElementById('vo2-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const age = parseFloat(document.getElementById('age').value);
        const weight_lb = parseFloat(document.getElementById('weight_lb').value);
        const height_ft = parseFloat(document.getElementById('height_ft').value);
        const height_in = parseFloat(document.getElementById('height_in').value);
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const activity_level_code = parseFloat(document.getElementById('activity_level').value);

        // 2. Unit Conversions
        const weight_kg = weight_lb * 0.453592;
        const total_height_m = ((height_ft * 12) + height_in) * 0.0254; // Total inches to meters
        const bmi = weight_kg / (total_height_m * total_height_m);
        
        let activity_score = 0;
        // Map activity level to score (based on non-exercise estimation models)
        if (activity_level_code === 1) activity_score = 0;
        else if (activity_level_code === 2) activity_score = 5.8;
        else if (activity_level_code === 3) activity_score = 7.7;
        
        // 3. Apply Non-Exercise VO2 Max Estimation Formula (simplified model)
        // VO2 Max = A + B * Age + C * BMI + D * Activity
        let vo2_max;
        
        if (gender === 'male') {
            // Male coefficients (Example values)
            const A = 108.844;
            const B = -0.56;
            const C = -0.49;
            const D = 0.51; 
            
            // Formula adapted for non-exercise factors
            vo2_max = 60.18 - (0.47 * age) - (0.33 * bmi) + activity_score; 
            // A common simplified formula: VO2 max = 60.18 - (0.47 * Age) - (0.33 * BMI) + Activity Score
        } else { // female
            // Female coefficients (Example values)
            const A = 114.73;
            const B = -0.63;
            const C = -0.48;
            const D = 0.51;
            
            // Formula adapted for non-exercise factors
            vo2_max = 50.5 - (0.48 * age) - (0.37 * bmi) + activity_score;
            // A common simplified formula: VO2 max = 50.5 - (0.48 * Age) - (0.37 * BMI) + Activity Score
        }
        
        const vo2_max_rounded = Math.max(10, vo2_max.toFixed(1)); // Ensure a minimum plausible value
        
        // 4. Categorize Result
        const category = getCategory(parseFloat(vo2_max_rounded), gender);

        // 5. Update Result Display
        const res = document.getElementById('vo2-result');
        res.classList.remove('d-none', 'alert-danger');
        res.classList.add('alert-success');
        res.innerHTML = `
**Estimated VO2 Max:** <span class="vo2-result-value">${vo2_max_rounded} mL/kg/min</span>
**Fitness Classification:** ${category.label}
---
*Note: This is an estimation based on non-exercise factors. Laboratory testing is required for precise measurement.*
`;
        
        // 6. Update Classification Table
        document.getElementById('table-title').classList.remove('d-none');
        document.getElementById('vo2-table').classList.remove('d-none');
        const tableBody = document.getElementById('vo2-body');
        tableBody.innerHTML = ''; // Clear previous results

        VO2_MAX_NORMS[gender].forEach((cat, index) => {
            let range;
            if (index === 0) {
                range = `Under ${cat.max}`;
            } else {
                const prevMax = VO2_MAX_NORMS[gender][index - 1].max;
                range = `${prevMax + 1} - ${cat.max}`;
            }
            if (index === VO2_MAX_NORMS[gender].length - 1) {
                const prevMax = VO2_MAX_NORMS[gender][index - 1].max;
                range = `Over ${prevMax}`;
            }

            tableBody.innerHTML += `
            <tr style="background-color: ${cat.color}33;">
                <td>${cat.label}</td>
                <td>${range}</td>
            </tr>
            `;
        });
        
        // 7. Update Chart (Gauge Chart for VO2 Max Score)
        const ctx = document.getElementById('vo2-chart').getContext('2d');
        document.getElementById('vo2-chart').classList.remove('d-none');
        if (vo2Chart) vo2Chart.destroy();
        
        const chartLabels = VO2_MAX_NORMS[gender].map(c => c.label);
        const chartColors = VO2_MAX_NORMS[gender].map(c => c.color);
        
        // Create segments based on the max value of each category
        const segmentData = VO2_MAX_NORMS[gender].map((c, i) => {
             // Calculate the size of the segment
             if (i === 0) return c.max;
             if (i === VO2_MAX_NORMS[gender].length - 1) return 20; // Max fixed segment size
             return c.max - VO2_MAX_NORMS[gender][i - 1].max;
        }).filter(val => val > 0);
        
        // Add a buffer segment to complete the semi-circle
        segmentData.push(segmentData.reduce((a, b) => a + b, 0));
        chartColors.push('transparent');

        vo2Chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: segmentData,
                    backgroundColor: chartColors,
                    borderWidth: 1,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                rotation: -90,
                circumference: 180,
                cutout: '80%',
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    tooltip: { enabled: true },
                    title: { display: true, text: 'Estimated VO2 Max Gauge' }
                }
            },
            plugins: [{
                // Plugin to draw the needle (indicator)
                id: 'needle',
                afterDraw: (chart) => {
                    const vo2Value = parseFloat(vo2_max_rounded);
                    const totalRange = VO2_MAX_NORMS[gender].reduce((sum, cat) => sum + cat.max, 0); // Simplified total range
                    
                    // Crude angle calculation (normalized to 180 degrees)
                    // We'll normalize the VO2 max within the chart segments displayed
                    const totalSegmentsValue = segmentData.slice(0, -1).reduce((a, b) => a + b, 0);
                    const angle = (vo2Value / totalSegmentsValue) * 180; // Angle from 0 to 180
                    
                    const meta = chart.getDatasetMeta(0);
                    const center = meta.data[0].getCenterPoint();
                    const radius = meta.data[0].outerRadius;
                    
                    const ctx = chart.ctx;
                    ctx.save();
                    
                    // Draw Needle Base
                    ctx.translate(center.x, center.y);
                    ctx.rotate((angle - 180) * Math.PI / 180);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(-6, -radius + 10); // Needle point
                    ctx.lineTo(6, -radius + 10);
                    ctx.fill();
                    
                    // Draw Center Circle
                    ctx.restore();
                    ctx.beginPath();
                    ctx.arc(center.x, center.y, 10, 0, 2 * Math.PI);
                    ctx.fillStyle = '#6c757d';
                    ctx.fill();
                    
                    // Display Value
                    ctx.font = '24px Inter, sans-serif';
                    ctx.fillStyle = '#333';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${vo2_max_rounded}`, center.x, center.y + 30);
                    ctx.font = '12px Inter, sans-serif';
                    ctx.fillText('mL/kg/min', center.x, center.y + 55);

                    ctx.restore();
                }
            }]
        });
    });
</script>

{% endblock %}