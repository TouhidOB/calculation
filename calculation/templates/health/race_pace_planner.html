{% extends "base.html" %}

{% block title %}Race Pace Strategy Planner{% endblock %}

{% block meta_description %}Plan your running race strategy (5K, 10K, Half-Marathon, Marathon) by breaking down a target finish time into required average, negative, and positive split paces.{% endblock %}

{% block meta_keywords %}race pace planner, running strategy, negative split, positive split, target time, split calculator, marathon pace, half marathon pace{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
        color: #059669; /* Green for Strategy/Goals */
    }

    .output-pace {
        font-size: 2.2rem;
        font-weight: bold;
        color: #059669;
        line-height: 1.1;
    }

    .window-card {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        background-color: #f0fdf4; /* Lightest Green */
        border: 2px solid #a7f3d0;
    }

    .target-pace-label {
        font-size: 1.1rem;
        font-weight: 600;
        color: #065f46;
    }

    .split-table th, .split-table td {
        text-align: center;
        vertical-align: middle;
        font-size: 1.05rem;
    }

    .split-table th {
        background-color: #d1fae5;
        color: #065f46;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">⏱️ Race Pace Strategy Planner</h1>
    <p class="small-muted">Break down your **Target Finish Time** for a race into detailed average, even, negative, and positive split strategies.</p>

    <div class="calc-wrapper mt-4">

        <form id="pace-planner-form">
            <h5 class="section-title">Step 1: Target Race & Time</h5>

            <label class="form-label d-block mt-3">Target Race Distance</label>
            <select class="form-select mb-3" id="race_distance" required>
                <option value="" disabled selected>-- Select Distance --</option>
                <option value="5.0">5K</option>
                <option value="10.0">10K</option>
                <option value="21.0975">Half Marathon ($\text{21.1}$ km)</option>
                <option value="42.195">Marathon ($\text{42.2}$ km)</option>
            </select>
            
            <label class="form-label d-block mt-3">Pace/Split Unit</label>
            <select class="form-select mb-3" id="pace_unit">
                <option value="km" selected>Kilometers ($\text{km}$)</option>
                <option value="mile">Miles ($\text{mi}$)</option>
            </select>

            <label class="form-label d-block mt-3">Target Finish Time (H:M:S)</label>
            <div class="row g-2 mb-3">
                <div class="col-4">
                    <input type="number" class="form-control" id="time_h" placeholder="Hours (H)" min="0" max="10" value="0" required>
                </div>
                <div class="col-4">
                    <input type="number" class="form-control" id="time_m" placeholder="Minutes (M)" min="0" max="59" value="45" required>
                </div>
                <div class="col-4">
                    <input type="number" class="form-control" id="time_s" placeholder="Seconds (S)" min="0" max="59" value="0" required>
                </div>
            </div>

            <button class="btn btn-primary mt-4 w-100" type="submit">Plan Race Strategy</button>
        </form>

        <div class="alert alert-danger mt-4 d-none" id="error-message"></div>

        <h5 class="section-title mt-4 d-none" id="result-title">Pace Breakdown & Strategy</h5>
        
        <div id="results-container" class="mt-3 d-none">
            
            <div class="window-card text-center">
                <h6 class="target-pace-label mb-2">Required Average Pace per <span id="pace_label_unit">km</span>:</h6>
                
                <p class="mb-0">
                    <span id="average_pace_display" class="output-pace">0:00</span> 
                    <span class="fs-4 text-muted">/ $\text{km}$</span>
                </p>
            </div>

            <h6 class="section-title mt-4">Split Strategies</h6>

            <div class="row">
                <div class="col-md-4">
                    <div class="window-card">
                        <h6 class="target-pace-label mb-1 text-center">Even Split</h6>
                        <p class="output-pace fs-3 text-center" id="even_split_pace"></p>
                        <p class="text-muted small text-center">Goal: Maintain this pace throughout the race.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="window-card">
                        <h6 class="target-pace-label mb-1 text-center">Negative Split (1st Half)</h6>
                        <p class="output-pace fs-3 text-center" id="neg_split_start"></p>
                        <p class="text-muted small text-center">Start slightly slower, finish stronger (recommended).</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="window-card">
                        <h6 class="target-pace-label mb-1 text-center">Positive Split (1st Half)</h6>
                        <p class="output-pace fs-3 text-center" id="pos_split_start"></p>
                        <p class="text-muted small text-center">Start slightly faster, but risking burnout (not recommended).</p>
                    </div>
                </div>
            </div>
            
            <h6 class="section-title mt-4">Detailed Split Table</h6>
            
            <div class="table-responsive">
                <table class="table table-bordered table-striped mt-3 split-table">
                    <thead>
                        <tr>
                            <th>Distance</th>
                            <th>Even Split</th>
                            <th>Negative Split (2nd Half)</th>
                            <th>Positive Split (2nd Half)</th>
                        </tr>
                    </thead>
                    <tbody id="split-table-body">
                        </tbody>
                </table>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const KM_PER_MILE = 1.60934;
    
    // Percentage difference for positive/negative splits (e.g., 2% difference between halves)
    const SPLIT_DIFFERENCE_PERCENT = 0.02; 

    /** Converts hours, minutes, and seconds into total seconds. */
    function timeToSeconds(h, m, s) {
        return (h * 3600) + (m * 60) + s;
    }

    /** Converts total seconds of pace into a readable M:SS or H:MM:SS format. */
    function secondsToPaceTime(totalSeconds) {
        const m = Math.floor(totalSeconds / 60);
        const s = Math.round(totalSeconds % 60);

        const pad = (num) => num.toString().padStart(2, '0');
        
        return `${m}:${pad(s)}`;
    }

    /** Calculates average pace in seconds per unit (km or mile). */
    function calculateAveragePace(totalSeconds, totalDistance, unit) {
        let distanceInUnits = totalDistance;
        if (unit === 'mile') {
            distanceInUnits = totalDistance / KM_PER_MILE;
        }
        return totalSeconds / distanceInUnits;
    }

    document.getElementById('pace-planner-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const totalDistanceKm = parseFloat(document.getElementById('race_distance').value);
        const unit = document.getElementById('pace_unit').value;
        const timeH = parseInt(document.getElementById('time_h').value);
        const timeM = parseInt(document.getElementById('time_m').value);
        const timeS = parseInt(document.getElementById('time_s').value);

        const totalTimeSeconds = timeToSeconds(timeH, timeM, timeS);
        const unitLabel = unit === 'km' ? 'km' : 'mi';
        const unitDistance = unit === 'km' ? 1.0 : 1.0 / KM_PER_MILE; // Distance of one split unit in km

        // 2. Validation
        if (!totalDistanceKm || isNaN(totalTimeSeconds) || totalTimeSeconds <= 0) {
            displayError("Please select a race distance and enter a valid target finish time greater than zero.");
            return;
        }

        // 3. Calculation of Paces
        
        // A. Even Split (Average Pace)
        const avgPaceSecPerUnit = calculateAveragePace(totalTimeSeconds, totalDistanceKm, unit);
        const avgPaceDisplay = secondsToPaceTime(avgPaceSecPerUnit);

        // B. Negative Split (Slower Start, Faster Finish)
        // Let F1 = Time of 1st half, F2 = Time of 2nd half
        // F2 = F1 * (1 - diff) => F1 + F2 = T
        // F1 + F1 * (1 - diff) = T => F1 * (2 - diff) = T
        // F1 = T / (2 - diff) 
        const totalDistanceUnits = totalDistanceKm / (unit === 'km' ? 1 : KM_PER_MILE);
        const halfDistanceUnits = totalDistanceUnits / 2;
        
        const negSplitTime1stHalf = totalTimeSeconds / (2 + SPLIT_DIFFERENCE_PERCENT);
        const negSplitTime2ndHalf = totalTimeSeconds - negSplitTime1stHalf;
        
        const negPace1stHalf = negSplitTime1stHalf / halfDistanceUnits;
        const negPace2ndHalf = negSplitTime2ndHalf / halfDistanceUnits;

        // C. Positive Split (Faster Start, Slower Finish)
        // F1 = T / (2 + diff) => F1 * (2 + diff) = T
        const posSplitTime1stHalf = totalTimeSeconds / (2 - SPLIT_DIFFERENCE_PERCENT);
        const posSplitTime2ndHalf = totalTimeSeconds - posSplitTime1stHalf;
        
        const posPace1stHalf = posSplitTime1stHalf / halfDistanceUnits;
        const posPace2ndHalf = posSplitTime2ndHalf / halfDistanceUnits;


        // 4. Update Result Display
        
        document.getElementById('pace_label_unit').textContent = unitLabel;
        document.getElementById('average_pace_display').textContent = avgPaceDisplay;
        
        document.getElementById('even_split_pace').textContent = avgPaceDisplay;
        document.getElementById('neg_split_start').textContent = secondsToPaceTime(negPace1stHalf);
        document.getElementById('pos_split_start').textContent = secondsToPaceTime(posPace1stHalf);

        // 5. Build Split Table
        const tableBody = document.getElementById('split-table-body');
        tableBody.innerHTML = '';
        
        const totalSplits = Math.ceil(totalDistanceUnits);
        
        // Split times for the table
        const evenSplitTimePerUnit = totalTimeSeconds / totalDistanceUnits;
        const negSplitTimePerUnit1st = negPace1stHalf;
        const negSplitTimePerUnit2nd = negPace2ndHalf;
        const posSplitTimePerUnit1st = posPace1stHalf;
        const posSplitTimePerUnit2nd = posPace2ndHalf;
        
        const halfDistance = Math.floor(totalDistanceUnits / 2);

        for (let i = 1; i <= totalSplits; i++) {
            let rowPaceNeg, rowPacePos;
            
            if (i <= halfDistance) {
                // First half
                rowPaceNeg = secondsToPaceTime(negSplitTimePerUnit1st);
                rowPacePos = secondsToPaceTime(posSplitTimePerUnit1st);
            } else {
                // Second half
                rowPaceNeg = secondsToPaceTime(negSplitTimePerUnit2nd);
                rowPacePos = secondsToPaceTime(posSplitTimePerUnit2nd);
            }

            // For the last, partial split
            const displayDistance = i < totalSplits ? `${i} ${unitLabel}` : 'Finish';

            tableBody.innerHTML += `
            <tr>
                <td>${displayDistance}</td>
                <td>${avgPaceDisplay}</td>
                <td>${rowPaceNeg}</td>
                <td>${rowPacePos}</td>
            </tr>
            `;
        }


        // 6. Update Visibility
        document.getElementById('result-title').classList.remove('d-none');
        document.getElementById('results-container').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
    });

    function displayError(message) {
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('error-message').textContent = `Calculation Error: ${message}`;
        document.getElementById('result-title').classList.add('d-none');
        document.getElementById('results-container').classList.add('d-none');
    }
</script>

{% endblock %}
