{% extends "base.html" %}

{% block title %}Fitness Age Calculator{% endblock %}

{% block meta_description %}Calculate your estimated Fitness Age based on your actual age, gender, resting heart rate, waist circumference, and physical activity level.{% endblock %}

{% block meta_keywords %}fitness age, biological age, health calculator, resting heart rate, waist circumference, physical activity, health assessment{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
        color: #2563eb; /* Blue for Health Metrics */
    }

    .output-age {
        font-size: 3.5rem;
        font-weight: bold;
        line-height: 1;
    }

    .output-label {
        font-size: 1.1rem;
        font-weight: 500;
        color: #1d4ed8;
    }

    .window-card {
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        background-color: #eff6ff; /* Lightest Blue */
        border: 2px solid #93c5fd;
        text-align: center;
    }
    
    .unit-selector {
        max-width: 100px;
    }

    .age-comparison {
        font-size: 1.1rem;
        margin-top: 10px;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">üèÉ Fitness Age Calculator</h1>
    <p class="small-muted">Estimate your physiological or "Fitness Age" by factoring in key health and lifestyle indicators.</p>

    <div class="calc-wrapper mt-4">

        <form id="fitness-age-form">
            <h5 class="section-title">Step 1: Baseline Data (Must be Age 20-80)</h5>

            <!-- Gender -->
            <label class="form-label d-block mt-3">Gender</label>
            <select class="form-select mb-3" id="user_gender" required>
                <option value="" disabled selected>-- Select Gender --</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
            </select>
            
            <!-- Actual Age -->
            <label class="form-label d-block mt-3">Actual Chronological Age (Years)</label>
            <input type="number" class="form-control mb-3" id="actual_age" placeholder="e.g., 40" min="20" max="80" step="1" required>


            <h5 class="section-title mt-4">Step 2: Physiological Metrics</h5>

            <!-- Resting Heart Rate (RHR) -->
            <label class="form-label d-block mt-3">Resting Heart Rate ($\text{RHR}$) ($\text{bpm}$)</label>
            <div class="input-group mb-3">
                <input type="number" class="form-control" id="rhr_input" placeholder="e.g., 65" min="30" max="120" step="1" required>
                <span class="input-group-text">$\text{bpm}$</span>
            </div>
            <small class="form-text text-muted d-block mb-3">Measure this in the morning before getting out of bed.</small>
            
            <!-- Waist Circumference -->
            <label class="form-label d-block mt-3">Waist Circumference</label>
            <div class="input-group mb-3">
                <input type="number" class="form-control" id="waist_input" placeholder="e.g., 90" min="50" max="150" step="1" required>
                <select class="form-select unit-selector" id="waist_unit">
                    <option value="cm" selected>cm</option>
                    <option value="in">in</option>
                </select>
            </div>


            <h5 class="section-title mt-4">Step 3: Activity Level</h5>
            
            <!-- Activity Level -->
            <label class="form-label d-block mt-3">Weekly Vigorous Physical Activity</label>
            <select class="form-select mb-3" id="activity_level" required>
                <option value="" disabled selected>-- Select Activity Level --</option>
                <option value="low">Low (Less than 1 hour/week)</option>
                <option value="moderate">Moderate (1 to 3 hours/week)</option>
                <option value="high">High (More than 3 hours/week)</option>
            </select>

            <button class="btn btn-primary mt-4 w-100" type="submit">Calculate Fitness Age</button>
        </form>

        <div class="alert alert-danger mt-4 d-none" id="error-message"></div>

        <h5 class="section-title mt-4 d-none" id="result-title">Your Estimated Fitness Age</h5>
        
        <div id="results-container" class="mt-3 d-none">
            
            <div class="window-card">
                <h6 class="output-label mb-3">Your Fitness Age is:</h6>
                
                <p class="mb-0">
                    <span id="fitness_age_value" class="output-age">0</span> 
                    <span class="fs-4 text-muted">Years</span>
                </p>
                
                <div id="age_comparison" class="age-comparison"></div>
            </div>
            
            <p class="small-muted text-center mt-3">
                This is an estimation based on simplified metrics. Consult a doctor for a comprehensive health assessment.
            </p>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const CM_PER_INCH = 2.54;

    // --- Scoring Adjustments (Years subtracted/added to Actual Age) ---
    // The adjustments are generally based on relative health risks associated with the metrics.
    
    // RHR Adjustment (bpm)
    const RHR_ADJUSTMENTS = {
        male: [
            { max: 55, adjustment: -4 }, // Excellent
            { max: 65, adjustment: -2 }, // Good
            { max: 75, adjustment: 1 },  // Average
            { max: 1000, adjustment: 3 },// Poor
        ],
        female: [
            { max: 60, adjustment: -4 }, // Excellent
            { max: 70, adjustment: -2 }, // Good
            { max: 80, adjustment: 1 },  // Average
            { max: 1000, adjustment: 3 },// Poor
        ]
    };

    // Waist Circumference Thresholds (in CM) for high risk
    const WAIST_THRESHOLDS_CM = {
        male: 102, // High risk: > 102 cm
        female: 88, // High risk: > 88 cm
    };
    
    // Waist Adjustment
    const WAIST_ADJUSTMENTS = {
        low: -2, // Below threshold
        high: 3, // Above threshold
    };
    
    // Activity Level Adjustment
    const ACTIVITY_ADJUSTMENTS = {
        high: -3,
        moderate: -1,
        low: 2,
    };
    
    /**
     * Finds the age adjustment based on a metric value and predefined categories.
     */
    function getAdjustment(value, categories) {
        for (const cat of categories) {
            if (value <= cat.max) {
                return cat.adjustment;
            }
        }
        return 0; // Should be covered by the final category
    }

    document.getElementById('fitness-age-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const gender = document.getElementById('user_gender').value;
        const actualAge = parseFloat(document.getElementById('actual_age').value);
        const rhrInput = parseFloat(document.getElementById('rhr_input').value);
        const waistInput = parseFloat(document.getElementById('waist_input').value);
        const waistUnit = document.getElementById('waist_unit').value;
        const activityLevel = document.getElementById('activity_level').value;

        // 2. Validation
        if (!gender || !activityLevel || isNaN(actualAge) || actualAge < 20 || actualAge > 80 || isNaN(rhrInput) || isNaN(waistInput)) {
            displayError("Please check all inputs. Age must be between 20 and 80, and all fields are required.");
            return;
        }

        let totalAdjustment = 0;
        
        // --- A. RHR Adjustment ---
        totalAdjustment += getAdjustment(rhrInput, RHR_ADJUSTMENTS[gender]);
        
        // --- B. Waist Circumference Adjustment ---
        const waistCm = waistUnit === 'in' ? waistInput * CM_PER_INCH : waistInput;
        const waistThreshold = WAIST_THRESHOLDS_CM[gender];
        
        if (waistCm > waistThreshold) {
            totalAdjustment += WAIST_ADJUSTMENTS.high;
        } else {
            totalAdjustment += WAIST_ADJUSTMENTS.low;
        }

        // --- C. Activity Level Adjustment ---
        totalAdjustment += ACTIVITY_ADJUSTMENTS[activityLevel];
        
        // 3. Final Calculation
        let fitnessAge = actualAge + totalAdjustment;
        
        // Ensure fitness age is not negative or zero (e.g., minimum of 18)
        fitnessAge = Math.max(18, fitnessAge);

        // 4. Interpretation Text
        let comparisonText;
        const difference = actualAge - fitnessAge;
        const colorClass = difference > 1 ? 'text-success' : (difference < -1 ? 'text-danger' : 'text-primary');

        if (difference > 1) {
            comparisonText = `Your fitness age is ${Math.round(difference)} years younger than your chronological age. Keep up the great work!`;
        } else if (difference < -1) {
            comparisonText = `Your fitness age is ${Math.round(Math.abs(difference))} years older than your chronological age. Focus on improving your metrics.`;
        } else {
            comparisonText = `Your fitness age is approximately the same as your chronological age.`;
        }
        
        // 5. Update Result Display
        
        document.getElementById('fitness_age_value').textContent = fitnessAge.toFixed(0);
        document.getElementById('fitness_age_value').className = 'output-age ' + colorClass;

        document.getElementById('age_comparison').textContent = comparisonText;

        // 6. Update Visibility
        document.getElementById('result-title').classList.remove('d-none');
        document.getElementById('results-container').classList.remove('d-none');
        document.getElementById('error-message').classList.add('d-none');
    });

    function displayError(message) {
        document.getElementById('error-message').classList.remove('d-none');
        document.getElementById('error-message').textContent = `Calculation Error: ${message}`;
        document.getElementById('result-title').classList.add('d-none');
        document.getElementById('results-container').classList.add('d-none');
    }
</script>

{% endblock %}