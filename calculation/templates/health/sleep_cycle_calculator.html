{% extends "base.html" %}

{% block title %}Sleep Cycle Calculator (Wake-up Time){% endblock %}

{% block meta_description %}Calculate the optimal time to wake up feeling refreshed by setting a bedtime and letting the calculator suggest wake-up times based on 90-minute sleep cycles.{% endblock %}

{% block meta_keywords %}sleep cycle calculator, wake up time, bedtime, sleep quality, 90 minute cycle, refreshed waking, sleep latency{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<style>
    /* ðŸŽ¨ Define Custom Theme Colors */
    :root {
        --purple-accent: #6f42c1;
        --deep-purple: #4a148c;
    }

    /* ðŸ§¼ Styling for the central calculation block (Purple/Teal Theme) */
    .calc-wrapper {
        background: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        max-width: 650px;
        margin: 0 auto;
    }

    .section-title {
        font-weight: 700;
        color: var(--deep-purple); 
        margin-top: 25px;
    }

    .wake-time-output {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--purple-accent); /* Purple accent */
    }

    .result-alert {
        white-space: pre-wrap;
        border-left: 5px solid var(--purple-accent);
        background-color: #f3e5f5; /* Lightest purple */
    }
    
    .cycle-highlight {
        font-weight: 700;
        color: #1a7e2e; /* Darker green */
        font-size: 1.1rem;
    }

    .table-success {
        background-color: #e8f5e9 !important; /* Light green for best cycles */
    }
    
    .bedtime-label {
        font-weight: 600;
        color: #383e4a;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center">
        <h1 class="fw-bolder mb-2 fs-2">ðŸ›Œ Sleep Cycle Calculator (Wake-up Time)</h1>
        <p class="text-secondary mb-4">
            Find the ideal time to **wake up** feeling refreshed by planning your sleep around full **90-minute sleep cycles**.
        </p>
    </div>

    <div class="calc-wrapper">

        <form id="sleep-form">
            <h5 class="section-title">Step 1: When Do You Go to Bed?</h5>

            <label class="form-label d-block mt-3 bedtime-label">
                Bedtime (Time you close your eyes)
            </label>
            <div class="row g-3">
                <div class="col-6">
                    <select class="form-select" id="bedtime_h" required>
                        </select>
                    <small class="form-text text-muted">Hour</small>
                </div>
                <div class="col-6">
                    <select class="form-select" id="bedtime_m" required>
                        <option value="0">00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                    <small class="form-text text-muted">Minute</small>
                </div>
            </div>
            
            <h5 class="section-title mt-4">Step 2: Calculate</h5>
            
            <p class="small text-muted mb-3">
                *Calculation includes a **14-minute average** time for you to fall asleep (sleep latency).*
            </p>

            <button class="btn btn-success btn-lg w-100 mt-3 fw-bold" type="submit">
                Suggest Optimal Wake-up Times
            </button>
        </form>

        <div class="alert mt-4 d-none" id="sleep-result"></div>

        <h5 class="section-title d-none" id="table-title">Optimal Wake-up Times (90-Minute Cycles)</h5>
        <table class="table table-bordered table-striped mt-3 d-none" id="sleep-table">
            <thead class="table-dark">
                <tr>
                    <th>Sleep Cycles</th>
                    <th>Total Sleep Time</th>
                    <th>Optimal Wake-up Time</th>
                </tr>
            </thead>
            <tbody id="sleep-body"></tbody>
        </table>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    const SLEEP_CYCLE_MINUTES = 90;
    const SLEEP_LATENCY_MINUTES = 14; 
    
    const CYCLE_COUNTS = [
        { cycles: 6, ideal: true }, 
        { cycles: 5, ideal: true },
        { cycles: 4, ideal: true },
        { cycles: 3, ideal: false } 
    ];

    /**
     * Generates and inserts the hour options into the select box.
     */
    function populateTimeOptions() {
        const select = document.getElementById('bedtime_h');
        let optionsHtml = '';
        const defaultHour = 22; // 10 PM

        for (let h = 0; h < 24; h++) {
            const displayHour = h % 12 || 12;
            const ampm = h < 12 ? 'AM' : 'PM';
            const selected = (h === defaultHour) ? 'selected' : '';
            
            // Format 12 AM / 12 PM clearly
            let displayString;
            if (h === 0) displayString = '12 AM (Midnight)';
            else if (h === 12) displayString = '12 PM (Noon)';
            else displayString = `${displayHour} ${ampm}`;

            optionsHtml += `<option value="${h}" ${selected}>${displayString}</option>`;
        }
        select.innerHTML = optionsHtml;
    }

    /**
     * Converts total minutes from midnight into a formatted HH:MM AM/PM string.
     */
    function timeToHHMM(totalMinutes) {
        const normalizedMinutes = totalMinutes % 1440;
        
        const hours = Math.floor(normalizedMinutes / 60);
        const minutes = Math.round(normalizedMinutes % 60);

        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHour = hours % 12 || 12;
        const displayMinute = minutes.toString().padStart(2, '0');
        
        return `${displayHour}:${displayMinute} ${ampm}`;
    }
    
    document.getElementById('sleep-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const bedtime_h = parseInt(document.getElementById('bedtime_h').value);
        const bedtime_m = parseInt(document.getElementById('bedtime_m').value);

        // 2. Convert Bedtime to Total Minutes from Midnight (00:00)
        const bedtime_minutes_total = (bedtime_h * 60) + bedtime_m;

        // 3. Calculate Sleep Start Time (after latency)
        const sleep_start_minutes = bedtime_minutes_total + SLEEP_LATENCY_MINUTES;

        // 4. Calculate Optimal Wake-up Times
        const results = [];

        CYCLE_COUNTS.forEach(cycleInfo => {
            const total_sleep_duration_minutes = cycleInfo.cycles * SLEEP_CYCLE_MINUTES;
            
            const wake_up_minutes_total = sleep_start_minutes + total_sleep_duration_minutes;
            
            const wake_up_time_formatted = timeToHHMM(wake_up_minutes_total);
            
            // Format total sleep hours for display (e.g., 7h 30m)
            const sleep_h = Math.floor(total_sleep_duration_minutes / 60);
            const sleep_m = total_sleep_duration_minutes % 60;
            const total_sleep_formatted = `${sleep_h}h ${sleep_m}m`;

            results.push({
                ...cycleInfo,
                wake_time: wake_up_time_formatted,
                total_sleep: total_sleep_formatted
            });
        });

        // 5. Update Result Display
        const res = document.getElementById('sleep-result');
        res.classList.remove('d-none', 'alert-danger', 'alert-success');
        res.classList.add('alert-info', 'result-alert');
        
        const bestResult = results.find(r => r.cycles === 6) || results.find(r => r.cycles === 5);
        const bestWakeTime = bestResult.wake_time;
        
        const bedtimeFormatted = timeToHHMM(bedtime_minutes_total);

        res.innerHTML = `
**If you close your eyes at ${bedtimeFormatted}...**

Your estimated time to fall asleep (14 minutes) is **${timeToHHMM(sleep_start_minutes)}**.
---
**Your Best Suggested Wake-up Time is:** <span class="wake-time-output">${bestWakeTime}</span> (This aligns with **${bestResult.cycles}** full 90-minute cycles.)
`;
        
        // 6. Update Table
        document.getElementById('table-title').classList.remove('d-none');
        document.getElementById('sleep-table').classList.remove('d-none');
        const tableBody = document.getElementById('sleep-body');
        tableBody.innerHTML = ''; // Clear previous results

        results.forEach(r => {
            const highlightClass = r.ideal ? 'cycle-highlight' : '';
            const isBest = r.cycles === bestResult.cycles; 
            const rowClass = isBest ? 'table-success' : '';

            tableBody.innerHTML += `
            <tr class="${rowClass}">
                <td class="${highlightClass}">${r.cycles} Cycles</td>
                <td>${r.total_sleep}</td>
                <td class="wake-time-output">${r.wake_time}</td>
            </tr>
            `;
        });
    });

    
    window.onload = function() {
        // Fix: Only populate the select box on load. 
        // DO NOT trigger the form submission, which was causing the premature calculation.
        populateTimeOptions();
    };
</script>

{% endblock %}