{% extends "base.html" %}

{% block title %}Macronutrient (Macros) Calculator{% endblock %}

{% block meta_description %}Calculate your optimal daily macronutrient intake (Protein, Carbs, Fat in grams) based on your TDEE and fitness goals, using the Mifflin-St Jeor formula.{% endblock %}

{% block meta_keywords %}macro calculator, macronutrient ratios, protein, carbs, fat, daily goals, fitness nutrition, TDEE{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    canvas {
        margin-top: 20px;
    }

    .result-alert {
        white-space: pre-wrap;
    }

    .gender-group {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }
    
    .macro-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    .macro-input-group label {
        flex-basis: 30%;
    }
    
    .macro-input-group input {
        flex-grow: 1;
        text-align: right;
    }
    
    .macro-input-group span {
        width: 30px;
        text-align: left;
    }

    .macro-summary td:last-child {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">ðŸ“Š Macronutrient (Macros) Calculator</h1>
    <p class="small-muted">Calculate the exact **grams** of Protein, Carbohydrates, and Fat you need daily based on your estimated **TDEE** and your chosen macro ratios.</p>

    <div class="calc-wrapper mt-4">

        <form id="macro-form">
            <h5 class="section-title">Step 1: Calorie Target & Activity</h5>
            <small class="form-text text-muted mb-3 d-block">This calculator first determines your TDEE and then applies your target. You can use your TDEE for maintenance, or subtract a deficit/add a surplus based on your goal.</small>

            <!-- Daily Calorie Target Input -->
            <input type="number" class="form-control my-2" id="daily_calorie_target" placeholder="Daily Calorie Target (e.g., 2000)" min="1000" max="5000" step="100" required>

            <!-- Gender Input -->
            <div class="form-group mb-3">
                <label class="form-label d-block">Gender</label>
                <div class="gender-group">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" required>
                        <label class="form-check-label" for="genderMale">Male</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" required>
                        <label class="form-check-label" for="genderFemale">Female</label>
                    </div>
                </div>
            </div>

            <!-- Age Input -->
            <input type="number" class="form-control my-2" id="age" placeholder="Age (Years)" min="15" max="100" required>

            <!-- Weight Input -->
            <div class="input-group my-2">
                <input type="number" class="form-control" id="weight_lb" placeholder="Weight (e.g., 180)" min="50" max="800" step="0.1" required>
                <span class="input-group-text">lbs</span>
            </div>

            <!-- Height Input (Feet and Inches) -->
            <label class="form-label d-block mt-3">Height</label>
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_ft" placeholder="Feet (e.g., 5)" min="3" max="7" required>
                        <span class="input-group-text">ft</span>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_in" placeholder="Inches (e.g., 10)" min="0" max="11" required>
                        <span class="input-group-text">in</span>
                    </div>
                </div>
            </div>

            <!-- Activity Level Input (Needed for TDEE context/BMR check) -->
            <div class="form-group my-3">
                <label for="activity_level" class="form-label">Select Your Average Activity Level</label>
                <select class="form-select" id="activity_level" required>
                    <option value="" disabled selected>Choose your level</option>
                    <option value="1.2">Sedentary</option>
                    <option value="1.375">Lightly Active</option>
                    <option value="1.55">Moderately Active</option>
                    <option value="1.725">Very Active</option>
                    <option value="1.9">Extra Active</option>
                </select>
            </div>


            <h5 class="section-title mt-4">Step 2: Define Macro Ratios (Must total 100%)</h5>
            
            <div class="macro-input-group">
                <label for="protein_pct">Protein</label>
                <input type="number" class="form-control" id="protein_pct" value="30" min="0" max="100" required>
                <span>%</span>
            </div>

            <div class="macro-input-group">
                <label for="carb_pct">Carbohydrates</label>
                <input type="number" class="form-control" id="carb_pct" value="40" min="0" max="100" required>
                <span>%</span>
            </div>
            
            <div class="macro-input-group">
                <label for="fat_pct">Fat</label>
                <input type="number" class="form-control" id="fat_pct" value="30" min="0" max="100" required>
                <span>%</span>
            </div>

            <button class="btn btn-primary mt-3" type="submit">Calculate Daily Macros</button>
        </form>

        <div class="alert alert-info mt-4 d-none result-alert" id="macro-result"></div>

        <h5 class="section-title d-none" id="table-title">Daily Macronutrient Targets</h5>
        <table class="table table-bordered mt-2 d-none macro-summary" id="macro-table">
            <thead>
                <tr>
                    <th>Macronutrient</th>
                    <th>Calories (kcal)</th>
                    <th>Grams (g)</th>
                </tr>
            </thead>
            <tbody id="macro-body"></tbody>
        </table>

        <canvas id="macro-chart" class="d-none"></canvas>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let macroChart = null;
    
    // Caloric densities
    const KCAL_PER_GRAM_PROTEIN = 4;
    const KCAL_PER_GRAM_CARB = 4;
    const KCAL_PER_GRAM_FAT = 9;

    document.getElementById('macro-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const targetCalories = parseFloat(document.getElementById('daily_calorie_target').value);
        const proteinPct = parseFloat(document.getElementById('protein_pct').value);
        const carbPct = parseFloat(document.getElementById('carb_pct').value);
        const fatPct = parseFloat(document.getElementById('fat_pct').value);
        
        // TDEE/BMR Inputs (for informational/validation purposes)
        const age = parseFloat(document.getElementById('age').value);
        const weight_lb = parseFloat(document.getElementById('weight_lb').value);
        const height_ft = parseFloat(document.getElementById('height_ft').value);
        const height_in = parseFloat(document.getElementById('height_in').value);
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const selected_multiplier = parseFloat(document.getElementById('activity_level').value);

        // 2. Validation Check
        const totalPct = proteinPct + carbPct + fatPct;
        if (totalPct !== 100) {
            const res = document.getElementById('macro-result');
            res.classList.remove('d-none', 'alert-info');
            res.classList.add('alert-danger');
            res.innerHTML = `**Error:** Your macro percentages must total 100%. They currently total ${totalPct}%. Please adjust the values.`;
            document.getElementById('macro-table').classList.add('d-none');
            document.getElementById('macro-chart').classList.add('d-none');
            return;
        }

        // 3. TDEE/BMR Calculation (for context display)
        const weight_kg = weight_lb * 0.453592;
        const height_cm = (height_ft * 30.48) + (height_in * 2.54);
        let BMR;
        if (gender === 'male') {
            BMR = (10 * weight_kg) + (6.25 * height_cm) - (5 * age) + 5;
        } else {
            BMR = (10 * weight_kg) + (6.25 * height_cm) - (5 * age) - 161;
        }
        const TDEE = BMR * selected_multiplier;

        // 4. Calculate Calories per Macro
        const proteinKcal = targetCalories * (proteinPct / 100);
        const carbKcal = targetCalories * (carbPct / 100);
        const fatKcal = targetCalories * (fatPct / 100);

        // 5. Calculate Grams per Macro
        const proteinGrams = proteinKcal / KCAL_PER_GRAM_PROTEIN;
        const carbGrams = carbKcal / KCAL_PER_GRAM_CARB;
        const fatGrams = fatKcal / KCAL_PER_GRAM_FAT;
        
        // 6. Round Results
        const results = [
            { name: 'Protein', pct: proteinPct, kcal: proteinKcal.toFixed(0), grams: proteinGrams.toFixed(0), color: '#ff6384' },
            { name: 'Carbohydrates', pct: carbPct, kcal: carbKcal.toFixed(0), grams: carbGrams.toFixed(0), color: '#4bc0c0' },
            { name: 'Fat', pct: fatPct, kcal: fatKcal.toFixed(0), grams: fatGrams.toFixed(0), color: '#ff9f40' }
        ];

        // 7. Update Result Text Display (Context and Summary)
        const res = document.getElementById('macro-result');
        res.classList.remove('d-none', 'alert-danger');
        res.classList.add('alert-info');
        res.innerHTML = `
**Daily Calorie Target:** ${targetCalories.toFixed(0)} kcal
**Estimated Maintenance TDEE:** ${TDEE.toFixed(0)} kcal
**Selected Ratios (P/C/F):** ${proteinPct}% / ${carbPct}% / ${fatPct}%

---

**Daily Macro Target in Grams:**
Protein: ${results[0].grams}g | Carbs: ${results[1].grams}g | Fat: ${results[2].grams}g
`;
        
        // 8. Update Table
        document.getElementById('table-title').classList.remove('d-none');
        document.getElementById('macro-table').classList.remove('d-none');
        const tableBody = document.getElementById('macro-body');
        tableBody.innerHTML = ''; // Clear previous results

        results.forEach(macro => {
            tableBody.innerHTML += `
            <tr>
                <td>${macro.name} (${macro.pct}%)</td>
                <td>${macro.kcal}</td>
                <td>${macro.grams}</td>
            </tr>
            `;
        });
        
        // 9. Update Chart
        const ctx = document.getElementById('macro-chart').getContext('2d');
        document.getElementById('macro-chart').classList.remove('d-none');
        if (macroChart) macroChart.destroy();

        macroChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: results.map(r => `${r.name} (${r.pct}%)`),
                datasets: [{
                    data: results.map(r => r.kcal),
                    backgroundColor: results.map(r => r.color),
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: `Daily Calorie Breakdown by Macro (Total: ${targetCalories.toFixed(0)} kcal)` }
                }
            }
        });
    });
</script>

{% endblock %}