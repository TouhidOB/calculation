{% extends "base.html" %}

{% block title %}Pregnancy Weight Gain Calculator{% endblock %}

{% block meta_description %}Calculate the recommended weight gain range for your pregnancy based on your pre-pregnancy BMI and current gestational week, following IOM guidelines.{% endblock %}

{% block meta_keywords %}pregnancy weight gain, weight gain guidelines, pre-pregnancy BMI, gestational week, IOM guidelines, healthy pregnancy weight{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    .result-alert {
        white-space: pre-wrap;
    }

    .weight-output {
        font-size: 2rem;
        font-weight: bold;
        color: #ff69b4; /* Pink/Rose color */
    }

    .unit-label {
        font-size: 1rem;
        color: #6c757d;
    }
    
    .bmi-info {
        font-weight: bold;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">ðŸ¤° Pregnancy Weight Gain Calculator</h1>
    <p class="small-muted">Determine your recommended total **Weight Gain Range** and ideal weekly gain rate based on your **pre-pregnancy BMI**, according to Institute of Medicine (IOM) guidelines.</p>

    <div class="calc-wrapper mt-4">

        <form id="weight-gain-form">
            <h5 class="section-title">Step 1: Pre-Pregnancy Metrics</h5>

            <label class="form-label d-block mt-3">Pre-Pregnancy Height</label>
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_ft" placeholder="Feet (e.g., 5)" min="3" max="7" required>
                        <span class="input-group-text">ft</span>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_in" placeholder="Inches (e.g., 5)" min="0" max="11" required>
                        <span class="input-group-text">in</span>
                    </div>
                </div>
            </div>

            <div class="input-group my-3">
                <input type="number" class="form-control" id="pre_pregnancy_weight_lb" placeholder="Pre-Pregnancy Weight" min="80" max="400" step="1" required>
                <span class="input-group-text">lbs</span>
            </div>
            
            <h5 class="section-title mt-4">Step 2: Current Pregnancy Status</h5>

            <div class="input-group my-3">
                <input type="number" class="form-control" id="current_week" placeholder="Current Week of Pregnancy (1-40)" min="1" max="40" required>
                <span class="input-group-text">weeks</span>
            </div>

            <button class="btn btn-primary mt-4" type="submit">Calculate Recommendations</button>
        </form>

        <div class="alert alert-info mt-4 d-none result-alert" id="gain-result"></div>

        <h5 class="section-title d-none" id="table-title">Weight Gain Guidelines (IOM)</h5>
        <table class="table table-bordered mt-2 d-none" id="guideline-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Recommendation</th>
                </tr>
            </thead>
            <tbody id="guideline-body"></tbody>
        </table>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const KG_PER_LB = 0.453592;
    const METERS_PER_INCH = 0.0254;

    // IOM Guidelines (Weight Gain in Lbs)
    const IOM_GUIDELINES = {
        underweight: {
            bmi_range: '< 18.5', 
            total_min: 28, total_max: 40,
            weekly_rate: 1.0, // lbs/week in 2nd/3rd trimester
            category: 'Underweight'
        },
        normal: {
            bmi_range: '18.5 - 24.9', 
            total_min: 25, total_max: 35,
            weekly_rate: 1.0,
            category: 'Normal Weight'
        },
        overweight: {
            bmi_range: '25.0 - 29.9', 
            total_min: 15, total_max: 25,
            weekly_rate: 0.6,
            category: 'Overweight'
        },
        obese: {
            bmi_range: 'â‰¥ 30.0', 
            total_min: 11, total_max: 20,
            weekly_rate: 0.5,
            category: 'Obese'
        }
    };

    function calculateBMI(weight_lb, height_ft, height_in) {
        const total_height_in = (height_ft * 12) + height_in;
        const total_height_m = total_height_in * METERS_PER_INCH;
        const weight_kg = weight_lb * KG_PER_LB;
        
        return weight_kg / (total_height_m * total_height_m);
    }
    
    function getBMICategory(bmi) {
        if (bmi < 18.5) return IOM_GUIDELINES.underweight;
        if (bmi < 25.0) return IOM_GUIDELINES.normal;
        if (bmi < 30.0) return IOM_GUIDELINES.overweight;
        return IOM_GUIDELINES.obese;
    }

    document.getElementById('weight-gain-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const weight_lb = parseFloat(document.getElementById('pre_pregnancy_weight_lb').value);
        const height_ft = parseFloat(document.getElementById('height_ft').value);
        const height_in = parseFloat(document.getElementById('height_in').value);
        const current_week = parseInt(document.getElementById('current_week').value);

        // 2. Calculate Pre-Pregnancy BMI
        const bmi = calculateBMI(weight_lb, height_ft, height_in);
        const category = getBMICategory(bmi);

        // 3. Calculate Recommended Target Gain
        const total_min_gain = category.total_min;
        const total_max_gain = category.total_max;
        
        // 4. Calculate Current Recommended Gain (Approximate)
        // Gain is usually minimal in the first trimester (Weeks 1-13).
        const first_trimester_weeks = 13;
        const second_trimester_start = 14;
        const weeks_gained_since_T2 = Math.max(0, current_week - second_trimester_start);
        
        // The minimal recommended gain in T1 is usually 1-4 lbs, we use 3 lbs average for calculation
        const t1_gain_avg = 3; 

        let recommended_current_gain_approx;

        if (current_week <= first_trimester_weeks) {
            // First trimester gain is highly variable, use general T1 min-max
            recommended_current_gain_approx = `Approx. ${t1_gain_avg} lbs`; // Simple representation
        } else {
            // After T1, calculate T1 gain + weekly rate * weeks since T2 started
            const current_min_gain = t1_gain_avg + (weeks_gained_since_T2 * category.weekly_rate * 0.7); // *0.7 to skew toward lower estimate
            const current_max_gain = 5 + (weeks_gained_since_T2 * category.weekly_rate * 1.3); // *1.3 to skew toward higher estimate

            recommended_current_gain_approx = `${current_min_gain.toFixed(1)} - ${current_max_gain.toFixed(1)} lbs`;
        }

        // 5. Update Result Display
        const bmi_rounded = bmi.toFixed(1);
        
        const res = document.getElementById('gain-result');
        res.classList.remove('d-none', 'alert-danger');
        res.classList.add('alert-info');
        res.innerHTML = `
**Pre-Pregnancy BMI:** <span class="bmi-info">${bmi_rounded} (${category.category})</span>
**Current Gestational Week:** ${current_week} weeks
---

**Total Recommended Weight Gain Range (by Week 40):** <span class="weight-output">${total_min_gain} - ${total_max_gain} <span class="unit-label">lbs</span></span>

*Recommended Current Gain (${current_week} Weeks): ${recommended_current_gain_approx}*
`;
        
        // 6. Update Guideline Table
        document.getElementById('table-title').classList.remove('d-none');
        document.getElementById('guideline-table').classList.remove('d-none');
        
        const tableBody = document.getElementById('guideline-body');
        tableBody.innerHTML = `
        <tr class="table-primary">
            <td>**Your BMI Category**</td>
            <td>**${category.category}**</td>
        </tr>
        <tr>
            <td>BMI Range for Category</td>
            <td>${category.bmi_range}</td>
        </tr>
        <tr>
            <td>Total Gain Goal (lbs)</td>
            <td>${total_min_gain} - ${total_max_gain}</td>
        </tr>
        <tr>
            <td>Recommended Weekly Gain (T2 & T3)</td>
            <td>${category.weekly_rate.toFixed(1)} lbs/week</td>
        </tr>
        `;
    });

    function displayError(message) {
        const res = document.getElementById('gain-result');
        res.classList.remove('d-none', 'alert-info');
        res.classList.add('alert-danger');
        res.innerHTML = `**Calculation Error:** ${message}`;
        document.getElementById('table-title').classList.add('d-none');
        document.getElementById('guideline-table').classList.add('d-none');
    }
</script>

{% endblock %}