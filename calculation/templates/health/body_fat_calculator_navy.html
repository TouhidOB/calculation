{% extends "base.html" %}

{% block title %}Body Fat Percentage Calculator (US Navy Method){% endblock %}

{% block meta_description %}Estimate your body fat percentage using the US Navy method, requiring height, neck, waist, and hip (for females) measurements.{% endblock %}

{% block meta_keywords %}body fat calculator, navy method, body composition, BFP, lean body mass, fitness measurement{% endblock %}

{% block extra_head %}
<style>
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-weight: bold;
        margin-top: 20px;
    }

    canvas {
        margin-top: 20px;
    }

    .result-alert {
        white-space: pre-wrap;
    }

    .gender-group {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">âš“ Body Fat Percentage Calculator (Navy Method)</h1>
    <p class="small-muted">Estimate your **Body Fat Percentage (BFP)** and calculate **Lean Body Mass (LBM)** using the standard US Navy formula, based on circumference measurements.</p>

    <div class="calc-wrapper mt-4">

        <form id="bfp-form">
            <h5 class="section-title">Step 1: Personal Inputs</h5>

            <!-- Gender Input -->
            <div class="form-group mb-3">
                <label class="form-label d-block">Gender</label>
                <div class="gender-group">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" required>
                        <label class="form-check-label" for="genderMale">Male</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female" required>
                        <label class="form-check-label" for="genderFemale">Female</label>
                    </div>
                </div>
            </div>

            <!-- Height Input (Feet and Inches) -->
            <label class="form-label d-block mt-3">Height</label>
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_ft" placeholder="Feet (e.g., 5)" min="3" max="7" required>
                        <span class="input-group-text">ft</span>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group">
                        <input type="number" class="form-control" id="height_in" placeholder="Inches (e.g., 10)" min="0" max="11" required>
                        <span class="input-group-text">in</span>
                    </div>
                </div>
            </div>
            
            <!-- Weight Input -->
            <div class="input-group my-3">
                <input type="number" class="form-control" id="weight_lb" placeholder="Body Weight (e.g., 180)" min="50" max="800" step="0.1" required>
                <span class="input-group-text">lbs</span>
            </div>

            <h5 class="section-title mt-4">Step 2: Circumference Measurements (Inches)</h5>

            <!-- Neck Input -->
            <div class="input-group my-2">
                <input type="number" class="form-control" id="neck_in" placeholder="Neck Circumference (in)" min="10" max="30" step="0.1" required>
                <span class="input-group-text">in</span>
            </div>

            <!-- Waist Input (Abdomen) -->
            <div class="input-group my-2">
                <input type="number" class="form-control" id="waist_in" placeholder="Waist/Abdomen Circumference (in)" min="20" max="60" step="0.1" required>
                <span class="input-group-text">in</span>
            </div>

            <!-- Hips Input (Female Only) -->
            <div class="input-group my-2" id="hips-input-group">
                <input type="number" class="form-control" id="hips_in" placeholder="Hip Circumference (in)" min="20" max="60" step="0.1">
                <span class="input-group-text">in</span>
            </div>

            <button class="btn btn-primary mt-3" type="submit">Calculate Body Fat %</button>
        </form>

        <div class="alert mt-4 d-none result-alert" id="bfp-result"></div>

        <h5 class="section-title d-none" id="table-title">Body Composition Summary</h5>
        <table class="table table-bordered mt-2 d-none" id="bfp-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="bfp-body"></tbody>
        </table>

        <canvas id="bfp-chart" class="d-none"></canvas>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let bfpChart = null;

    // Classification standards (simplified for age 35 and under)
    const BFP_CATEGORIES = {
        male: [
            { max: 6, label: 'Essential Fat', color: '#ff6384' },
            { max: 13, label: 'Athletic', color: '#4bc0c0' },
            { max: 17, label: 'Fitness', color: '#ff9f40' },
            { max: 24, label: 'Acceptable', color: '#36a2eb' },
            { max: 100, label: 'Obese', color: '#ff6384' }
        ],
        female: [
            { max: 14, label: 'Essential Fat', color: '#ff6384' },
            { max: 20, label: 'Athletic', color: '#4bc0c0' },
            { max: 24, label: 'Fitness', color: '#ff9f40' },
            { max: 31, label: 'Acceptable', color: '#36a2eb' },
            { max: 100, label: 'Obese', color: '#ff6384' }
        ]
    };

    function getCategory(bfp, gender) {
        const categories = BFP_CATEGORIES[gender] || BFP_CATEGORIES.male;
        for (const cat of categories) {
            if (bfp <= cat.max) {
                return cat;
            }
        }
        return categories[categories.length - 1]; // Fallback to Obese
    }

    function toggleHipsInput() {
        const genderMale = document.getElementById('genderMale').checked;
        const hipsGroup = document.getElementById('hips-input-group');
        const hipsInput = document.getElementById('hips_in');

        if (genderMale) {
            hipsGroup.style.display = 'none';
            hipsInput.removeAttribute('required');
            hipsInput.value = ''; // Clear value when hidden
        } else {
            hipsGroup.style.display = 'flex';
            hipsInput.setAttribute('required', true);
        }
    }

    document.querySelectorAll('input[name="gender"]').forEach(input => {
        input.addEventListener('change', toggleHipsInput);
    });
    // Run once on load to set initial state
    window.onload = toggleHipsInput;


    document.getElementById('bfp-form').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Get Inputs
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const height_ft = parseFloat(document.getElementById('height_ft').value);
        const height_in = parseFloat(document.getElementById('height_in').value);
        const weight_lb = parseFloat(document.getElementById('weight_lb').value);
        const neck_in = parseFloat(document.getElementById('neck_in').value);
        const waist_in = parseFloat(document.getElementById('waist_in').value);
        const hips_in = gender === 'female' ? parseFloat(document.getElementById('hips_in').value) : 0;

        // 2. Unit Conversion (Total height in inches)
        const total_height_in = (height_ft * 12) + height_in;
        let bfp_percent;

        // 3. Apply Navy Body Fat Formula
        if (gender === 'male') {
            const sum_diff = waist_in - neck_in;
            if (sum_diff <= 0) {
                 // Prevent log of negative or zero
                displayError("Waist measurement must be greater than neck measurement for male calculation.");
                return;
            }
            const log_sum_diff = Math.log10(sum_diff);
            const log_height = Math.log10(total_height_in);
            
            const density = 1.0324 - (0.19077 * log_sum_diff) + (0.15456 * log_height);
            bfp_percent = (495 / density) - 450;

        } else { // female
            const sum_diff = waist_in + hips_in - neck_in;
            if (sum_diff <= 0) {
                 // Prevent log of negative or zero
                displayError("Waist + Hips measurement must be greater than neck measurement for female calculation.");
                return;
            }
            const log_sum_diff = Math.log10(sum_diff);
            const log_height = Math.log10(total_height_in);
            
            const density = 1.29579 - (0.35004 * log_sum_diff) + (0.22100 * log_height);
            bfp_percent = (495 / density) - 450;
        }
        
        // 4. Calculate Body Composition
        const fat_mass_lb = (bfp_percent / 100) * weight_lb;
        const lean_body_mass_lb = weight_lb - fat_mass_lb;
        
        // 5. Categorize Result
        const bfp_rounded = Math.max(0, bfp_percent.toFixed(2)); // Ensure no negative results
        const category = getCategory(parseFloat(bfp_rounded), gender);

        // 6. Update Result Display
        const res = document.getElementById('bfp-result');
        res.classList.remove('d-none', 'alert-danger');
        res.classList.add('alert-success');
        res.innerHTML = `
**Body Fat Percentage (BFP):** <span style="font-size:1.5rem; color:${category.color};">${bfp_rounded}%</span>
**Classification:** ${category.label}
---
**Fat Mass (FM):** ${fat_mass_lb.toFixed(1)} lbs
**Lean Body Mass (LBM):** ${lean_body_mass_lb.toFixed(1)} lbs
`;
        
        // 7. Update Table
        document.getElementById('table-title').classList.remove('d-none');
        document.getElementById('bfp-table').classList.remove('d-none');
        const tableBody = document.getElementById('bfp-body');
        tableBody.innerHTML = `
        <tr><td>Body Weight</td><td>${weight_lb.toFixed(1)} lbs</td></tr>
        <tr><td>Body Fat Mass (FM)</td><td>${fat_mass_lb.toFixed(1)} lbs</td></tr>
        <tr><td>Lean Body Mass (LBM)</td><td>${lean_body_mass_lb.toFixed(1)} lbs</td></tr>
        <tr><td>**Body Fat Percentage (BFP)**</td><td>**${bfp_rounded}%**</td></tr>
        `;

        // 8. Update Chart
        const ctx = document.getElementById('bfp-chart').getContext('2d');
        document.getElementById('bfp-chart').classList.remove('d-none');
        if (bfpChart) bfpChart.destroy();

        bfpChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Fat Mass (BFP)', 'Lean Body Mass (LBM)'],
                datasets: [{
                    data: [fat_mass_lb.toFixed(1), lean_body_mass_lb.toFixed(1)],
                    backgroundColor: [
                        category.color, // Color of the classification
                        '#4bc0c0'       // Constant color for LBM
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: `Body Composition Breakdown (Total: ${weight_lb.toFixed(1)} lbs)` }
                }
            }
        });
    });
    
    function displayError(message) {
        const res = document.getElementById('bfp-result');
        res.classList.remove('d-none', 'alert-success');
        res.classList.add('alert-danger');
        res.innerHTML = `**Calculation Error:** ${message}`;
        document.getElementById('bfp-table').classList.add('d-none');
        document.getElementById('bfp-chart').classList.add('d-none');
    }
</script>

{% endblock %}
