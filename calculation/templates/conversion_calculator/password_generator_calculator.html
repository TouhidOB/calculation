{% extends "base.html" %}

{% block title %}Password Generator & Strength Calculator{% endblock %}

{% block meta_description %}Generate strong, random passwords and calculate their security strength based on entropy.{% endblock %}

{% block meta_keywords %}password generator, strength calculator, security, entropy, complex password, random password{% endblock %}

{% block extra_head %}
<style>
    /* Base styles from the template */
    .calc-wrapper {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    .section-title {
        font-weight: 600;
        margin-top: 20px;
        color: #1a1a2e; /* Deep purple/navy for a secure theme */
    }
    
    /* Input Group Styling */
    .input-group-custom {
        margin-bottom: 20px;
        background: #f0f4f9; /* Light blue/gray for control panel */
        border-radius: 8px;
        padding: 15px;
        border: 1px solid #1a1a2e; 
    }
    
    .input-group-custom label {
        font-weight: 500;
        margin-bottom: 5px;
        color: #1a1a2e;
    }

    .output-box {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: monospace;
        font-size: 1.2rem;
        word-break: break-all;
        color: #495057;
        margin-bottom: 15px;
        border: 2px solid #ced4da;
    }
    
    .output-text {
        flex-grow: 1;
        margin-right: 10px;
    }
    
    /* Complexity Options */
    .complexity-options label {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.1s;
    }
    .complexity-options label:hover {
        background-color: #e0e7f1;
    }

    /* Range Slider Styling */
    .range-display {
        font-weight: bold;
        color: #007bff;
    }

    /* Action Buttons */
    .action-button {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        padding: 12px;
        margin-top: 10px;
        border-radius: 8px;
        width: 100%;
        transition: background-color 0.2s;
    }
    .action-button:hover {
        background-color: #0056b3;
    }
    
    .copy-button {
        background-color: #28a745;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
    }
    .copy-button:hover {
        background-color: #1e7e34;
    }

    /* Strength Meter */
    #strengthBar {
        height: 15px;
        border-radius: 7px;
        background-color: #e9ecef;
        margin-bottom: 10px;
        overflow: hidden;
    }
    #strengthFill {
        height: 100%;
        width: 0%;
        transition: width 0.5s ease;
    }
    
    #crackTime {
        font-weight: bold;
        font-size: 1.1rem;
        text-align: center;
        margin-top: 5px;
    }
    
    .strength-section {
        border-top: 1px solid #ced4da;
        padding-top: 20px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-3">ðŸ”’ Secure Password Tool</h1>
    <p class="small-muted">Generate a highly secure password and evaluate the strength of any password input based on complexity (entropy).</p>
    

    <div class="calc-wrapper mt-4">

        <!-- Password Output Box -->
        <h5 class="section-title">Current Password</h5>
        <div class="output-box">
            <span class="output-text" id="generatedPassword">Click "Generate Password"</span>
            <button class="copy-button" onclick="copyPassword()">Copy</button>
        </div>
        
        <!-- Strength Meter -->
        <div id="strengthBar">
            <div id="strengthFill" style="width:0%; background-color:#dc3545;"></div>
        </div>
        <div id="crackTime">Strength: Weak (0 bits of entropy)</div>
        
        <div class="row mt-4">
            
            <!-- Generation Controls -->
            <div class="col-md-6 mb-4">
                <h5 class="section-title">Generator Controls</h5>
                <div class="input-group-custom">
                    
                    <label for="passwordLength">Length: <span class="range-display" id="lengthDisplay">16</span> characters</label>
                    <input type="range" class="form-range" id="passwordLength" min="8" max="32" value="16">

                    <div class="complexity-options mt-3">
                        <label><input type="checkbox" id="includeUppercase" checked> Include Uppercase (A-Z)</label>
                        <label><input type="checkbox" id="includeLowercase" checked> Include Lowercase (a-z)</label>
                        <label><input type="checkbox" id="includeNumbers" checked> Include Numbers (0-9)</label>
                        <label><input type="checkbox" id="includeSymbols" checked> Include Symbols (!@#$%)</label>
                    </div>

                    <button class="btn action-button" onclick="generatePassword()">
                        Generate Password
                    </button>
                </div>
            </div>

            <!-- Strength Calculator -->
            <div class="col-md-6 mb-4">
                <h5 class="section-title">Strength Calculator</h5>
                <div class="input-group-custom">
                    <label for="customPassword">Evaluate Custom Password</label>
                    <input type="text" class="form-control" id="customPassword" placeholder="Enter your password here">
                    
                    <button class="btn action-button" onclick="evaluateCustomPassword()">
                        Evaluate Strength
                    </button>
                    <p class="small-muted mt-2">Evaluation is based on character set size (entropy).</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-5">
        <p class="small-muted">**Entropy Note:** Password strength is measured in bits of entropy. The higher the entropy, the more combinations an attacker has to try, exponentially increasing the time required to crack it. </p>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- CHARACTER SETS ---
    const CHAR_SETS = {
        lowercase: 'abcdefghijklmnopqrstuvwxyz',
        uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
        numbers: '0123456789',
        symbols: '!@#$%^&*()-_+=[]{}|;:,.<>/?~`'
    };
    
    // --- DOM Elements ---
    const generatedPasswordEl = document.getElementById('generatedPassword');
    const lengthInput = document.getElementById('passwordLength');
    const lengthDisplay = document.getElementById('lengthDisplay');
    const customPasswordInput = document.getElementById('customPassword');
    const strengthFillEl = document.getElementById('strengthFill');
    const crackTimeEl = document.getElementById('crackTime');

    // --- GENERATOR LOGIC ---
    
    function updateLengthDisplay() {
        lengthDisplay.textContent = lengthInput.value;
    }

    /**
     * Generates a random, secure password based on user options.
     */
    function generatePassword() {
        const length = parseInt(lengthInput.value, 10);
        const includeUpper = document.getElementById('includeUppercase').checked;
        const includeLower = document.getElementById('includeLowercase').checked;
        const includeNumbers = document.getElementById('includeNumbers').checked;
        const includeSymbols = document.getElementById('includeSymbols').checked;

        let availableChars = '';
        let requiredChars = []; // Ensure at least one of each selected type is included
        
        if (includeLower) {
            availableChars += CHAR_SETS.lowercase;
            requiredChars.push(getRandomChar(CHAR_SETS.lowercase));
        }
        if (includeUpper) {
            availableChars += CHAR_SETS.uppercase;
            requiredChars.push(getRandomChar(CHAR_SETS.uppercase));
        }
        if (includeNumbers) {
            availableChars += CHAR_SETS.numbers;
            requiredChars.push(getRandomChar(CHAR_SETS.numbers));
        }
        if (includeSymbols) {
            availableChars += CHAR_SETS.symbols;
            requiredChars.push(getRandomChar(CHAR_SETS.symbols));
        }

        if (availableChars.length === 0) {
            generatedPasswordEl.textContent = 'Select at least one character type.';
            return;
        }

        let password = requiredChars.join(''); // Start with required characters
        
        // Fill the rest of the password length randomly
        for (let i = password.length; i < length; i++) {
            password += getRandomChar(availableChars);
        }

        // Shuffle the password to ensure required characters are not just at the start
        password = shuffleString(password);
        
        generatedPasswordEl.textContent = password;
        
        // Automatically evaluate the generated password
        calculateStrength(password);
    }
    
    function getRandomChar(charSet) {
        const index = Math.floor(Math.random() * charSet.length);
        return charSet[index];
    }

    function shuffleString(str) {
        const arr = str.split('');
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr.join('');
    }

    // --- STRENGTH CALCULATION LOGIC ---
    
    /**
     * Estimates the size of the character set (N) used in a given password.
     * @param {string} password - The password string.
     * @returns {number} The estimated character set size (N).
     */
    function estimateCharacterSet(password) {
        let characterSetSize = 0;
        
        // Check for common groups
        if (/[a-z]/.test(password)) characterSetSize += 26;
        if (/[A-Z]/.test(password)) characterSetSize += 26;
        if (/\d/.test(password)) characterSetSize += 10;
        // Check for symbols. Use a common, larger set for estimation.
        if (/[^a-zA-Z0-9\s]/.test(password)) characterSetSize += 33; // Common 33-symbol count

        // Ensure minimum size if any characters are present
        return Math.max(characterSetSize, 0); 
    }

    /**
     * Calculates password strength based on entropy (H = L * log2(N)).
     * @param {string} password - The password string.
     */
    function calculateStrength(password) {
        const L = password.length;
        const N = estimateCharacterSet(password);
        
        let entropy = 0; // Entropy in bits
        if (N > 1) {
            entropy = L * (Math.log2(N));
        }

        updateStrengthBar(entropy);
        updateCrackTime(entropy);
    }
    
    /**
     * Converts entropy bits to human-readable crack time.
     * This is a simplified, non-scientific estimate based on a common attack speed.
     * @param {number} entropy - Entropy in bits.
     */
    function updateCrackTime(entropy) {
        const crackSpeed = 10000000000; // 10 Billion guesses per second (a powerful attack)
        const totalCombinations = Math.pow(2, entropy);
        const secondsToCrack = totalCombinations / crackSpeed;
        
        let timeString;
        let strengthText;
        let color;
        
        if (entropy < 40) {
            timeString = 'Instant or Seconds';
            strengthText = 'Very Weak';
            color = '#dc3545'; // Red
        } else if (entropy < 60) {
            timeString = formatTime(secondsToCrack);
            strengthText = 'Weak';
            color = '#ffc107'; // Yellow
        } else if (entropy < 80) {
            timeString = formatTime(secondsToCrack);
            strengthText = 'Moderate';
            color = '#17a2b8'; // Blue
        } else if (entropy < 100) {
            timeString = formatTime(secondsToCrack);
            strengthText = 'Strong';
            color = '#28a745'; // Green
        } else {
            timeString = formatTime(secondsToCrack);
            strengthText = 'Very Strong';
            color = '#1a1a2e'; // Dark Navy/Black
        }
        
        crackTimeEl.innerHTML = `
            Strength: <span style="color: ${color};">${strengthText}</span> (${entropy.toFixed(1)} bits)
            <br>
            Estimated Crack Time: ${timeString}
        `;
    }
    
    function formatTime(seconds) {
        if (seconds < 60) return `${Math.max(1, Math.round(seconds))} seconds`;
        
        const minutes = seconds / 60;
        if (minutes < 60) return `${minutes.toFixed(0)} minutes`;
        
        const hours = minutes / 60;
        if (hours < 24) return `${hours.toFixed(0)} hours`;
        
        const days = hours / 24;
        if (days < 365) return `${days.toFixed(0)} days`;
        
        const years = days / 365.25;
        if (years < 1000) return `${years.toFixed(0)} years`;

        const centuries = years / 100;
        return `${centuries.toFixed(0)} centuries`;
    }

    /**
     * Updates the visual strength bar width and color.
     * Max entropy displayed on the bar is capped around 128 for visualization.
     * @param {number} entropy - Entropy in bits.
     */
    function updateStrengthBar(entropy) {
        const maxEntropy = 128; // Cap for visual scale
        let width = Math.min(100, (entropy / maxEntropy) * 100);
        let color;

        if (entropy < 40) color = '#dc3545';
        else if (entropy < 60) color = '#ffc107';
        else if (entropy < 80) color = '#17a2b8';
        else color = '#28a745';

        strengthFillEl.style.width = `${width}%`;
        strengthFillEl.style.backgroundColor = color;
    }
    
    // --- EVENT HANDLERS ---

    function evaluateCustomPassword() {
        const password = customPasswordInput.value.trim();
        if (password) {
            generatedPasswordEl.textContent = password;
            calculateStrength(password);
        } else {
             generatedPasswordEl.textContent = 'Enter a password to evaluate.';
             updateStrengthBar(0);
             updateCrackTime(0);
        }
    }

    function copyPassword() {
        const password = generatedPasswordEl.textContent;
        if (password && password !== 'Click "Generate Password"') {
            // Use execCommand for broader compatibility in sandboxed environments
            const tempInput = document.createElement('textarea');
            tempInput.value = password;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            // Provide visual feedback
            const originalText = generatedPasswordEl.textContent;
            generatedPasswordEl.textContent = 'COPIED TO CLIPBOARD!';
            setTimeout(() => {
                generatedPasswordEl.textContent = originalText;
            }, 1000);
        }
    }
    
    // --- Initialization ---
    window.onload = function() {
        lengthInput.addEventListener('input', updateLengthDisplay);
        customPasswordInput.addEventListener('input', () => {
             // Reset the generated password output when user starts typing in custom input
             generatedPasswordEl.textContent = customPasswordInput.value;
             // Live evaluate the custom password
             evaluateCustomPassword();
        });
        
        // Generate a starting password on load
        generatePassword(); 
    };

</script>
{% endblock %}