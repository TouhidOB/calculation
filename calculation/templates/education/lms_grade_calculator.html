{% extends "base.html" %}

{% block title %}LMS Grade Calculator{% endblock %}

{% block meta_description %}Calculate your current course grade and determine necessary scores to achieve your target final grade using weighted categories.{% endblock %}

{% block meta_keywords %}grade calculator, weighted average, final grade estimator, academic tracker, course management, GPA calculation{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    :root {
        --bs-primary-rgb: 14, 165, 233;
    }
    
    body {
        background-color: #f8fafc;
    }

    .calc-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    .grade-display {
        font-size: 3.5rem;
        font-weight: 800;
        letter-spacing: -2px;
        line-height: 1;
    }

    .category-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 5px solid #0ea5e9;
    }

    .category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .input-group-text {
        background-color: #f1f5f9;
        font-weight: 600;
        color: #64748b;
    }

    /* Remove arrows from number inputs */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .empty-state-icon {
        font-size: 4rem;
        color: #e2e8f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark"><i class="bi bi-mortarboard-fill text-primary me-2"></i>LMS Grade Calculator</h1>
        <p class="text-muted mx-auto" style="max-width: 600px;">
            Professional academic planning tool. Define your course weights and track exactly what you need to hit your target GPA.
        </p>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="calc-card p-4 mb-4">
                <h5 class="fw-bold mb-4 border-bottom pb-2">Grade Summary</h5>
                
                <div class="text-center py-4 bg-light rounded-4 mb-4">
                    <span class="text-uppercase small fw-bold text-muted d-block mb-1">Current Grade</span>
                    <div id="current-grade" class="grade-display text-primary">--</div>
                </div>

                <div class="mb-4">
                    <label class="form-label small fw-bold text-uppercase">Target Final Grade (%)</label>
                    <div class="input-group input-group-lg">
                        <input type="number" id="target-grade" class="form-control text-center fw-bold" value="90" oninput="calculateAll()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>

                <div class="p-3 bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3 text-center">
                    <span class="text-uppercase x-small fw-bold text-warning-emphasis d-block mb-1">Needed Average</span>
                    <div id="needed-score" class="h2 fw-bold text-warning-emphasis m-0">--</div>
                    <p id="target-message" class="x-small text-muted mt-2 mb-0">Define 100% weighting to see result.</p>
                </div>
            </div>

            <div id="weight-alert" class="alert alert-danger d-none border-0 shadow-sm small">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Weights must sum to 100%. Current: <span id="weight-sum">0</span>%
            </div>
            
            <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="addCategory()">
                <i class="bi bi-plus-circle-fill me-2"></i>Add Category
            </button>
        </div>

        <div class="col-lg-8">
            <div id="setup-view" class="calc-card p-5 text-center">
                <div class="empty-state-icon mb-3"><i class="bi bi-folder-plus"></i></div>
                <h4 class="fw-bold">No Categories Defined</h4>
                <p class="text-muted">Start by adding a category like "Exams" or "Homework" to begin your calculation.</p>
                <button class="btn btn-outline-primary px-4" onclick="addCategory()">Add Your First Category</button>
            </div>

            <div id="main-view" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0 text-uppercase small text-secondary">Course Breakdown</h5>
                    <span class="badge bg-info text-dark" id="category-count">0 Categories</span>
                </div>
                <div id="category-list">
                    </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let categories = [];

    function addCategory() {
        const id = Date.now();
        categories.push({
            id: id,
            name: "New Category",
            weight: 0,
            assignments: [{ name: "Assignment 1", score: 0, outOf: 100 }]
        });
        document.getElementById('setup-view').classList.add('d-none');
        document.getElementById('main-view').classList.remove('d-none');
        render();
    }

    function removeCategory(id) {
        categories = categories.filter(c => c.id !== id);
        if (categories.length === 0) {
            document.getElementById('setup-view').classList.remove('d-none');
            document.getElementById('main-view').classList.add('d-none');
        }
        render();
    }

    function addAssignment(catId) {
        const cat = categories.find(c => c.id === catId);
        cat.assignments.push({ name: `Assignment ${cat.assignments.length + 1}`, score: 0, outOf: 100 });
        render();
    }

    function removeAssignment(catId, index) {
        const cat = categories.find(c => c.id === catId);
        cat.assignments.splice(index, 1);
        render();
    }

    function updateCategory(id, field, value) {
        const cat = categories.find(c => c.id === id);
        cat[field] = field === 'weight' ? parseFloat(value) || 0 : value;
        calculateAll();
    }

    function updateAssignment(catId, index, field, value) {
        const cat = categories.find(c => c.id === catId);
        cat.assignments[index][field] = field === 'name' ? value : parseFloat(value) || 0;
        calculateAll();
    }

    function calculateAll() {
        let totalWeightedScore = 0;
        let completedWeight = 0;
        let totalWeight = 0;

        categories.forEach(cat => {
            totalWeight += cat.weight;
            let catPoints = 0;
            let catPossible = 0;
            
            cat.assignments.forEach(a => {
                if (a.outOf > 0) {
                    catPoints += a.score;
                    catPossible += a.outOf;
                }
            });

            const catAvg = catPossible > 0 ? (catPoints / catPossible) * 100 : null;
            
            // Update UI element for cat average if it exists
            const avgDisplay = document.getElementById(`avg-${cat.id}`);
            if (avgDisplay) avgDisplay.textContent = catAvg !== null ? catAvg.toFixed(1) + '%' : '--';

            if (catAvg !== null) {
                totalWeightedScore += (catAvg / 100) * cat.weight;
                completedWeight += cat.weight;
            }
        });

        // Current Grade Calculation
        const currentGrade = completedWeight > 0 ? (totalWeightedScore / completedWeight) * 100 : 0;
        document.getElementById('current-grade').textContent = currentGrade > 0 ? currentGrade.toFixed(1) + '%' : '--';

        // Needed Score Calculation
        const target = parseFloat(document.getElementById('target-grade').value) || 0;
        const weightSumDisplay = document.getElementById('weight-sum');
        const weightAlert = document.getElementById('weight-alert');
        const neededDisplay = document.getElementById('needed-score');
        const messageDisplay = document.getElementById('target-message');

        weightSumDisplay.textContent = totalWeight;
        
        if (Math.abs(totalWeight - 100) > 0.1) {
            weightAlert.classList.remove('d-none');
            neededDisplay.textContent = "--";
            messageDisplay.textContent = "Adjust weights to 100% to calculate.";
        } else {
            weightAlert.classList.add('d-none');
            const remainingWeight = 100 - completedWeight;
            
            if (remainingWeight <= 0) {
                neededDisplay.textContent = "DONE";
                messageDisplay.textContent = "All weighted tasks complete.";
            } else {
                const needed = (target - totalWeightedScore) / (remainingWeight / 100);
                neededDisplay.textContent = needed.toFixed(1) + "%";
                messageDisplay.textContent = needed > 100 ? "Goal currently impossible." : "Required avg on remaining tasks.";
            }
        }
    }

    function render() {
        const container = document.getElementById('category-list');
        document.getElementById('category-count').textContent = `${categories.length} Categories`;
        container.innerHTML = '';

        categories.forEach(cat => {
            const card = document.createElement('div');
            card.className = 'calc-card category-card p-4 mb-4';
            card.innerHTML = `
                <div class="row g-3 mb-3 align-items-center">
                    <div class="col-md-5">
                        <input type="text" class="form-control fw-bold border-0 bg-light" value="${cat.name}" 
                               onchange="updateCategory(${cat.id}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Weight</span>
                            <input type="number" class="form-control" value="${cat.weight}" 
                                   oninput="updateCategory(${cat.id}, 'weight', this.value)">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <span class="small text-muted d-block text-uppercase fw-bold">Avg</span>
                        <span class="h5 fw-bold text-primary m-0" id="avg-${cat.id}">--</span>
                    </div>
                    <div class="col-md-1 text-end">
                        <button class="btn btn-link text-danger p-0" onclick="removeCategory(${cat.id})"><i class="bi bi-trash3-fill"></i></button>
                    </div>
                </div>
                
                <div class="ps-3 border-start">
                    <div id="assignments-${cat.id}">
                        ${cat.assignments.map((a, i) => `
                            <div class="row g-2 mb-2 align-items-center">
                                <div class="col-5">
                                    <input type="text" class="form-control form-control-sm border-0 bg-light" value="${a.name}" 
                                           onchange="updateAssignment(${cat.id}, ${i}, 'name', this.value)">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control form-control-sm text-center" placeholder="Score" value="${a.score}"
                                           oninput="updateAssignment(${cat.id}, ${i}, 'score', this.value)">
                                </div>
                                <div class="col-3">
                                    <input type="number" class="form-control form-control-sm text-center" placeholder="Out of" value="${a.outOf}"
                                           oninput="updateAssignment(${cat.id}, ${i}, 'outOf', this.value)">
                                </div>
                                <div class="col-1">
                                    <button class="btn btn-sm text-muted" onclick="removeAssignment(${cat.id}, ${i})">&times;</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn-sm btn-link text-decoration-none mt-2 p-0" onclick="addAssignment(${cat.id})">
                        <i class="bi bi-plus-lg me-1"></i>Add Assignment
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
        calculateAll();
    }

    // Initialize with nothing or a template if preferred
    window.onload = () => { /* Logic is handled by empty state */ };
</script>
{% endblock %}