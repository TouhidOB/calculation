{% extends "base.html" %}

{% block title %}Teacher Gradebook Average Calculator{% endblock %}

{% block meta_description %}Calculate student averages accurately using weighted grading categories and customizable assignments.{% endblock %}

{% block meta_keywords %}teacher gradebook, weighted average, GPA calculator, grading categories, student score, academic calculation{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    :root {
        --bs-primary-rgb: 139, 92, 246; /* Violet */
    }

    body {
        background-color: #fcfaff;
    }

    .grading-container {
        max-width: 1000px;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 10px 30px -5px rgba(139, 92, 246, 0.1);
        border: 1px solid #ede9fe;
        overflow: hidden;
    }

    .sidebar-summary {
        background-color: #f5f3ff;
        border-left: 1px solid #ddd6fe;
    }

    .category-card {
        border: 1px solid #e9e4ff;
        border-radius: 1rem;
        background: #ffffff;
        transition: box-shadow 0.2s ease;
    }

    .category-card:hover {
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.05);
    }

    .result-value {
        font-size: 3.5rem;
        font-weight: 800;
        color: #7c3aed;
        line-height: 1;
    }

    .form-label {
        font-weight: 600;
        color: #4b5563;
        font-size: 0.85rem;
    }

    .assignment-row {
        background-color: #fcfcfd;
        border: 1px solid #f3f4f6;
        border-radius: 0.5rem;
    }

    .btn-remove {
        color: #ef4444;
        background: transparent;
        border: none;
        transition: all 0.2s;
    }

    .btn-remove:hover {
        color: #b91c1c;
        transform: scale(1.1);
    }

    .weight-badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark"><i class="bi bi-journal-check text-primary me-2"></i>Gradebook Average Calculator</h1>
        <p class="text-muted">A professional tool for weighted grading. Define your categories and input scores to see real-time student performance.</p>
    </div>

    

    <div class="grading-container mx-auto">
        <div class="row g-0">
            <div class="col-lg-8 p-4 p-md-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0 text-secondary">Grading Categories</h5>
                    <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="addCategory()">
                        <i class="bi bi-plus-circle me-1"></i> Add Category
                    </button>
                </div>

                <div id="category-list" class="space-y-4">
                    </div>

                <div id="empty-state" class="text-center py-5">
                    <i class="bi bi-layers-fill display-1 text-light"></i>
                    <p class="text-muted mt-3">No categories added yet. Click "+ Add Category" to begin your gradebook.</p>
                </div>
            </div>

            <div class="col-lg-4 sidebar-summary p-4 p-md-5">
                <div class="sticky-top" style="top: 20px;">
                    <h5 class="fw-bold mb-4">Summary</h5>
                    
                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                        <div class="card-body text-center p-4">
                            <span class="text-uppercase small fw-bold text-muted">Student Average</span>
                            <div class="result-value my-2" id="overall-average">0.00</div>
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 rounded-pill" id="grade-letter">Enter Data</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-medium text-muted">Weight Progress</span>
                            <span class="badge bg-dark" id="current-weight-total">0%</span>
                        </div>
                        <div class="progress mb-4" style="height: 8px;">
                            <div id="weight-progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>

                        <div id="weight-alert" class="alert alert-warning py-2 px-3 small d-none border-0">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> Weights should total 100%.
                        </div>

                        <div class="card bg-white border-0 rounded-4">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="text-muted">Achieved Pts:</span>
                                    <span class="fw-bold" id="total-score-achieved">0.00</span>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">Possible Pts:</span>
                                    <span class="fw-bold" id="total-possible-score">0.00</span>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-light w-100 btn-sm mt-4 text-muted border" onclick="resetAll()">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset Gradebook
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let categoryCounter = 0;

    function resetAll() {
        if (confirm("Clear all data and start over?")) {
            document.getElementById('category-list').innerHTML = '';
            document.getElementById('empty-state').classList.remove('d-none');
            calculateAverage();
        }
    }

    function addCategory(name = '', weight = 0) {
        categoryCounter++;
        document.getElementById('empty-state').classList.add('d-none');
        const categoryId = `category-${categoryCounter}`;

        const categoryBlock = document.createElement('div');
        categoryBlock.className = 'category-card p-4 mb-4';
        categoryBlock.id = categoryId;
        categoryBlock.innerHTML = `
            <div class="row g-3 align-items-center mb-3">
                <div class="col-7">
                    <input type="text" value="${name}" placeholder="Category Name (e.g., Exams)" class="form-control form-control-sm border-0 fw-bold fs-6 ps-0 focus-none" oninput="calculateAverage()">
                </div>
                <div class="col-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-transparent border-end-0 text-muted small">Weight</span>
                        <input type="number" value="${weight}" data-type="weight" class="form-control border-start-0 text-end pe-1" oninput="calculateAverage()">
                        <span class="input-group-text bg-transparent border-start-0 text-muted small">%</span>
                    </div>
                </div>
                <div class="col-1 text-end">
                    <button class="btn-remove" onclick="removeCategory('${categoryId}')"><i class="bi bi-trash3-fill"></i></button>
                </div>
            </div>
            
            <div class="assignment-list space-y-2 mb-3"></div>

            <button class="btn btn-link btn-sm text-primary p-0 text-decoration-none fw-bold small" onclick="addAssignment('${categoryId}')">
                <i class="bi bi-plus"></i> Add Assignment
            </button>
        `;
        document.getElementById('category-list').appendChild(categoryBlock);
        calculateAverage();
    }

    function addAssignment(categoryId, name = '', score = '', max = 100) {
        const assignmentListEl = document.querySelector(`#${categoryId} .assignment-list`);
        const assignmentId = `${categoryId}-assn-${Math.random().toString(36).substring(2, 7)}`;

        const row = document.createElement('div');
        row.className = 'assignment-row p-2 mb-2 d-flex gap-2 align-items-center';
        row.id = assignmentId;
        row.innerHTML = `
            <input type="text" value="${name}" placeholder="Name" class="form-control form-control-sm flex-grow-1 border-0 bg-transparent">
            <input type="number" value="${score}" data-type="score" placeholder="Score" class="form-control form-control-sm text-center border-0 bg-white" style="width: 70px;" oninput="calculateAverage()">
            <span class="text-muted small">/</span>
            <input type="number" value="${max}" data-type="max" placeholder="Max" class="form-control form-control-sm text-center border-0 bg-white" style="width: 70px;" oninput="calculateAverage()">
            <button class="btn-remove p-1" onclick="document.getElementById('${assignmentId}').remove(); calculateAverage();"><i class="bi bi-x"></i></button>
        `;
        assignmentListEl.appendChild(row);
        calculateAverage();
    }

    function removeCategory(id) {
        document.getElementById(id).remove();
        if (document.querySelectorAll('.category-card').length === 0) {
            document.getElementById('empty-state').classList.remove('d-none');
        }
        calculateAverage();
    }

    function calculateAverage() {
        let totalWeightedScore = 0;
        let totalWeight = 0;
        let totalAchievedPoints = 0;
        let totalPossiblePoints = 0;

        document.querySelectorAll('.category-card').forEach(categoryEl => {
            const weightInput = categoryEl.querySelector('input[data-type="weight"]');
            const weight = parseFloat(weightInput.value) || 0;
            totalWeight += weight;

            let catAchieved = 0;
            let catPossible = 0;

            categoryEl.querySelectorAll('.assignment-row').forEach(row => {
                const s = parseFloat(row.querySelector('[data-type="score"]').value);
                const m = parseFloat(row.querySelector('[data-type="max"]').value) || 0;
                if (!isNaN(s) && m > 0) {
                    catAchieved += s;
                    catPossible += m;
                }
            });

            if (catPossible > 0) {
                totalWeightedScore += (catAchieved / catPossible) * weight;
            }
            totalAchievedPoints += catAchieved;
            totalPossiblePoints += catPossible;
        });

        const finalAvg = totalWeight > 0 ? (totalWeightedScore / totalWeight) * 100 : 0;
        
        // Update UI
        document.getElementById('overall-average').innerText = finalAvg.toFixed(2);
        document.getElementById('total-score-achieved').innerText = totalAchievedPoints.toFixed(2);
        document.getElementById('total-possible-score').innerText = totalPossiblePoints.toFixed(2);
        document.getElementById('current-weight-total').innerText = `${totalWeight}%`;
        document.getElementById('weight-progress-bar').style.width = `${Math.min(totalWeight, 100)}%`;
        
        const alert = document.getElementById('weight-alert');
        totalWeight !== 100 && totalWeight !== 0 ? alert.classList.remove('d-none') : alert.classList.add('d-none');

        // Letter Grade logic
        const letter = document.getElementById('grade-letter');
        if (totalWeight === 0) {
            letter.innerText = "Enter Data";
            letter.className = "badge bg-secondary bg-opacity-10 text-secondary px-3 rounded-pill";
        } else {
            letter.innerText = finalAvg >= 90 ? 'Grade: A' : finalAvg >= 80 ? 'Grade: B' : finalAvg >= 70 ? 'Grade: C' : finalAvg >= 60 ? 'Grade: D' : 'Grade: F';
            letter.className = "badge bg-primary bg-opacity-10 text-primary px-3 rounded-pill";
        }
    }

    window.onload = () => {
        calculateAverage();
    };
</script>
{% endblock %}