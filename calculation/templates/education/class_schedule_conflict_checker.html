{% extends "base.html" %}

{% block title %}Class Schedule Conflict Checker{% endblock %}

{% block meta_description %}Input your courses, meeting days, and times to instantly check for any schedule conflicts or overlaps.{% endblock %}

{% block meta_keywords %}schedule conflict, class checker, course planning, academic scheduler, time overlap detector{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .calc-wrapper {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #dee2e6;
    }

    .course-card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-left: 5px solid #0d6efd;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    /* Conflict Highlight */
    .course-card.conflict {
        background-color: #fff5f5;
        border-color: #f5c2c7;
        border-left-color: #dc3545;
        box-shadow: 0 0 15px rgba(220, 53, 69, 0.15);
    }

    /* Professional Day Selector */
    .day-selector .btn-check + .btn {
        width: 45px;
        font-weight: 600;
        font-size: 0.85rem;
        border-radius: 8px;
        margin-right: 4px;
        background-color: #fff;
        border-color: #dee2e6;
    }

    .day-selector .btn-check:checked + .btn {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    #conflict-status-bar {
        border-radius: 10px;
        font-weight: 700;
        display: none; /* Hidden on load */
    }

    .empty-state {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 50px;
        color: #adb5bd;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold">üóìÔ∏è Class Schedule Conflict Checker</h1>
        <p class="text-muted">Ensure your semester is overlap-free by analyzing your course times.</p>
    </div>

    

    <div class="calc-wrapper mx-auto" style="max-width: 1000px;">
        
        <div id="conflict-status-bar" class="alert p-3 mb-4 text-center shadow-sm animate__animated animate__fadeIn">
            </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="fw-bold mb-0">Course Information</h5>
            <button id="add-course-btn" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-lg"></i> Add New Class
            </button>
        </div>

        <div id="course-list">
            <div class="empty-state" id="empty-msg">
                <i class="bi bi-calendar2-x fs-1 d-block mb-3"></i>
                <p class="mb-0">Your schedule is empty.</p>
                <small>Click "+ Add New Class" to begin checking for conflicts.</small>
            </div>
        </div>

        <div class="alert alert-light border mt-4 small text-secondary">
            <i class="bi bi-info-circle-fill me-2"></i>
            Tip: Conflict detection works instantly as you type. Ensure end times are later than start times.
        </div>
        
        <div class="text-center mt-5">
            <button class="btn btn-link text-muted text-decoration-none" onclick="resetAll()">
                <i class="bi bi-trash"></i> Reset All Data
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let courseCounter = 0;
    const daysArr = ['M', 'T', 'W', 'Th', 'F'];

    const courseListEl = document.getElementById('course-list');
    const addCourseBtn = document.getElementById('add-course-btn');
    const statusBar = document.getElementById('conflict-status-bar');
    const emptyMsg = document.getElementById('empty-msg');

    function timeToMinutes(timeStr) {
        if (!timeStr) return 0;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    function checkConflicts() {
        const rows = document.querySelectorAll('.course-card');
        const courses = [];
        
        // Clear all conflict states first
        rows.forEach(row => row.classList.remove('conflict'));

        rows.forEach(row => {
            const id = row.id;
            const name = row.querySelector('.course-name').value;
            const start = timeToMinutes(row.querySelector('.start-time').value);
            const end = timeToMinutes(row.querySelector('.end-time').value);
            const days = Array.from(row.querySelectorAll('.day-check:checked')).map(cb => cb.value);

            if (name && days.length > 0 && start < end) {
                courses.push({ id, name, start, end, days });
            }
        });

        if (courses.length < 2) {
            statusBar.style.display = 'none';
            return;
        }

        let conflictsFound = false;
        const conflictingIds = new Set();

        for (let i = 0; i < courses.length; i++) {
            for (let j = i + 1; j < courses.length; j++) {
                const a = courses[i];
                const b = courses[j];

                const sharedDays = a.days.filter(d => b.days.includes(d));
                if (sharedDays.length > 0) {
                    const overlap = (a.start < b.end) && (b.start < a.end);
                    if (overlap) {
                        conflictsFound = true;
                        conflictingIds.add(a.id);
                        conflictingIds.add(b.id);
                    }
                }
            }
        }

        statusBar.style.display = 'block';
        if (conflictsFound) {
            conflictingIds.forEach(id => document.getElementById(id).classList.add('conflict'));
            statusBar.className = 'alert alert-danger p-3 mb-4 text-center shadow-sm';
            statusBar.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i> Conflict Detected! Some classes overlap in time.';
        } else {
            statusBar.className = 'alert alert-success p-3 mb-4 text-center shadow-sm';
            statusBar.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Your schedule looks clean! No overlaps found.';
        }
    }

    function addCourse() {
        if (emptyMsg) emptyMsg.style.display = 'none';
        
        courseCounter++;
        const rowId = `course-${courseCounter}`;
        const card = document.createElement('div');
        card.className = 'course-card';
        card.id = rowId;

        let dayCheckboxes = daysArr.map(day => `
            <input type="checkbox" class="btn-check day-check" id="day-${day}-${rowId}" value="${day}" autocomplete="off" onchange="checkConflicts()">
            <label class="btn btn-outline-primary" for="day-${day}-${rowId}">${day}</label>
        `).join('');

        card.innerHTML = `
            <div class="row g-3 align-items-center">
                <div class="col-lg-3">
                    <label class="small fw-bold text-muted">Course Name</label>
                    <input type="text" class="form-control course-name" placeholder="e.g., Biology 101" oninput="checkConflicts()">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label class="small fw-bold text-muted">Time Period</label>
                    <div class="input-group">
                        <input type="time" class="form-control start-time" value="09:00" oninput="checkConflicts()">
                        <span class="input-group-text">to</span>
                        <input type="time" class="form-control end-time" value="10:00" oninput="checkConflicts()">
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label class="small fw-bold text-muted d-block">Meeting Days</label>
                    <div class="day-selector d-flex">${dayCheckboxes}</div>
                </div>
                <div class="col-lg-2 text-end">
                    <button class="btn btn-outline-danger w-100 mt-lg-3" onclick="removeCourse('${rowId}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;

        courseListEl.appendChild(card);
        checkConflicts();
    }

    function removeCourse(id) {
        document.getElementById(id).remove();
        if (document.querySelectorAll('.course-card').length === 0) {
            emptyMsg.style.display = 'block';
            statusBar.style.display = 'none';
        } else {
            checkConflicts();
        }
    }

    function resetAll() {
        if (confirm("Clear your entire schedule?")) {
            courseListEl.innerHTML = '';
            courseListEl.appendChild(emptyMsg);
            statusBar.style.display = 'none';
            emptyMsg.style.display = 'block';
        }
    }

    addCourseBtn.addEventListener('click', addCourse);

    window.onload = () => {
        // Start with clean slate for visitor use
    };
</script>
{% endblock %}