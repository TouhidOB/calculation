{% extends "base.html" %}

{% block title %}Function Integral Calculator (Definite & Indefinite){% endblock %}

{% block meta_description %}Calculate definite integrals numerically (Trapezoidal Rule) and find indefinite integrals symbolically for polynomials and basic functions.{% endblock %}

{% block meta_keywords %}integral calculator, calculus, integration, antiderivative, definite integral, indefinite integral, math solver, trapezoidal rule{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    /* ðŸŽ¨ Define Theme Colors (Red/Calculus Theme for Bootstrap) */
    :root {
        --danger-light: #fff8f8; /* Solver Wrapper Background */
        --danger-pale: #fef2f2; /* Input background */
        --danger-medium: #f87171; /* Input border */
        --danger-dark: #991b1b; /* Dark red text/label */
        --success-custom: #065f46; /* Success text */
        --success-bg: #ecfdf5; /* Success background */
        --success-border: #10b981; /* Success border */
    }

    /* ðŸ§¼ Solver Wrapper: Central container styling */
    .solver-wrapper {
        background: var(--danger-light);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 750px;
        margin: 0 auto;
        font-family: 'Inter', sans-serif;
    }
    
    .input-group-custom {
        display: flex;
        align-items: center;
        background-color: var(--danger-pale);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--danger-medium);
    }

    .input-group-custom label {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--danger-dark);
        margin-right: 15px;
    }

    #function-input {
        flex-grow: 1;
        padding: 10px;
        font-size: 1.2rem;
        border: 2px solid var(--danger-medium);
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        /* Bootstrap Form Control override */
        color: var(--danger-dark);
    }
    
    .result-box {
        margin-top: 25px;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid var(--bs-danger);
        background-color: #fee2e2;
        color: var(--danger-dark);
    }
    
    .result-success {
        border-left: 5px solid var(--success-border);
        background-color: var(--success-bg);
        color: var(--success-custom);
    }

    /* Styling for the LaTeX output */
    .latex-output {
        font-size: 1.6rem;
        text-align: center;
        padding: 10px 0;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center fw-bolder mb-2 text-dark fs-2">Calculus: Integral Solver</h1>
    <p class="text-secondary mb-4 text-center">Enter the function $f(x)$. Add bounds $a$ and $b$ for a definite integral.</p>

    <div class="solver-wrapper">
        <form id="integral-form" class="d-grid gap-4">
            
            <div class="input-group-custom shadow-sm">
                <label for="function-input">$$f(x) =$$</label>
                <input type="text" id="function-input" required
                       placeholder="e.g., 3*x^2 - 4*x + 1"
                       class="form-control" style="border-radius: 6px;">
            </div>

            <div class="row g-3">
                <div class="col-sm-6">
                    <label for="lower-bound" class="form-label text-secondary small">Lower Bound $a$ (Optional)</label>
                    <input type="number" id="lower-bound" step="any"
                           placeholder="e.g., 0"
                           class="form-control">
                </div>
                <div class="col-sm-6">
                    <label for="upper-bound" class="form-label text-secondary small">Upper Bound $b$ (Optional)</label>
                    <input type="number" id="upper-bound" step="any"
                           placeholder="e.g., 5"
                           class="form-control">
                </div>
            </div>

            <button type="submit"
                    class="btn btn-danger w-100 fw-bold py-3 shadow-lg">
                Calculate Integral
            </button>
        </form>

        <div id="result-container" class="mt-4">
            <h2 class="fs-4 fw-semibold text-dark mb-3 border-bottom pb-2">Results</h2>
            <div id="solution-output" class="result-box d-none">
                </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    const N_STEPS = 5000; // Number of trapezoids for numerical integration
    
    /**
     * Converts a user-input function string into a safe, executable JavaScript function.
     * @param {string} funcStr - The user input function string.
     * @returns {Function} An executable JavaScript function f(x).
     */
    function createExecutableFunction(funcStr) {
        let safeFuncStr = funcStr.toLowerCase().replace(/\s+/g, '');
        
        // 1. Replace exponents and common math functions
        safeFuncStr = safeFuncStr
            .replace(/\^/g, '**') // Exponentiation operator
            .replace(/log\(([^)]+)\)/g, 'Math.log10($1)') // Base 10 Log
            .replace(/ln\(([^)]+)\)/g, 'Math.log($1)')    // Natural Log (base e)
            .replace(/abs\(([^)]+)\)/g, 'Math.abs($1)')  // Absolute value
            .replace(/e\^x/g, 'Math.exp(x)') // e^x
            .replace(/pi/g, 'Math.PI') // Pi constant
            // Ensure all trigonometric functions are prefixed with Math.
            .replace(/sin\(([^)]+)\)/g, 'Math.sin($1)')
            .replace(/cos\(([^)]+)\)/g, 'Math.cos($1)')
            .replace(/tan\(([^)]+)\)/g, 'Math.tan($1)');
            
        // 2. Safely create and return the function
        return new Function('x', 'return ' + safeFuncStr);
    }
    
    /**
     * Calculates the definite integral using the Trapezoidal Rule.
     * @param {Function} func - The executable function f(x).
     * @param {number} a - Lower bound.
     * @param {number} b - Upper bound.
     * @param {number} n - Number of steps.
     * @returns {number} The numerical approximation of the definite integral.
     */
    function trapezoidalRule(func, a, b, n) {
        const h = (b - a) / n;
        let sum = 0.5 * (func(a) + func(b));

        for (let i = 1; i < n; i++) {
            const x_i = a + i * h;
            sum += func(x_i);
        }

        return sum * h;
    }

    /**
     * Attempts to find the indefinite integral (antiderivative) symbolically.
     * This is a simple implementation primarily handling power rule and basic trig/exp.
     * @param {string} funcStr - The input function string.
     * @returns {string} The antiderivative string in LaTeX format (without +C).
     */
    function calculateSymbolicIntegral(funcStr) {
        // Clean and normalize the string
        let cleanedStr = funcStr.toLowerCase().replace(/\s+/g, '');
        cleanedStr = cleanedStr.replace(/-/g, '+-'); // Replace subtraction with '+-'
        
        const terms = cleanedStr.split('+').filter(term => term.length > 0);
        let integratedTerms = [];

        for (let term of terms) {
            let sign = term.startsWith('-') ? -1 : 1;
            let currentTerm = term.replace('-', '');
            let coeff = 1;
            let integratedTerm = '';
            let isTermHandled = false;

            // --- Case 1: Pure Constant (e.g., 5, -2) ---
            if (!currentTerm.includes('x') && !currentTerm.includes('sin') && !currentTerm.includes('cos') && !currentTerm.includes('ln') && !currentTerm.includes('e')) {
                // Integral of constant c is c*x
                coeff = parseFloat(currentTerm);
                integratedTerm = `${Math.abs(coeff).toFixed(4).replace(/\.?0+$/, "")}x`;
                isTermHandled = true;
            }
            
            // --- Case 2: e^x ---
            else if (currentTerm === 'e^x' || currentTerm === 'ex') {
                integratedTerm = 'e^x'; // Integral of e^x is e^x
                isTermHandled = true;
            }

            // --- Case 3: Basic Trigonometry ---
            else if (currentTerm === 'sin(x)') {
                integratedTerm = '-\\cos(x)'; // Integral of sin(x) is -cos(x)
                isTermHandled = true;
            }
            else if (currentTerm === 'cos(x)') {
                integratedTerm = '\\sin(x)'; // Integral of cos(x) is sin(x)
                isTermHandled = true;
            }

            // --- Case 4: Power Rule (c*x^n) or 1/x (x^-1) ---
            else {
                // Attempt to parse for x term
                let xIndex = currentTerm.indexOf('x');
                
                if (xIndex !== -1) {
                    // Extract coefficient (part before x)
                    let coeffStr = currentTerm.substring(0, xIndex);
                    if (coeffStr === '') { coeff = 1; }
                    else if (coeffStr === '1*') { coeff = 1; }
                    else if (coeffStr.endsWith('*')) { coeff = parseFloat(coeffStr.slice(0, -1)); }
                    else { coeff = parseFloat(coeffStr); }
                    
                    if (isNaN(coeff)) coeff = 1; // Default if no explicit number (e.g., x^2)

                    let exponent = 1; 
                    let expMatch = currentTerm.match(/\^([\d\.\-]+)/);

                    if (expMatch) {
                        exponent = parseFloat(expMatch[1]);
                    } else if (currentTerm.endsWith('x')) {
                        // Exponent is 1 if it's just 'x'
                        exponent = 1;
                    } else if (currentTerm.includes('1/x')) {
                        // Special handling for 1/x (which should be x^-1 in disguise)
                        exponent = -1;
                    }

                    if (exponent === -1) {
                         // Case: 1/x or x^-1 -> ln|x|
                         integratedTerm = `${Math.abs(coeff).toFixed(4).replace(/\.?0+$/, "")}\\ln|x|`;
                         isTermHandled = true;
                    } else {
                        // Apply Reverse Power Rule: c/(n+1) * x^(n+1)
                        const newCoeff = coeff / (exponent + 1);
                        const newExp = exponent + 1;
                        
                        let coeffStr = Math.abs(newCoeff).toFixed(4).replace(/\.?0+$/, "");
                        if (Math.abs(newCoeff) === 1 && newExp !== 0) { coeffStr = ''; } // Omit 1

                        if (newExp === 1) {
                            integratedTerm = `${coeffStr}x`;
                        } else {
                            integratedTerm = `${coeffStr}x^{${newExp}}`;
                        }
                        isTermHandled = true;
                    }
                }
            }
            
            if (isTermHandled) {
                // Apply sign and clean up
                let fullTerm = integratedTerm;
                // Determine the correct sign based on original sign and calculated coefficient sign
                if (sign * coeff < 0) {
                    fullTerm = '-' + fullTerm;
                } else if (integratedTerms.length > 0) {
                    fullTerm = '+' + fullTerm;
                }
                
                integratedTerms.push(fullTerm);
            } else {
                // Unhandled term, notify the user.
                return `\\text{Error: Unhandled term (e.g., } \\frac{1}{x^2}, \\tan(x) \\text{): } ${term}`;
            }
        }

        let result = integratedTerms.join('');
        if (result.startsWith('+')) {
            result = result.substring(1);
        }
        
        return result || '0';
    }
    
    document.getElementById('integral-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const funcStr = document.getElementById('function-input').value.trim();
        const aStr = document.getElementById('lower-bound').value.trim();
        const bStr = document.getElementById('upper-bound').value.trim();

        const outputDiv = document.getElementById('solution-output');
        outputDiv.classList.add('d-none');
        outputDiv.classList.remove('result-success', 'result-error');
        outputDiv.innerHTML = '';

        let htmlContent = '';

        try {
            if (funcStr === '') {
                throw new Error("Function input cannot be empty.");
            }
            
            const func = createExecutableFunction(funcStr);
            const a = aStr === '' ? null : parseFloat(aStr);
            const b = bStr === '' ? null : parseFloat(bStr);

            // --- 1. Symbolic (Indefinite) Integration ---
            const antiderivative = calculateSymbolicIntegral(funcStr);
            
            if (antiderivative.includes('\\text{Error:')) {
                 htmlContent += `<p class="fw-bold text-center">Symbolic Error</p><p class="text-center">${antiderivative.replace(/\\text{|}/g, '')}</p>`;
                 displayResult('result-error', htmlContent);
                 return;
            }
            
            htmlContent += `<p class="fs-5 fw-bold mb-3 text-danger">Indefinite Integral:</p>`;
            htmlContent += `<div class="latex-output">$$\\int f(x) dx = ${antiderivative} + C$$</div>`;
            
            // --- 2. Numerical (Definite) Integration ---
            if (a !== null && b !== null) {
                if (isNaN(a) || isNaN(b)) {
                     throw new Error("Bounds must be valid numbers for a definite integral.");
                }
                
                const definiteResult = trapezoidalRule(func, a, b, N_STEPS);
                
                htmlContent += `<hr class="my-4 border-secondary">`;
                htmlContent += `<p class="fs-5 fw-bold mb-3 text-danger">Definite Integral Value:</p>`;
                htmlContent += `<p class="fs-2 fw-bolder text-center text-success-custom">$$\\int_{${a}}^{${b}} f(x) dx \\approx \\mathbf{${definiteResult.toFixed(6)}}$$</p>`;
                htmlContent += `<p class="small text-center mt-2 text-secondary">(Calculated numerically using ${N_STEPS} steps - Trapezoidal Rule)</p>`;
                
                displayResult('result-success', htmlContent);
                
            } else {
                htmlContent += `<p class="small fw-semibold mt-4 text-secondary">Enter both the lower and upper bounds to calculate the definite integral numerically.</p>`;
                displayResult('result-success', htmlContent);
            }

        } catch (error) {
            console.error(error);
            displayResult('result-error', `<p class="fw-bold">Error:</p><p>${error.message || "An internal error occurred during calculation. Check the function syntax."}</p>`);
        }
        
        // Trigger MathJax re-render
        if (window.MathJax) {
            window.MathJax.typesetPromise();
        }
    });

    /**
     * Updates the results display with appropriate styling and content.
     */
    function displayResult(className, contentHtml) {
        const outputDiv = document.getElementById('solution-output');
        outputDiv.className = 'result-box'; 
        if (className) {
            outputDiv.classList.add(className);
        }
        outputDiv.innerHTML = contentHtml;
        outputDiv.classList.remove('d-none');
    }
</script>
{% endblock %}