{% extends "base.html" %}

{% block title %}Binomial Theorem Calculator $(x+y)^n${% endblock %}

{% block meta_description %}Generate the full binomial expansion of $(x+y)^n$ by entering the exponent $n$, using the Binomial Theorem formula.{% endblock %}

{% block meta_keywords %}binomial theorem, polynomial expansion, nCr, combinations, binomial coefficient, algebra calculator{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjHh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    /* ðŸŽ¨ Define Custom Theme Colors using CSS Variables */
    :root {
        --rose-lightest: #fdf2f8; 
        --rose-pale: #fce7f6; 
        --rose-border: #fbcfe8; 
        --rose-darker: #be185d; 
        --pink-hot: #db2777; 
        --pink-button: #ec4899; 
    }

    /* ðŸ§¼ Solver Wrapper: Central container styling */
    .solver-wrapper {
        background: var(--rose-lightest); 
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
        font-family: 'Inter', sans-serif;
    }
    
    .input-group {
        padding: 20px;
        border-radius: 8px;
        background-color: var(--rose-pale); 
        border: 1px solid var(--rose-border);
    }

    .input-group label {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--rose-darker); 
        margin-bottom: 5px;
        display: block;
        text-align: center;
    }

    .input-field {
        width: 100%;
        max-width: 250px;
        margin: 0 auto;
        padding: 12px;
        font-size: 1.4rem;
        border: 2px solid #f472b6;
        border-radius: 8px;
        text-align: center;
        font-weight: 700;
        color: #9d174d;
        display: block;
        transition: box-shadow 0.15s ease-in-out;
    }
    .input-field:focus {
        border-color: var(--pink-hot) !important;
        box-shadow: 0 0 0 0.25rem rgba(219, 39, 119, 0.25) !important;
    }
    
    /* ðŸ“Š Result Display Styles */
    .result-box {
        margin-top: 25px;
        padding: 20px;
        border-radius: 12px;
        border-left: 5px solid;
    }

    .result-success {
        border-left-color: var(--pink-hot); 
        background-color: #fff7f8;
        color: #9d174d;
    }
    .result-error {
        border-left-color: #dc3545; 
        background-color: #f8d7da;
        color: #842029;
    }

    .output-label {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }
    .output-formula {
        font-size: 1.2rem;
        font-weight: 500;
        color: #4b5563;
    }
    .output-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--pink-hot); 
        overflow-x: auto; 
        padding: 10px 0;
        white-space: nowrap;
        border: 1px dashed var(--rose-border);
        border-radius: 6px;
    }

    /* ðŸ§± Term Breakdown Styling */
    .term-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dotted #ccc;
    }
    .term-row:last-child {
        border-bottom: none;
    }
    .term-col-left {
        font-weight: 600;
        color: #555;
        min-width: 100px;
        padding-right: 10px;
        text-align: right;
    }
    .term-col-right {
        flex-grow: 1;
        font-family: monospace;
        font-size: 1.1rem;
        color: var(--pink-hot);
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center fw-bolder mb-2 text-dark fs-2">Binomial Theorem Calculator</h1>
    <p class="text-secondary mb-5 text-center">
        Generate the full expansion of the binomial $(x + y)^n$.
    </p>

    <div class="solver-wrapper">
        <form id="binomial-form" class="d-grid gap-4">
            
            <div class="input-group shadow-lg text-center">
                <label for="n-input">
                    <span class="fs-5">Enter the **Positive Integer Exponent $n$**:</span>
                </label>
                <div class="fs-3 fw-bold text-dark mb-4 mt-2">
                    $$(x+y)^{\mathbf{n}}$$
                </div>
                <input type="number" id="n-input" required step="1" min="0" max="15"
                       placeholder="Enter n (e.g., 4)"
                       class="form-control input-field shadow-sm">
                <p class="form-text text-muted mt-2">Max limit is 15. $n$ must be a whole number.</p>
            </div>

            <button type="submit"
                    class="btn w-100 fw-bold py-3 shadow-xl text-white"
                    style="background-color: var(--pink-button); border-color: var(--pink-button);">
                Expand $(x+y)^n$
            </button>
        </form>

        <div id="result-container" class="mt-5">
            <h2 class="fs-4 fw-semibold text-dark mb-3 border-bottom pb-2">Full Expansion</h2>
            <div id="solution-output" class="result-box d-none">
                </div>

            <div id="breakdown-section" class="mt-4 d-none">
                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#termBreakdown" aria-expanded="false" aria-controls="termBreakdown">
                    Show/Hide Step-by-Step Term Breakdown
                </button>
                <div class="collapse mt-3" id="termBreakdown">
                    <div class="card card-body bg-light">
                        <h4 class="fs-5 fw-bold text-dark text-center mb-3">Term Components ($\text{C}(n, k) x^{n-k} y^k$)</h4>
                        <div id="breakdown-content">
                            </div>
                        <p class="text-center mt-3 mb-0">
                            <small class="text-muted">Formula Applied: $$(x+y)^{n} = \sum_{k=0}^{n} \text{C}(n, k) x^{n-k} y^k$$</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    /**
     * Calculates the combination (nCr) using the optimized formula. 
     */
    function calculateCombination(n, r) {
        if (r === 0 || r === n) return 1;
        if (r < 0 || r > n) return 0;
        
        if (r > n / 2) {
            r = n - r;
        }

        let result = 1;
        for (let i = 1; i <= r; i++) {
            result = (result * (n - i + 1)) / i;
        }
        return Math.round(result);
    }
    
    /**
     * Formats the power expression for a variable.
     */
    function formatPower(variable, power) {
        if (power === 0) return '';
        if (power === 1) return variable;
        return `${variable}^{\\mathbf{${power}}}`;
    }

    /**
     * Updates the results display with appropriate styling and content.
     */
    function displayResult(className, contentHtml, breakdownHtml) {
        const outputDiv = document.getElementById('solution-output');
        const breakdownSection = document.getElementById('breakdown-section');
        const breakdownContent = document.getElementById('breakdown-content');

        // Reset classes and show main result
        outputDiv.className = 'result-box';
        outputDiv.classList.add(className);
        outputDiv.innerHTML = contentHtml;
        outputDiv.classList.remove('d-none');
        
        // Populate and show breakdown section
        breakdownContent.innerHTML = breakdownHtml;
        breakdownSection.classList.remove('d-none');

        // Trigger MathJax re-render for both sections
        if (window.MathJax) {
            window.MathJax.typesetPromise([outputDiv, breakdownSection]);
        }
    }


    document.getElementById('binomial-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const nInput = document.getElementById('n-input').value.trim();
        const n = parseInt(nInput);
        
        const outputDiv = document.getElementById('solution-output');
        
        // Hide previous results instantly on form submit
        outputDiv.classList.add('d-none');
        document.getElementById('breakdown-section').classList.add('d-none');
        outputDiv.className = 'result-box'; 

        let htmlContent = '';
        let breakdownHtml = '';
        let resultClass = '';

        // --- Input Validation ---
        if (nInput === '' || isNaN(n) || n < 0 || !Number.isInteger(n)) {
            htmlContent = `<p class="fw-bold text-center">Invalid Input</p><p class="text-center">Please enter a non-negative whole number for the exponent $n$.</p>`;
            resultClass = 'result-error';
            displayResult(resultClass, htmlContent, '');
            return;
        }

        if (n > 15) {
            htmlContent = `<p class="fw-bold text-center">Exponent Too Large</p><p class="text-center">Generating expansions for $n > 15$ can result in very long output. Please choose $n \le 15$ for best readability.</p>`;
            resultClass = 'result-error';
            displayResult(resultClass, htmlContent, '');
            return;
        }

        // --- Calculation (Generating the Expansion and Breakdown) ---
        const terms = [];

        for (let k = 0; k <= n; k++) {
            const coefficient = calculateCombination(n, k);
            const xPower = n - k;
            const yPower = k;
            
            // Format coefficient: only show if not 1 and not the first term (unless n=0)
            const coeffDisplay = (coefficient === 1 && (xPower > 0 || yPower > 0)) ? '' : coefficient.toLocaleString();
            
            // Format power terms
            const xTerm = formatPower('x', xPower);
            const yTerm = formatPower('y', yPower);

            // Construct the full term: $\text{nCr} \cdot x^{n-k} \cdot y^k$
            let term = `${coeffDisplay}${xTerm}${yTerm}`;
            
            // Handle n=0 case
            if (n === 0) {
                term = '1';
                break; 
            }
            // Handle n=1 case (where 1x + 1y should be x + y)
            if (n === 1) {
                // If k=0, term is 'x'. If k=1, term is 'y'.
                term = (k === 0) ? 'x' : 'y';
            }
            // Fix: If coefficient is 1, and only one term is present (e.g., k=0 for n=2 -> 1x^2), ensure '1' is omitted.
            if (coeffDisplay === '' && term === '') {
                 // This should only happen for C(n,k) = 1 and both powers are 0, which is only n=0, k=0, handled above.
                 // Otherwise, ensure term starts with a coefficient or a variable.
                 if (n !== 0) {
                    term = xTerm || yTerm;
                 }
            }


            terms.push(term);

            // --- Breakdown Content Generation ---
            breakdownHtml += `
                <div class="term-row">
                    <div class="term-col-left">Term ${k + 1} ($k=${k}$):</div>
                    <div class="term-col-right">
                        $$\\mathbf{\\text{C}(${n}, ${k})} \\cdot ${formatPower('x', xPower) || '1'} \\cdot ${formatPower('y', yPower) || '1'} = ${term}$$
                    </div>
                </div>
            `;
        }
        
        const expansion = terms.join(' + ');
        
        // --- Result Display ---
        
        htmlContent += `<p class="output-label text-center">Final Expansion of $$(x+y)^{\mathbf{${n}}}$$</p>`;

        htmlContent += `<div class="output-value text-center">
                           $$\\mathbf{${expansion}}$$
                        </div>`;
        
        htmlContent += `<p class="text-sm text-center text-secondary mt-4 mb-0">
                            This expansion has ${n + 1} terms.
                        </p>`;

        resultClass = 'result-success';
        
        displayResult(resultClass, htmlContent, breakdownHtml);
    });

    // FIX: Removed window.onload function, so the page loads clean and empty.
</script>
{% endblock %}