{% extends "base.html" %}

{% block title %}Function Derivative Calculator{% endblock %}

{% block meta_description %}Calculate the first derivative of simple functions and polynomials with respect to x using calculus rules.{% endblock %}

{% block meta_keywords %}derivative calculator, calculus, differentiation, power rule, chain rule, math solver{% endblock %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Styling for the central calculation block */
    .solver-wrapper {
        background: #f8faff;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
        font-family: 'Inter', sans-serif;
    }
    
    .input-group {
        display: flex;
        align-items: center;
        background-color: #e0f2fe; /* Light blue background for input area */
        padding: 15px;
        border-radius: 8px;
    }

    .input-group label {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0c4a6e;
        margin-right: 15px;
    }

    #function-input {
        flex-grow: 1;
        padding: 10px;
        font-size: 1.2rem;
        border: 2px solid #90cdf4;
        border-radius: 6px;
        font-family: 'Consolas', monospace;
    }
    
    .result-box {
        margin-top: 25px;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #007bff;
        background-color: #f0f8ff; /* Very light blue */
        color: #004085;
    }
    
    .result-error {
        border-left: 5px solid #ef4444;
        background-color: #fee2e2;
        color: #991b1b;
    }

    /* Styling for the LaTeX output */
    .latex-output {
        font-size: 1.8rem;
        text-align: center;
        padding: 10px 0;
        min-height: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-extrabold mb-2 text-gray-900 text-center">Calculus: Derivative Solver</h1>
    <p class="text-gray-600 mb-6 text-center">Find the derivative $\frac{d}{dx} [f(x)]$. Handles polynomials, $e^x$, $\ln(x)$, $\sin(x)$, $\cos(x)$.</p>

    <div class="solver-wrapper">
        <form id="derivative-form" class="space-y-6">
            
            <div class="input-group">
                <label for="function-input">$$f(x) =$$</label>
                <input type="text" id="function-input" value="3*x^2 + sin(x) + 5" required
                       placeholder="e.g., 2*x^3 - 4*x + 1"
                       class="shadow-md focus:shadow-lg transition-shadow">
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01]">
                Calculate Derivative
            </button>
        </form>

        <!-- Result Display Area -->
        <div id="result-container" class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Result: $$f'(x)$$</h2>
            <div id="solution-output" class="result-box hidden">
                <!-- Result will be displayed here in LaTeX format -->
                <div class="latex-output" id="latex-result"></div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /**
     * Attempts to find the derivative of a basic function string.
     * This implementation uses simplified string pattern matching and is NOT a full symbolic differentiation engine.
     * It primarily handles terms separated by '+' or '-'.
     * Supported functions: x^n, c, c*x, sin(x), cos(x), ln(x), e^x.
     * @param {string} funcStr - The input function string.
     * @returns {string} The derivative string in LaTeX format.
     */
    function calculateDerivative(funcStr) {
        // Clean and normalize the string for easier parsing
        let cleanedStr = funcStr.toLowerCase().replace(/\s+/g, '');
        
        // Use a placeholder for '+' and '-' within function calls (like sin(x+2)) before splitting terms
        // This is a major limitation; this calculator only handles simple sums/differences of simple functions.
        
        // Replace subtraction with '+-' for easier splitting
        cleanedStr = cleanedStr.replace(/-/g, '+-');
        
        // Split into terms (handling leading signs)
        const terms = cleanedStr.split('+').filter(term => term.length > 0);
        
        let derivativeTerms = [];

        for (let term of terms) {
            let sign = term.startsWith('-') ? -1 : 1;
            let currentTerm = term.replace('-', ''); // Remove sign for parsing
            let coeff = 1;
            let derivedTerm = '';

            // --- Case 1: Constant (e.g., 5, -2) ---
            if (!currentTerm.includes('x') && !currentTerm.includes('sin') && !currentTerm.includes('cos') && !currentTerm.includes('ln') && !currentTerm.includes('e')) {
                // Derivative of a constant is 0, skip this term unless it's the only one.
                continue;
            }
            
            // --- Case 2: e^x ---
            if (currentTerm === 'e^x' || currentTerm === 'ex') {
                derivedTerm = 'e^x';
            } else if (currentTerm === 'e') {
                // Derivative of constant e is 0
                continue;
            }

            // --- Case 3: ln(x) ---
            else if (currentTerm === 'ln(x)') {
                derivedTerm = '\\frac{1}{x}';
            }

            // --- Case 4: Basic Trigonometry ---
            else if (currentTerm === 'sin(x)') {
                derivedTerm = '\\cos(x)';
            }
            else if (currentTerm === 'cos(x)') {
                derivedTerm = '-\\sin(x)';
            }

            // --- Case 5: Power Rule (c*x^n) ---
            else {
                // Parse coefficient and exponent
                const parts = currentTerm.split('*');
                let xTerm = parts.find(p => p.includes('x'));
                let cTerm = parts.find(p => !p.includes('x'));

                // Handle case where coefficient is omitted (x^n or x)
                if (!cTerm) {
                    if (xTerm !== 'x') { // If it's x^n
                        cTerm = '1';
                    }
                }
                
                // If there's a coefficient term, parse it
                if (cTerm) {
                    coeff = parseFloat(cTerm);
                    if (isNaN(coeff)) {
                        // This handles cases like '*x' being split incorrectly or bad input
                        coeff = 1;
                    }
                }
                
                // Handle case where x^n is omitted, but c is present (already handled by Case 1)
                
                let exponent = 1; // Default for x (x^1)
                let newCoeff, newExp;

                if (xTerm) {
                    if (xTerm.includes('^')) {
                        exponent = parseFloat(xTerm.split('^')[1]);
                    } 
                    // If no ^ is found, exponent remains 1 (x^1)
                    
                    // Apply Power Rule: d/dx(c*x^n) = c*n*x^(n-1)
                    newCoeff = coeff * exponent;
                    newExp = exponent - 1;

                    // Format the derived term
                    let coeffStr = Math.abs(newCoeff).toFixed(4).replace(/\.?0+$/, ""); // Clean float zeros
                    
                    if (newExp === 0) {
                        derivedTerm = coeffStr; // Result is just the constant
                    } else if (newExp === 1) {
                        derivedTerm = `${coeffStr}x`;
                    } else {
                        derivedTerm = `${coeffStr}x^{${newExp}}`;
                    }
                } else {
                    // This handles c*x (e.g., 5*x). derivative is just c.
                    derivedTerm = Math.abs(coeff).toFixed(4).replace(/\.?0+$/, "");
                }
            }

            // Apply sign and clean up
            if (derivedTerm !== '0') {
                if (sign * coeff < 0) {
                    derivedTerm = '-' + derivedTerm;
                } else if (derivativeTerms.length > 0) {
                    derivedTerm = '+' + derivedTerm;
                }
                derivativeTerms.push(derivedTerm);
            }
        }

        let result = derivativeTerms.join('');

        if (!result) {
            return '0'; // Derivative of a constant is 0
        }
        
        // Final cleanup: remove leading '+' if present
        if (result.startsWith('+')) {
            result = result.substring(1);
        }
        
        return result;
    }


    document.getElementById('derivative-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const funcStr = document.getElementById('function-input').value.trim();
        const outputDiv = document.getElementById('solution-output');
        const resultDiv = document.getElementById('latex-result');

        outputDiv.classList.add('hidden');
        outputDiv.classList.remove('result-error');
        resultDiv.innerHTML = '';

        try {
            if (funcStr === '') {
                throw new Error("Function input cannot be empty.");
            }
            
            const derivedFuncStr = calculateDerivative(funcStr);
            
            const latexOutput = `$$f'(x) = ${derivedFuncStr}$$`;
            
            resultDiv.innerHTML = latexOutput;
            displayResult('', '');

        } catch (error) {
            displayResult('result-error', `<p class="font-bold">Error:</p><p>Could not parse or differentiate the function. Please ensure simple syntax (e.g., 3*x^2 + sin(x)).</p>`);
        }
    });

    /**
     * Updates the results display with appropriate styling and content.
     */
    function displayResult(className, contentHtml) {
        const outputDiv = document.getElementById('solution-output');
        outputDiv.className = 'result-box'; 
        if (className) {
            outputDiv.classList.add(className);
            outputDiv.innerHTML = contentHtml; // Error content goes here
            document.getElementById('latex-result').innerHTML = ''; // Clear LaTeX area on error
        }
        outputDiv.classList.remove('hidden');
    }
</script>
{% endblock %}