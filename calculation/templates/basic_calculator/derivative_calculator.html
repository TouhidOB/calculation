{% extends "base.html" %}

{% block title %}Function Derivative Calculator{% endblock %}

{% block meta_description %}Calculate the first derivative of simple functions and polynomials with respect to x using calculus rules. This calculator handles basic power, exponential, logarithmic, and trigonometric functions.{% endblock %}

{% block meta_keywords %}derivative calculator, calculus, differentiation, power rule, chain rule, math solver, f prime of x{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    /* ðŸŽ¨ Define Custom Theme Colors (Blue/Sky Theme) */
    :root {
        --sky-lightest: #f8faff; /* Solver Wrapper Background */
        --sky-pale: #e0f2fe; /* Light blue Input Background */
        --sky-label: #0c4a6e; /* Dark blue label text */
        --sky-input-border: #90cdf4; /* Medium blue border */
        --sky-result-bg: #f0f8ff; /* Very light blue result box */
        --sky-result-border: #007bff; /* Blue border accent */
        --sky-result-text: #004085; /* Dark blue result text */
        --sky-button: #2563eb; /* Blue 600 */
    }

    /* ðŸ§¼ Solver Wrapper: Central container styling */
    .solver-wrapper {
        background: var(--sky-lightest);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: 0 auto;
        font-family: 'Inter', sans-serif;
    }
    
    .input-group-custom {
        display: flex;
        align-items: center;
        background-color: var(--sky-pale); 
        padding: 15px;
        border-radius: 8px;
    }

    .input-group-custom label {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--sky-label);
        margin-right: 15px;
    }

    #function-input {
        flex-grow: 1;
        padding: 10px;
        font-size: 1.2rem;
        border: 2px solid var(--sky-input-border);
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        transition: box-shadow 0.15s ease-in-out;
    }
    #function-input:focus {
        border-color: var(--sky-result-border) !important;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25) !important;
    }
    
    /* ðŸ“Š Result Display Styles */
    .result-box {
        margin-top: 25px;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid var(--sky-result-border);
        background-color: var(--sky-result-bg); 
        color: var(--sky-result-text);
    }
    
    .result-error {
        border-left: 5px solid #dc3545; /* Bootstrap danger red */
        background-color: #f8d7da;
        color: #842029;
    }

    .latex-output {
        font-size: 1.8rem;
        text-align: center;
        padding: 10px 0;
        min-height: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center fw-bolder mb-2 text-dark fs-2">Calculus: Derivative Solver</h1>
    <p class="text-secondary mb-4 text-center">Find the derivative $\mathbf{f'(x)}$ or $\frac{d}{dx} [\mathbf{f(x)}]$. Handles polynomials, $\mathbf{e^x}$, $\mathbf{\ln(x)}$, $\mathbf{\sin(x)}$, $\mathbf{\cos(x)}$.</p>

    <div class="solver-wrapper">
        <form id="derivative-form" class="d-grid gap-4">
            
            <div class="input-group-custom shadow-md">
                <label for="function-input">f(x):</label>
                <input type="text" id="function-input" required
                       placeholder="e.g., 2*x^3 - 4*x + 1"
                       class="form-control shadow-sm">
            </div>

            <button type="submit"
                    class="btn w-100 fw-bold py-3 text-white shadow-md"
                    style="background-color: var(--sky-button); border-color: var(--sky-button);">
                Calculate Derivative
            </button>
        </form>

        <div id="result-container" class="mt-5">
            <h2 class="fs-4 fw-semibold text-dark mb-3 border-bottom pb-2">Result: f'(x)</h2>
            <div id="solution-output" class="result-box d-none">
                <div class="latex-output" id="latex-result"></div>
                <p class="text-center small text-muted mt-2 mb-0">The result is rendered using high-quality mathematical formatting (MathJax).</p>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    /**
     * Attempts to find the derivative of a basic function string.
     * NOTE: This is a simplified differentiation engine and has limitations.
     * @param {string} funcStr - The input function string.
     * @returns {string} The derivative string in LaTeX format.
     */
    function calculateDerivative(funcStr) {
        // Clean and normalize the string for easier parsing
        let cleanedStr = funcStr.toLowerCase().replace(/\s+/g, '');
        cleanedStr = cleanedStr.replace(/-/g, '+-'); // Replace subtraction with '+-' for easier splitting
        
        // Split into terms (handling leading signs)
        const terms = cleanedStr.split('+').filter(term => term.length > 0);
        
        let derivativeTerms = [];

        for (let term of terms) {
            let sign = term.startsWith('-') ? -1 : 1;
            let currentTerm = term.replace('-', ''); // Remove sign for parsing
            let coeff = 1;
            let derivedTerm = '';

            // --- Case 1: Constant (e.g., 5, -2) ---
            if (!currentTerm.includes('x') && !currentTerm.includes('sin') && !currentTerm.includes('cos') && !currentTerm.includes('ln') && !currentTerm.includes('e')) {
                continue; // Derivative is 0
            }
            
            // --- Case 2: e^x ---
            if (currentTerm === 'e^x' || currentTerm === 'ex') {
                derivedTerm = 'e^x';
                // Check for coefficient, e.g., 2*e^x
                const coeffMatch = term.match(/(\d+|\d+\.\d+)\*?e[x\^]/);
                if (coeffMatch) {
                    coeff = parseFloat(coeffMatch[1]);
                }
            } 

            // --- Case 3: ln(x) ---
            else if (currentTerm.includes('ln(x)')) {
                derivedTerm = '\\frac{1}{x}';
                // Check for coefficient
                 const coeffMatch = term.match(/(\d+|\d+\.\d+)\*?ln\(x\)/);
                 if (coeffMatch) {
                    coeff = parseFloat(coeffMatch[1]);
                 }
            }

            // --- Case 4: Basic Trigonometry ---
            else if (currentTerm.includes('sin(x)')) {
                derivedTerm = '\\cos(x)';
                 const coeffMatch = term.match(/(\d+|\d+\.\d+)\*?sin\(x\)/);
                 if (coeffMatch) {
                    coeff = parseFloat(coeffMatch[1]);
                 }
            }
            else if (currentTerm.includes('cos(x)')) {
                derivedTerm = '-\\sin(x)';
                 const coeffMatch = term.match(/(\d+|\d+\.\d+)\*?cos\(x\)/);
                 if (coeffMatch) {
                    coeff = parseFloat(coeffMatch[1]);
                 }
            }

            // --- Case 5: Power Rule (c*x^n) ---
            else {
                // Simplified Power Rule parsing
                const parts = currentTerm.split('*');
                let xTerm = parts.find(p => p.includes('x')) || 'x'; // Default to 'x' if coeff is present but x is not explicit
                let cTerm = parts.find(p => !p.includes('x'));

                // Determine the base coefficient
                if (cTerm) {
                    coeff = parseFloat(cTerm);
                } else if (currentTerm.startsWith('x') || currentTerm.startsWith('-x')) {
                    coeff = 1; // e.g., x^2 or -x^2
                }

                let exponent = 1; // Default for x (x^1)
                
                if (xTerm.includes('^')) {
                    exponent = parseFloat(xTerm.split('^')[1]);
                } else if (xTerm === 'x' && cTerm) {
                    // This handles c*x (e.g., 5*x). derivative is just c.
                    derivedTerm = Math.abs(coeff).toFixed(4).replace(/\.?0+$/, "");
                    exponent = 1; // Reset exponent for calculation logic
                    xTerm = ''; // Mark as handled
                } else if (xTerm === 'x') {
                    // Handles just 'x'. derivative is 1.
                    derivedTerm = '1';
                    exponent = 1; // Reset exponent
                    xTerm = ''; // Mark as handled
                }

                // Apply Power Rule only if it's a true x^n term (not already derived to a constant)
                if (xTerm && exponent !== 0) {
                    // Apply Power Rule: d/dx(c*x^n) = c*n*x^(n-1)
                    let newCoeff = coeff * exponent;
                    let newExp = exponent - 1;

                    // Format the derived term
                    let coeffStr = Math.abs(newCoeff).toFixed(4).replace(/\.?0+$/, ""); 
                    
                    if (newExp === 0) {
                        derivedTerm = coeffStr; // Result is just the constant
                    } else if (newExp === 1) {
                        derivedTerm = `${coeffStr}x`;
                    } else {
                        derivedTerm = `${coeffStr}x^{${newExp}}`;
                    }
                } else if (!xTerm && !derivedTerm) {
                    // This is a constant term that was initially skipped
                    continue;
                }
            }
            
            // Reapply sign and clean up
            let finalCoeff = sign * coeff;
            
            if (derivedTerm !== '0') {
                if (finalCoeff < 0) {
                    derivedTerm = '-' + derivedTerm;
                } else if (derivativeTerms.length > 0) {
                    derivedTerm = '+' + derivedTerm;
                }
                derivativeTerms.push(derivedTerm);
            }
        }

        let result = derivativeTerms.join('');

        if (!result) {
            return '0';
        }
        
        // Final cleanup: remove leading '+' if present
        if (result.startsWith('+')) {
            result = result.substring(1);
        }
        
        return result;
    }


    document.getElementById('derivative-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const funcStr = document.getElementById('function-input').value.trim();
        const outputDiv = document.getElementById('solution-output');
        const resultDiv = document.getElementById('latex-result');

        outputDiv.classList.add('d-none');
        outputDiv.classList.remove('result-error');
        resultDiv.innerHTML = '';

        try {
            if (funcStr === '') {
                throw new Error("Function input cannot be empty.");
            }
            
            const derivedFuncStr = calculateDerivative(funcStr);
            
            // Use LaTeX for final output presentation
            const latexOutput = `$$\\frac{d}{dx} [${funcStr}] = ${derivedFuncStr}$$`; 
            
            resultDiv.innerHTML = latexOutput;
            displayResult(''); // Display success

        } catch (error) {
            // Display error content
            displayResult('result-error', `<p class="fw-bold">Error:</p><p>Could not parse or differentiate the function. Please ensure simple syntax (e.g., 3*x^2 + sin(x)).</p>`);
        }
    });

    /**
     * Updates the results display with appropriate styling and content, and triggers MathJax.
     */
    function displayResult(className) {
        const outputDiv = document.getElementById('solution-output');
        outputDiv.classList.remove('d-none', 'result-error');
        outputDiv.classList.add('result-box'); // Base class
        if (className) {
            outputDiv.classList.add(className);
        }
        outputDiv.classList.remove('d-none');
        
        // Trigger MathJax re-render
        if (window.MathJax) {
            window.MathJax.typesetPromise([outputDiv]);
        }
    }
    
    // REMOVED: window.onload function to prevent automatic calculation on page load.
</script>
{% endblock %}