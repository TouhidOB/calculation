{% extends "base.html" %}

{% block title %}Reverse Mortgage (HECM) Calculator{% endblock %}

{% block meta_description %}Estimate the maximum principal limit (loan amount) available from a reverse mortgage (HECM) based on home value, borrower age, and expected interest rate.{% endblock %}

{% block meta_keywords %}reverse mortgage calculator, HECM calculator, principal limit, borrower age, home equity conversion mortgage, senior finance{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<style>
    /* Custom Styling for an "Antique Gold/Bronze" Theme */
    .solver-wrapper {
        background: #fcf8f0; /* Very light gold/cream */
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-width: 950px; 
        margin: 0 auto;
        font-family: 'Inter', sans-serif;
    }
    
    .input-section {
        padding: 25px;
        border-radius: 10px;
        background-color: #fae8c6; /* Light Gold */
        border: 2px solid #b8860b; /* Goldenrod/Bronze accent */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
    }
    
    .input-box label {
        font-size: 1rem;
        font-weight: 600;
        color: #8b5e2d; /* Dark Bronze */
        display: block;
        margin-bottom: 5px;
    }

    .form-control-custom {
        padding: 12px;
        font-size: 1.1rem;
        border: 2px solid #ffd700; /* Gold */
        border-radius: 8px;
        font-weight: 700;
        color: #b8860b;
    }
    .form-control-custom:focus {
        border-color: #b8860b;
        box-shadow: 0 0 0 0.25rem rgba(184, 134, 11, 0.25);
    }

    .result-section {
        margin-top: 30px;
    }

    .summary-card {
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        background-color: #fffaf0; /* Ivory */
        border-left: 5px solid #b8860b; /* Bronze accent */
    }

    .result-error {
        border-left: 5px solid #ef4444; /* Red */
        background-color: #fee2e2;
        color: #991b1b;
        padding: 20px;
        border-radius: 8px;
    }
    
    /* Styles for Principal Limit display */
    .result-label {
        font-size: 1.2rem;
        font-weight: 600;
        color: #8b5e2d; /* Dark Bronze */
    }
    
    .principal-limit-value {
        font-size: 3.5rem;
        font-weight: 900;
        color: #b8860b; /* Goldenrod */
    }
    
    .text-bronze { color: #8b5e2d !important; }

</style>
{% endblock %}

{% block content %}
<div class="container p-4 p-md-5">
    <h1 class="h3 fw-bolder mb-2 text-dark text-center">ðŸ’° Reverse Mortgage (HECM) Calculator</h1>
    <p class="text-secondary mb-5 text-center">
        Estimate the maximum **Principal Limit** (loan amount) you can receive from a Home Equity Conversion Mortgage (HECM).
    </p>

    <div class="solver-wrapper">
        
        <form id="reverse-mortgage-form" class="row g-4 justify-content-center">
            
            <div class="col-lg-12">
                <div class="input-section">
                    <h4 class="h5 fw-bold text-center text-bronze p-2 rounded mb-4">HECM Eligibility & Value Inputs</h4>
                    
                    <div class="row">
                        <div class="col-md-4 input-box mb-4">
                            <label for="home-value">Home Appraised Value:</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="home-value" 
                                   value="450000" 
                                   min="100000"
                                   step="1000"
                                   required
                                   class="form-control form-control-custom">
                            </div>
                            <small class="text-muted">Or the HUD Max Claim Amount ($1,149,825 for 2024), whichever is lower.</small>
                        </div>
                        
                        <div class="col-md-4 input-box mb-4">
                            <label for="borrower-age">Youngest Borrower's Age:</label>
                            <div class="input-group">
                                <input type="number" id="borrower-age" 
                                   value="68" 
                                   min="62" 
                                   max="100"
                                   step="1"
                                   required 
                                   class="form-control form-control-custom">
                                <span class="input-group-text">Yrs</span>
                            </div>
                            <small class="text-muted">Must be 62 or older.</small>
                        </div>

                        <div class="col-md-4 input-box mb-4">
                            <label for="expected-rate">Expected Interest Rate (%):</label>
                            <div class="input-group">
                                <input type="number" id="expected-rate" 
                                   value="7.00" 
                                   min="0.1" 
                                   max="15"
                                   step="0.01"
                                   required 
                                   class="form-control form-control-custom">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Based on 10-year CMT plus margin.</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 input-box mb-4">
                            <label for="current-debt">Current Mortgage/Lien Balance:</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" id="current-debt" 
                                   value="100000" 
                                   min="0"
                                   step="1000"
                                   required
                                   class="form-control form-control-custom">
                            </div>
                            <small class="text-muted">The amount that must be paid off by the HECM.</small>
                        </div>
                        
                        <div class="col-md-6 input-box mb-4">
                            <label for="initial-mips">Initial MIP (Mortgage Insurance Premium):</label>
                            <div class="input-group">
                                <input type="number" id="initial-mips" 
                                   value="0.5" 
                                   min="0.01" 
                                   max="2.5"
                                   step="0.1"
                                   required 
                                   class="form-control form-control-custom">
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="text-muted">Typically 0.5% or 2.5% of the appraised value/limit.</small>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="col-12 mt-0">
                <button type="submit"
                    class="btn btn-primary w-100 py-3 fw-bold shadow-lg" style="background-color: #b8860b; border: none;">
                Calculate Maximum Principal Limit
            </button>
            </div>
        </form>

        <div id="result-container" class="result-section">
            <div id="summary-output" class="summary-card d-none mb-4"></div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script>
    /**
     * Formats a number as USD currency (no cents).
     */
    const currencyFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
    });

    /**
     * Formats a number as USD currency (with cents).
     */
    const currencyFormatterCents = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });

    /**
     * Updates the UI with the calculation result or error.
     */
    function displayResult(isError, contentHtml) {
        const summaryDiv = document.getElementById('summary-output');
        
        summaryDiv.classList.remove('d-none', 'result-error', 'summary-card');
        
        if (isError) {
            summaryDiv.classList.add('result-error');
            summaryDiv.classList.remove('summary-card');
            summaryDiv.innerHTML = contentHtml;
        } else {
            summaryDiv.classList.add('summary-card');
            summaryDiv.classList.remove('result-error');
            summaryDiv.innerHTML = contentHtml;
        }
    }

    /**
     * This function approximates the Principal Limit Factor (PLF) used in HECM loans.
     * PLF is based on the Expected Interest Rate (EIR) and the age of the youngest borrower.
     * Note: This is a SIMPLIFIED approximation, as actual HECM PLF tables are complex and set by HUD.
     * The true formula uses complex actuarial tables. We'll use a basic inverse relationship to simulate the key principle.
     */
    function approximatePrincipalLimitFactor(age, rate) {
        // Base PLF is higher for older borrowers and lower for higher rates.
        let baseFactor = 0.5; // Placeholder starting point for 62 years old
        
        // Age adjustment (Older = higher factor)
        const ageModifier = (age - 62) * 0.007; // 0.7% increase per year over 62
        
        // Rate adjustment (Higher rate = lower factor)
        const rateModifier = (rate - 5.0) * 0.04; // 4% decrease for every point over 5%
        
        // Combine (simplified)
        let PLF = baseFactor + ageModifier - rateModifier;
        
        // Clamp the result to realistic bounds (e.g., 40% to 70%)
        return Math.min(0.70, Math.max(0.40, PLF));
    }


    /**
     * Handles form submission and triggers the calculation.
     */
    function handleReverseMortgageCalc(e) {
        e.preventDefault();

        try {
            const homeValue = parseFloat(document.getElementById('home-value').value);
            const borrowerAge = parseInt(document.getElementById('borrower-age').value);
            const expectedRate = parseFloat(document.getElementById('expected-rate').value);
            const currentDebt = parseFloat(document.getElementById('current-debt').value);
            const initialMIPSPercent = parseFloat(document.getElementById('initial-mips').value);

            // 1. Validation
            const maxHUDValue = 1149825; // 2024 HUD Limit
            const maxClaimValue = Math.min(homeValue, maxHUDValue);

            if (borrowerAge < 62) {
                throw new Error("The youngest borrower must be at least 62 years old for a HECM.");
            }
            if (currentDebt >= maxClaimValue) {
                throw new Error("The current debt exceeds the maximum claim amount. You may not qualify.");
            }
            
            // 2. Calculate Principal Limit Factor (PLF)
            const PLF = approximatePrincipalLimitFactor(borrowerAge, expectedRate);
            
            // 3. Calculate Maximum Principal Limit (Total amount loan can accrue)
            const maxPrincipalLimit = maxClaimValue * PLF;
            
            // 4. Calculate Mortgage Insurance Premium (MIP)
            const initialMIPCost = maxPrincipalLimit * (initialMIPSPercent / 100);
            
            // 5. Calculate Net Proceeds (Amount available after paying debt and fees)
            const totalRequiredPayoff = currentDebt + initialMIPCost; // Simplified: includes debt and initial MIP
            const netAvailableProceeds = Math.max(0, maxPrincipalLimit - totalRequiredPayoff);


            // 6. Build Summary HTML
            const summaryHtml = `
                <h4 class="h5 fw-bold text-center text-bronze mb-4">HECM Principal Limit Estimate</h4>
                
                <div class="row text-center align-items-center mb-4">
                    
                    <div class="col-md-6 mb-3 border-end border-gold">
                        <p class="result-label">MAXIMUM PRINCIPAL LIMIT</p>
                        <p class="principal-limit-value mb-0">
                            ${currencyFormatter.format(maxPrincipalLimit)}
                        </p>
                        <small class="text-muted">This is the total amount of debt (including interest and fees) the loan can accrue.</small>
                    </div>

                    <div class="col-md-6 mb-3">
                        <p class="result-label">ESTIMATED NET AVAILABLE PROCEEDS</p>
                        <p class="principal-limit-value mb-0 text-success" style="font-size: 2.5rem;">
                            ${currencyFormatter.format(netAvailableProceeds)}
                        </p>
                        <small class="text-muted">The cash amount available to you after paying off the current debt and initial MIP.</small>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h5 class="h6 fw-bold text-center text-bronze mb-3">Loan Factor Breakdown</h5>
                
                <div class="row justify-content-center">
                    <div class="col-md-9">
                        <table class="table table-sm table-striped">
                            <tbody>
                                <tr>
                                    <td class="fw-bold">Maximum Claim Value</td>
                                    <td class="text-end">${currencyFormatter.format(maxClaimValue)}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Approximate Principal Limit Factor (PLF)</td>
                                    <td class="text-end">${(PLF * 100).toFixed(2)}%</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Initial Mortgage Insurance Premium (${initialMIPSPercent.toFixed(1)}%)</td>
                                    <td class="text-end text-danger">(${currencyFormatter.format(initialMIPCost)})</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Current Debt Payoff Required</td>
                                    <td class="text-end text-danger">(${currencyFormatter.format(currentDebt)})</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="text-center mt-3 p-3 bg-light rounded">
                    <p class="mb-0 text-muted small">**Disclaimer:** This is an estimate. Actual Principal Limit Factors (PLFs) are set by HUD and depend precisely on the current Expected Interest Rate.</p>
                </div>
            `;
            
            displayResult(false, summaryHtml);
            
        } catch (error) {
            console.error(error);
             const htmlContent = `<p class="fw-bold text-center">Calculation Error</p><p class="text-center">${error.message}</p>`;
            displayResult(true, htmlContent);
        }
    }

    // Attach handler to the form
    document.getElementById('reverse-mortgage-form').addEventListener('submit', handleReverseMortgageCalc);
    
    // Initial calculation for default value on load
    window.onload = function() {
        document.getElementById('reverse-mortgage-form').dispatchEvent(new Event('submit'));
    };
</script>
{% endblock %}