{% extends "base.html" %}

{% block title %}Internal Rate of Return (IRR) Calculator{% endblock %}

{% block meta_description %}Calculate the Internal Rate of Return (IRR) for a real estate investment based on initial outlay, annual cash flows, and final sale proceeds.{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    :root {
        --irr-teal: #0f766e;
        --irr-light: #f0fdfa;
        --irr-border: #5eead4;
    }

    body {
        background-color: #f8fafc;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .calc-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--irr-border);
        overflow: hidden;
    }

    .input-sidebar {
        background-color: var(--irr-light);
        border-right: 1px solid var(--irr-border);
    }

    .form-label {
        font-weight: 700;
        color: var(--irr-teal);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metric-hero {
        background-color: white;
        border: 2px solid var(--irr-teal);
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
    }

    .value-hero {
        font-size: 3.5rem;
        font-weight: 900;
        color: var(--irr-teal);
        line-height: 1;
    }

    .placeholder-state {
        padding: 5rem 2rem;
        text-align: center;
        color: #94a3b8;
    }

    .cashflow-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
    }

    .year-input-card {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 10px;
        border-radius: 8px;
    }

    .table-schedule {
        font-size: 0.9rem;
    }

    @media print {
        .input-sidebar, .btn-no-print { display: none !important; }
        .calc-card { border: none; box-shadow: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark"><i class="bi bi-percent text-teal me-2"></i>IRR Performance Modeler</h1>
        <p class="text-muted mx-auto" style="max-width: 700px;">
            The Internal Rate of Return (IRR) is the gold standard for measuring real estate performance, accounting for both the <strong>amount</strong> and the <strong>timing</strong> of cash flows.
        </p>
    </div>

    <div class="calc-card mx-auto" style="max-width: 1200px;">
        <div class="row g-0">
            <div class="col-lg-4 input-sidebar p-4 p-md-5">
                <form id="irr-form">
                    <h6 class="fw-bold text-dark mb-4 text-uppercase small">Investment Foundation</h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Initial Outlay (Year 0)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" id="initial-investment" class="form-control" placeholder="e.g. 100000" required>
                        </div>
                        <small class="x-small text-muted">Down payment + Closing + Rehab</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Hold Period (Years)</label>
                        <select id="holding-period" class="form-select">
                            <option value="3">3 Years</option>
                            <option value="5" selected>5 Years</option>
                            <option value="7">7 Years</option>
                            <option value="10">10 Years</option>
                        </select>
                    </div>

                    <h6 class="fw-bold text-dark mb-3 text-uppercase small pt-3 border-top">Exit Strategy</h6>
                    <div class="mb-4">
                        <label class="form-label">Net Sale Proceeds</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" id="sale-proceeds" class="form-control" placeholder="e.g. 150000" required>
                        </div>
                        <small class="x-small text-muted">Net cash after mortgage payoff</small>
                    </div>

                    <button type="submit" class="btn btn-teal w-100 py-3 fw-bold shadow-sm" style="background-color: var(--irr-teal); color: white; border: none;">
                        Calculate Performance <i class="bi bi-lightning-fill ms-1"></i>
                    </button>
                </form>
            </div>

            <div class="col-lg-8 p-4 p-md-5 bg-white">
                
                <div id="placeholder-ui" class="placeholder-state">
                    <i class="bi bi-clock-history display-1 mb-3 opacity-25" style="color: var(--irr-teal);"></i>
                    <h4 class="fw-bold text-dark">Awaiting Hold Period Data</h4>
                    <p>Input your projected annual operating cash flows below to solve for the Internal Rate of Return.</p>
                    
                    <div class="mt-4 text-start mx-auto" style="max-width: 500px;">
                        <label class="form-label d-block text-center">Annual Operating Cash Flows</label>
                        <div id="dynamic-cashflow-inputs" class="cashflow-grid mt-2">
                            </div>
                    </div>
                </div>

                <div id="results-ui" class="w-100 d-none">
                    <div class="metric-hero mb-5">
                        <span class="form-label text-muted d-block mb-2">Annualized Internal Rate of Return</span>
                        <div class="value-hero" id="irr-display">0.00%</div>
                    </div>

                    

                    <h6 class="fw-bold text-dark mb-3 text-uppercase small border-bottom pb-2 mt-5">Cash Flow Schedule</h6>
                    <table class="table table-sm table-schedule">
                        <thead class="table-light">
                            <tr>
                                <th>Period</th>
                                <th>Event</th>
                                <th class="text-end">Cash Flow</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            </tbody>
                    </table>

                    <div class="p-3 rounded-4 bg-light border shadow-sm mt-4">
                        <h6 class="fw-bold text-dark mb-1 small"><i class="bi bi-info-circle-fill me-2 text-teal"></i>What is IRR?</h6>
                        <p class="x-small text-muted mb-0">
                            IRR is the discount rate that makes the Net Present Value (NPV) of all cash flows equal to zero. It represents the "break-even" interest rate of the investment.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('irr-form');
    const resultsUi = document.getElementById('results-ui');
    const placeholderUi = document.getElementById('placeholder-ui');
    const cfContainer = document.getElementById('dynamic-cashflow-inputs');
    const periodSelect = document.getElementById('holding-period');

    const currency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });

    function updateCFInputs() {
        const years = parseInt(periodSelect.value);
        cfContainer.innerHTML = '';
        for (let i = 1; i <= years; i++) {
            cfContainer.innerHTML += `
                <div class="year-input-card shadow-sm">
                    <label class="form-label mb-1" style="font-size:0.6rem">Year ${i}</label>
                    <input type="number" class="form-control form-control-sm annual-cf" data-year="${i}" placeholder="$0">
                </div>
            `;
        }
    }

    function calculateIRR(cashFlows) {
        let low = -1.0, high = 10.0;
        for (let i = 0; i < 1000; i++) {
            let mid = (low + high) / 2;
            let npv = 0;
            for (let j = 0; j < cashFlows.length; j++) {
                npv += cashFlows[j] / Math.pow(1 + mid, j);
            }
            if (npv > 0) low = mid;
            else high = mid;
        }
        return low;
    }

    periodSelect.addEventListener('change', updateCFInputs);
    updateCFInputs(); // Initial call

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const initial = -Math.abs(parseFloat(document.getElementById('initial-investment').value));
        const sale = parseFloat(document.getElementById('sale-proceeds').value);
        const annualInputs = document.querySelectorAll('.annual-cf');
        
        let flows = [initial];
        let tableHtml = `<tr><td>Year 0</td><td>Initial Investment</td><td class="text-end text-danger">${currency.format(initial)}</td></tr>`;
        
        annualInputs.forEach((input, index) => {
            let val = parseFloat(input.value || 0);
            let isLast = index === annualInputs.length - 1;
            let totalYearFlow = isLast ? val + sale : val;
            flows.push(totalYearFlow);
            
            tableHtml += `
                <tr>
                    <td>Year ${index + 1}</td>
                    <td>${isLast ? 'Op. Cash Flow + Exit' : 'Operating Cash Flow'}</td>
                    <td class="text-end ${totalYearFlow >= 0 ? 'text-success' : 'text-danger'}">${currency.format(totalYearFlow)}</td>
                </tr>
            `;
        });

        const irr = calculateIRR(flows);
        
        placeholderUi.classList.add('d-none');
        resultsUi.classList.remove('d-none');
        document.getElementById('irr-display').textContent = (irr * 100).toFixed(2) + "%";
        document.getElementById('schedule-body').innerHTML = tableHtml;
    });
</script>
{% endblock %}